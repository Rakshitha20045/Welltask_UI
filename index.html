<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WellTask</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { gray: { 750: '#2d3748' } } } }
    }
  </script>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-200">
<div id="app"></div>

<script>
  // ========== CONFIGURATION ==========
  const ZOHO_API_URL = "/api/proxy"; // Pointing to Vercel Proxy
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  let currentUser = null;
  if (token) {
    try {
      const decoded = atob(token);
      const parts = decoded.split("::");
      if (parts.length === 2) {
        currentUser = {
          id: parts[1],
          name: parts[0].split('@')[0],
          email: parts[0]
        };
      }
    } catch (e) { console.error("Auth Failed", e); }
  }

  const uid = () => Date.now().toString() + Math.floor(Math.random() * 1000);

  // ========== STATE ==========
  const initialState = {
    darkMode: false,
    currentUser,
    showLogin: !currentUser,
    workspaces: [],
    projects: [],
    groups: [],
    tasks: [],
    // Defaults to ensure UI doesn't break before load
    selectedWorkspace: null,
    selectedProject: null,
    ui: {
      showNewTask: null,
      newTask: { name: '', priority: 'Medium' },
      editingTaskId: null
    }
  };

  let state = { ...initialState };

  // ========== API ==========
  const api = {
    load: async () => {
      if (!state.currentUser) return;
      
      try {
        console.log("ðŸ”„ Loading data...");
        // GET request sends params to proxy
        const res = await fetch(`${ZOHO_API_URL}?request_method=GET&user_email=${state.currentUser.email}`);
        const json = await res.json();
        
        console.log("âœ… Load Response:", json);

        if (json.status === 'success' && json.data && Object.keys(json.data).length > 0) {
          // Restore State
          state.workspaces = json.data.workspaces || [];
          state.projects = json.data.projects || [];
          state.groups = json.data.groups || [];
          state.tasks = json.data.tasks || [];
          
          // Set default selection if data exists
          if(state.workspaces.length > 0) state.selectedWorkspace = state.workspaces[0].id;
          if(state.projects.length > 0) state.selectedProject = state.projects[0].id;
        } else {
          console.log("ðŸ“¦ New user, initializing defaults...");
          api.initDefaults();
        }
        renderApp();
      } catch (e) {
        console.error("âŒ Load error:", e);
      }
    },

    save: async () => {
      if (!state.currentUser) return;

      try {
        // Prepare the Full State Blob
        const payload = {
          workspaces: state.workspaces,
          projects: state.projects,
          groups: state.groups,
          tasks: state.tasks
        };

        console.log("ðŸ’¾ Saving...");

        // SEND VIA POST BODY (Important for large data)
        const res = await fetch(ZOHO_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                request_method: 'POST',
                user_email: state.currentUser.email,
                data_payload: JSON.stringify(payload) // Convert whole object to string for DB
            })
        });

        const json = await res.json();
        console.log("âœ… Save result:", json);

      } catch (e) {
        console.error("âŒ Save error:", e);
      }
    },

    initDefaults: () => {
      const wsId = uid();
      const pId = uid();
      const g1 = uid();

      state.workspaces = [{ id: wsId, name: 'My Workspace' }];
      state.projects = [{ id: pId, name: 'Demo Project', color: 'bg-purple-500', workspaceId: wsId }];
      state.groups = [{ id: g1, name: 'To Do', projectId: pId }];
      state.tasks = [{ id: uid(), name: 'First Task', groupId: g1, priority: 'High' }];
      
      state.selectedWorkspace = wsId;
      state.selectedProject = pId;
      api.save();
    }
  };

  // ========== HELPER ACTIONS (Simplified for brevity) ==========
  // You can paste your previous large Actions object here. 
  // Make sure every action calls api.save() at the end.
  const actions = {
      addTask: (groupId, name) => {
          state.tasks.push({ id: uid(), name, groupId, priority: 'Medium' });
          renderApp();
          api.save(); // Auto-save
      },
      // ... Include your other actions (delete, edit, etc) ...
  };
  window.actions = actions;

  // ========== RENDER ==========
  function renderApp() {
      const app = document.getElementById('app');
      if(state.showLogin) {
          app.innerHTML = `<div class="flex h-screen items-center justify-center"><h1>Please Login via Zoho Cliq</h1></div>`;
          return;
      }
      
      // Debug View to prove data is loaded
      app.innerHTML = `
        <div class="p-10">
            <h1 class="text-2xl font-bold mb-4">WellTask Debugger</h1>
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-white p-4 shadow rounded">
                    <h2 class="font-bold">Workspaces (${state.workspaces.length})</h2>
                    <pre class="text-xs mt-2">${JSON.stringify(state.workspaces, null, 2)}</pre>
                </div>
                <div class="bg-white p-4 shadow rounded">
                     <h2 class="font-bold">Projects (${state.projects.length})</h2>
                     <pre class="text-xs mt-2">${JSON.stringify(state.projects, null, 2)}</pre>
                </div>
                 <div class="bg-white p-4 shadow rounded">
                     <h2 class="font-bold">Tasks (${state.tasks.length})</h2>
                     <pre class="text-xs mt-2">${JSON.stringify(state.tasks, null, 2)}</pre>
                </div>
            </div>
            <button onclick="api.initDefaults()" class="mt-5 bg-blue-500 text-white px-4 py-2 rounded">Reset & Save Default Data</button>
        </div>
      `;
  }

  // Start
  if (state.currentUser) api.load();
  else renderApp();
</script>
</body>
</html>
