<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WellTask</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            gray: { 750: "#2d3748" }
          }
        }
      }
    };
  </script>

  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 transition-colors duration-200">
  <div id="app"></div>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const ZOHO_API_URL = "/api/proxy";

    // Read URL params from widget URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");
    const boardidFromUrl = urlParams.get("boardid"); // channel-based board id

    let currentUser = null;
    let boardid = boardidFromUrl || null;

    // Decode token: email::user_id::boardid (if present)
    if (token) {
      try {
        const decoded = atob(token);
        const parts = decoded.split("::");
        if (parts.length >= 2) {
          currentUser = {
            id: parts[1],
            name: parts[0].split("@")[0],
            email: parts[0]
          };
        }
        // If token also carries boardid (3rd part), prefer that
        if (!boardid && parts.length >= 3) {
          boardid = parts[2];
        }
      } catch (e) {
        console.error("Auth Failed", e);
      }
    }

    const uid = () =>
      Date.now().toString() + Math.floor(Math.random() * 1000);

    // Use boardid for shared board; fallback to user email for personal
    function getStorageKey() {
      if (boardid) {
        return `welltask_state_${boardid}`;
      }
      return currentUser ? `welltask_state_${currentUser.email}` : null;
    }

    function priorityClass(priority) {
      switch (priority) {
        case "Critical":
          return "bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300";
        case "High":
          return "bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-300";
        case "Medium":
          return "bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-200";
        case "Low":
          return "bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300";
        default:
          return "bg-gray-100 text-gray-800 dark:bg-gray-500/20 dark:text-gray-200";
      }
    }

    // ==========================
    // STATE
    // ==========================
    const initialState = {
      darkMode: false,
      currentUser,
      // show login only if we have neither user nor boardid
      showLogin: !currentUser && !boardid,
      isLoading: false,
      saveStatus: "saved",
      currentView: "list", // "list" | "kanban"

      workspaces: [],
      selectedWorkspace: null,
      projects: [],
      selectedProject: null,
      groups: [],
      tasks: [],

      ui: {
        showNewTask: null,
        newTask: {
          name: "",
          assignee: null,
          priority: "Medium",
          status: "Not Started",
          dueDate: "",
          customFields: {}
        },
        columnsGroupId: null,
        editingWorkspaceId: null,
        editingWorkspaceName: "",
        editingProjectId: null,
        editingProjectName: "",
        editingTaskId: null,
        editingGroupId: null,
        editingGroupName: ""
      }
    };

    let state = { ...initialState };

    // ==========================
    // API + LOCAL STORAGE
    // ==========================
    const api = {
      saveTimer: null,

      load: async () => {
        // If we have neither boardid nor user, we can't load anything
        if (!boardid && !state.currentUser) {
          state.showLogin = true;
          renderApp();
          return;
        }

        state.isLoading = true;
        renderApp();

        try {
          const key = getStorageKey();
          // 1) Try localStorage first
          if (key) {
            const stored = localStorage.getItem(key);
            if (stored) {
              console.log("ðŸ“‚ Loaded from localStorage");
              try {
                const parsed = JSON.parse(stored);
                if (parsed && typeof parsed === "object") {
                  state.workspaces = parsed.workspaces || [];
                  state.projects = parsed.projects || [];
                  state.groups = parsed.groups || [];
                  state.tasks = parsed.tasks || [];
                  state.currentView = parsed.currentView || "list";
                  state.darkMode = !!parsed.darkMode;

                  if (state.workspaces.length > 0) {
                    state.selectedWorkspace = state.workspaces[0].id;
                  }
                  if (state.projects.length > 0) {
                    const proj = state.projects.find(
                      p => p.workspaceId === state.selectedWorkspace
                    );
                    state.selectedProject =
                      (proj && proj.id) || state.projects[0].id;
                  }

                  state.isLoading = false;
                  renderApp();
                  return;
                }
              } catch (e) {
                console.warn("localStorage parse error:", e);
              }
            }
          }

          // 2) If no local state (or forced refresh), try backend (shared board)
          try {
            console.log("ðŸŒ Loading from backend using boardid:", boardid);
            const res = await fetch(ZOHO_API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "load",
                boardid: boardid || (state.currentUser ? state.currentUser.id : "")
              })
            });

            const text = await res.text();
            console.log("ðŸ“¥ Raw load response from proxy:", text);

            let respJson = null;
            try {
              respJson = JSON.parse(text);
            } catch (e) {
              console.warn("Backend load JSON parse error:", e);
            }

            if (
              respJson &&
              respJson.status === "success" &&
              respJson.data &&
              typeof respJson.data === "object"
            ) {
              const parsed = respJson.data;
              console.log("âœ… Backend returned saved state:", parsed);

              state.workspaces = parsed.workspaces || [];
              state.projects = parsed.projects || [];
              state.groups = parsed.groups || [];
              state.tasks = parsed.tasks || [];
              state.currentView = parsed.currentView || "list";
              state.darkMode = !!parsed.darkMode;

              if (state.workspaces.length > 0) {
                state.selectedWorkspace = state.workspaces[0].id;
              }
              if (state.projects.length > 0) {
                const proj = state.projects.find(
                  p => p.workspaceId === state.selectedWorkspace
                );
                state.selectedProject =
                  (proj && proj.id) || state.projects[0].id;
              }

              // Cache backend data into localStorage for this board
              const key2 = getStorageKey();
              if (key2) {
                try {
                  localStorage.setItem(
                    key2,
                    JSON.stringify({
                      darkMode: state.darkMode,
                      currentView: state.currentView,
                      workspaces: state.workspaces,
                      projects: state.projects,
                      groups: state.groups,
                      tasks: state.tasks
                    })
                  );
                } catch (e) {
                  console.warn("localStorage save failed:", e);
                }
              }

              state.isLoading = false;
              renderApp();
              return;
            } else {
              console.log("â„¹ï¸ No backend state found, using defaults.");
              api.initDefaults();
            }
          } catch (e) {
            console.warn("Backend load failed, using defaults:", e);
            api.initDefaults();
          }
        } catch (e) {
          console.error("ðŸ’¥ Load exception:", e);
          api.initDefaults();
        } finally {
          state.isLoading = false;
          renderApp();
        }
      },

      initDefaults: () => {
        const wsId = uid();
        const pId = uid();
        const g1 = uid(), g2 = uid(), g3 = uid();

        const defaultColumns = [
          { id: "task", name: "Task", isDefault: true },
          { id: "assignee", name: "Assignee", isDefault: true },
          { id: "priority", name: "Priority", isDefault: true },
          { id: "status", name: "Status", isDefault: true },
          { id: "duedate", name: "Due Date", isDefault: true }
        ];

        state.workspaces = [{ id: wsId, name: "My Workspace" }];
        state.projects = [
          {
            id: pId,
            name: "Marketing Campaign",
            color: "bg-purple-500",
            workspaceId: wsId
          }
        ];
        state.groups = [
          {
            id: g1,
            name: "To Do",
            projectId: pId,
            collapsed: false,
            columns: JSON.parse(JSON.stringify(defaultColumns))
          },
          {
            id: g2,
            name: "In Progress",
            projectId: pId,
            collapsed: false,
            columns: JSON.parse(JSON.stringify(defaultColumns))
          },
          {
            id: g3,
            name: "Done",
            projectId: pId,
            collapsed: false,
            columns: JSON.parse(JSON.stringify(defaultColumns))
          }
        ];
        state.tasks = [];
        state.selectedWorkspace = wsId;
        state.selectedProject = pId;
        state.currentView = "list";

        api.triggerSave();
      },

      triggerSave: () => {
        if (api.saveTimer) clearTimeout(api.saveTimer);
        state.saveStatus = "pending";
        renderStatusIndicator();
        api.saveTimer = setTimeout(api.performSave, 1500);
      },

      performSave: async () => {
        // Must have a boardid (channel or user-based) to save
        if (!boardid && !state.currentUser) return;

        try {
          state.saveStatus = "saving";
          renderStatusIndicator();

          const payload = {
            darkMode: state.darkMode,
            currentView: state.currentView,
            workspaces: state.workspaces,
            projects: state.projects,
            groups: state.groups,
            tasks: state.tasks
          };

          console.log("ðŸ’¾ Saving payload:", payload);

          const key = getStorageKey();
          if (key) {
            try {
              localStorage.setItem(key, JSON.stringify(payload));
            } catch (e) {
              console.warn("localStorage save failed:", e);
            }
          }

          const res = await fetch(ZOHO_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "save",
              boardid: boardid || (state.currentUser ? state.currentUser.id : ""),
              // âœ… FIX: Send payload as object, not double-stringified string
              data_payload: payload 
            })
          });

          const text = await res.text();
          console.log("ðŸ“¥ Raw save response from proxy:", text);

          if (res.ok) {
            state.saveStatus = "saved";
          } else {
            console.error("âŒ Save HTTP error:", res.status);
            state.saveStatus = "error";
          }
        } catch (e) {
          console.error("ðŸ’¥ Save exception:", e);
          state.saveStatus = "error";
        } finally {
          renderStatusIndicator();
        }
      }
    };

    // ==========================
    // ACTIONS
    // ==========================
    const actions = {
      toggleTheme: () => {
        state.darkMode = !state.darkMode;
        renderApp();
        api.triggerSave();
      },

      setView: (view) => {
        state.currentView = view;
        renderApp();
        api.triggerSave();
      },

      // Workspaces
      selectWorkspace: (id) => {
        state.selectedWorkspace = id;
        const proj = state.projects.find(p => p.workspaceId === id);
        state.selectedProject = proj ? proj.id : null;
        renderApp();
      },

      addWorkspace: () => {
        const id = uid();
        const ws = { id, name: "New Workspace" };
        state.workspaces.push(ws);
        state.selectedWorkspace = id;
        renderApp();
        api.triggerSave();
      },

      startEditWorkspace: (id) => {
        const ws = state.workspaces.find(w => w.id === id);
        if (!ws) return;
        state.ui.editingWorkspaceId = id;
        state.ui.editingWorkspaceName = ws.name;
        renderApp();
      },

      saveWorkspaceName: (id) => {
        const input = document.getElementById(`ws-name-input-${id}`);
        const ws = state.workspaces.find(w => w.id === id);
        if (ws && input) {
          const val = input.value.trim();
          if (val) ws.name = val;
          api.triggerSave();
        }
        state.ui.editingWorkspaceId = null;
        state.ui.editingWorkspaceName = "";
        renderApp();
      },

      deleteWorkspace: (id) => {
        if (state.workspaces.length <= 1) {
          alert("Cannot delete the last workspace.");
          return;
        }
        state.workspaces = state.workspaces.filter(w => w.id !== id);
        if (state.selectedWorkspace === id) {
          state.selectedWorkspace = state.workspaces[0].id;
        }
        const toRemoveProjects = state.projects
          .filter(p => p.workspaceId === id)
          .map(p => p.id);
        state.projects = state.projects.filter(p => p.workspaceId !== id);
        state.groups = state.groups.filter(g => !toRemoveProjects.includes(g.projectId));
        state.tasks = state.tasks.filter(t => !toRemoveProjects.includes(t.projectId));

        renderApp();
        api.triggerSave();
      },

      // Projects
      addProject: () => {
        if (!state.selectedWorkspace) return;
        const id = uid();
        const proj = {
          id,
          name: "New Project",
          color: "bg-green-500",
          workspaceId: state.selectedWorkspace
        };
        state.projects.push(proj);
        state.selectedProject = id;

        const defaultColumns = [
          { id: "task", name: "Task", isDefault: true },
          { id: "assignee", name: "Assignee", isDefault: true },
          { id: "priority", name: "Priority", isDefault: true },
          { id: "status", name: "Status", isDefault: true },
          { id: "duedate", name: "Due Date", isDefault: true }
        ];

        const g1 = uid(), g2 = uid(), g3 = uid();
        state.groups.push(
          { id: g1, name: "To Do", projectId: id, collapsed: false, columns: JSON.parse(JSON.stringify(defaultColumns)) },
          { id: g2, name: "In Progress", projectId: id, collapsed: false, columns: JSON.parse(JSON.stringify(defaultColumns)) },
          { id: g3, name: "Done", projectId: id, collapsed: false, columns: JSON.parse(JSON.stringify(defaultColumns)) }
        );

        renderApp();
        api.triggerSave();
      },

      selectProject: (id) => {
        state.selectedProject = id;
        renderApp();
      },

      startEditProject: (id) => {
        const p = state.projects.find(pr => pr.id === id);
        if (!p) return;
        state.ui.editingProjectId = id;
        state.ui.editingProjectName = p.name;
        renderApp();
      },

      saveProjectName: (id) => {
        const input = document.getElementById(`proj-name-input-${id}`);
        const p = state.projects.find(pr => pr.id === id);
        if (p && input) {
          const val = input.value.trim();
          if (val) p.name = val;
          api.triggerSave();
        }
        state.ui.editingProjectId = null;
        state.ui.editingProjectName = "";
        renderApp();
      },

      deleteProject: (id) => {
        if (!confirm("Delete project?")) return;
        state.projects = state.projects.filter(p => p.id !== id);
        state.groups = state.groups.filter(g => g.projectId !== id);
        state.tasks = state.tasks.filter(t => t.projectId !== id);

        const nextP = state.projects.find(
          p => p.workspaceId === state.selectedWorkspace
        );
        state.selectedProject = nextP ? nextP.id : (state.projects[0]?.id || null);

        renderApp();
        api.triggerSave();
      },

      // Groups
      toggleGroupCollapse: (id) => {
        const g = state.groups.find(gr => gr.id === id);
        if (!g) return;
        g.collapsed = !g.collapsed;
        renderApp();
        api.triggerSave();
      },

      addGroup: () => {
        if (!state.selectedProject) return;
        const baseGroup =
          state.groups.find(g => g.projectId === state.selectedProject) ||
          state.groups[0];

        const id = uid();
        const newGroup = {
          id,
          name: "New Group",
          projectId: state.selectedProject,
          collapsed: false,
          columns: baseGroup
            ? JSON.parse(JSON.stringify(baseGroup.columns))
            : [
              { id: "task", name: "Task", isDefault: true },
              { id: "assignee", name: "Assignee", isDefault: true },
              { id: "priority", name: "Priority", isDefault: true },
              { id: "status", name: "Status", isDefault: true },
              { id: "duedate", name: "Due Date", isDefault: true }
            ]
        };
        state.groups.push(newGroup);
        renderApp();
        api.triggerSave();
      },

      startEditGroup: (id) => {
        const g = state.groups.find(gr => gr.id === id);
        if (!g) return;
        state.ui.editingGroupId = id;
        state.ui.editingGroupName = g.name;
        renderApp();
      },

      saveGroupName: (id) => {
        const input = document.getElementById(`group-name-input-${id}`);
        const g = state.groups.find(gr => gr.id === id);
        if (g && input) {
          const val = input.value.trim();
          if (val) g.name = val;
          api.triggerSave();
        }
        state.ui.editingGroupId = null;
        state.ui.editingGroupName = "";
        renderApp();
      },

      deleteGroup: (id) => {
        if (!confirm("Delete group?")) return;
        state.groups = state.groups.filter(g => g.id !== id);
        state.tasks = state.tasks.filter(t => t.groupId !== id);
        renderApp();
        api.triggerSave();
      },

      toggleColumnsPanel: (groupId) => {
        state.ui.columnsGroupId =
          state.ui.columnsGroupId === groupId ? null : groupId;
        renderApp();
      },

      addColumn: (groupId) => {
        const g = state.groups.find(gr => gr.id === groupId);
        if (!g) return;
        g.columns.push({
          id: "col_" + uid(),
          name: "New Column",
          isDefault: false
        });
        renderApp();
        api.triggerSave();
      },

      renameColumn: (groupId, colId) => {
        const input = document.getElementById(`col-name-${groupId}-${colId}`);
        if (!input) return;
        const g = state.groups.find(gr => gr.id === groupId);
        if (!g) return;
        const col = g.columns.find(c => c.id === colId);
        if (col) {
          col.name = input.value.trim() || col.name;
          renderApp();
          api.triggerSave();
        }
      },

      deleteColumn: (groupId, colId) => {
        const g = state.groups.find(gr => gr.id === groupId);
        if (!g) return;
        g.columns = g.columns.filter(c => c.id !== colId);
        state.tasks.forEach(t => {
          if (t.customFields && t.customFields[colId] !== undefined) {
            delete t.customFields[colId];
          }
        });
        renderApp();
        api.triggerSave();
      },

      // Tasks
      setShowNewTask: (groupId) => {
        state.ui.showNewTask = groupId;
        state.ui.newTask = {
          name: "",
          assignee: null,
          priority: "Medium",
          status:
            groupId === 2
              ? "In Progress"
              : groupId === 3
                ? "Done"
                : "Not Started",
          dueDate: "",
          customFields: {}
        };
        renderApp();
      },

      submitTask: (groupId) => {
        const input = document.getElementById(`new-task-name-${groupId}`);
        if (!input || !input.value.trim()) return;
        const id = uid();
        const t = {
          id,
          name: input.value.trim(),
          groupId,
          projectId: state.selectedProject,
          priority: state.ui.newTask.priority || "Medium",
          status: state.ui.newTask.status || "Not Started",
          assignee: null,
          dueDate: "",
          customFields: {}
        };
        state.tasks.push(t);
        state.ui.showNewTask = null;
        renderApp();
        api.triggerSave();
      },

      deleteTask: (id) => {
        state.tasks = state.tasks.filter(t => t.id !== id);
        renderApp();
        api.triggerSave();
      },

      startEditTaskName: (id) => {
        state.ui.editingTaskId = id;
        renderApp();
        const input = document.getElementById(`task-name-input-${id}`);
        if (input) input.focus();
      },

      saveTaskName: (id) => {
        const input = document.getElementById(`task-name-input-${id}`);
        const t = state.tasks.find(task => task.id === id);
        if (t && input) {
          const val = input.value.trim();
          if (val) t.name = val;
          api.triggerSave();
        }
        state.ui.editingTaskId = null;
        renderApp();
      },

      updateTaskField: (id, field, value, extra) => {
        const t = state.tasks.find(task => task.id === id);
        if (!t) return;

        if (field === "assignee") {
          t.assignee = value ? { name: value } : null;
        } else if (field === "custom") {
          const colId = extra;
          if (!t.customFields) t.customFields = {};
          t.customFields[colId] = value;
        } else {
          t[field] = value;
        }
        renderApp();
        api.triggerSave();
      },

      moveTaskToGroup: (id, groupId) => {
        const t = state.tasks.find(task => task.id === id);
        if (!t) return;
        t.groupId = groupId;
        if (groupId === 1) t.status = "Not Started";
        if (groupId === 2) t.status = "In Progress";
        if (groupId === 3) t.status = "Done";
        renderApp();
        api.triggerSave();
      }
    };

    window.actions = actions;

    // ==========================
    // RENDER HELPERS
    // ==========================
    function renderStatusIndicator() {
      const el = document.getElementById("save-status");
      if (!el) return;
      let html = "";
      if (state.saveStatus === "saving")
        html =
          '<span class="text-blue-500 flex items-center gap-1"><i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Saving...</span>';
      else if (state.saveStatus === "pending")
        html =
          '<span class="text-yellow-500 flex items-center gap-1">Changes pending...</span>';
      else if (state.saveStatus === "error")
        html =
          '<span class="text-red-500 flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> Save Failed</span>';
      else
        html =
          '<span class="text-green-500 flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> Saved</span>';
      el.innerHTML = html;
      lucide.createIcons();
    }

    function renderSidebar() {
      const {
        workspaces,
        selectedWorkspace,
        projects,
        selectedProject,
        ui,
        darkMode
      } = state;

      const cardBg = darkMode ? "bg-gray-900" : "bg-white";
      const textColor = darkMode ? "text-gray-100" : "text-gray-800";
      const borderColor = darkMode ? "border-gray-800" : "border-gray-200";
      const hoverBg = darkMode ? "hover:bg-gray-800" : "hover:bg-gray-100";

      const wsHtml = workspaces
        .map(ws => {
          const isActive = ws.id === selectedWorkspace;
          const rowClasses = isActive
            ? "bg-blue-600 text-white hover:bg-blue-700"
            : `${hoverBg} ${textColor}`;
          const isEditing = ui.editingWorkspaceId === ws.id;

          const nameCell = isEditing
            ? `
              <div class="flex-1">
                <input id="ws-name-input-${ws.id}" value="${ui.editingWorkspaceName}"
                       class="w-full bg-transparent text-sm outline-none border-b border-blue-300 text-inherit"
                       autofocus
                       onblur="actions.saveWorkspaceName('${ws.id}')"
                       onkeypress="if(event.key==='Enter'){actions.saveWorkspaceName('${ws.id}')}" />
              </div>
            `
            : `
              <div class="flex-1 cursor-pointer" onclick="actions.selectWorkspace('${ws.id}')">
                <span class="text-sm font-medium">${ws.name}</span>
              </div>
            `;

          return `
            <div class="flex items-center justify-between px-3 py-2 rounded-lg mb-1 ${rowClasses}">
              ${nameCell}
              <div class="flex items-center gap-1 text-xs">
                <button onclick="event.stopPropagation(); actions.startEditWorkspace('${ws.id}')"
                        class="opacity-80 hover:opacity-100">
                  <i data-lucide="edit-2" class="w-3 h-3"></i>
                </button>
                <button onclick="event.stopPropagation(); actions.deleteWorkspace('${ws.id}')"
                        class="opacity-80 hover:opacity-100">
                  <i data-lucide="trash-2" class="w-3 h-3"></i>
                </button>
              </div>
            </div>
          `;
        })
        .join("");

      const projHtml =
        projects
          .filter(p => p.workspaceId === selectedWorkspace)
          .map(p => {
            const isActive = p.id === selectedProject;
            const rowClasses = isActive
              ? "bg-blue-100 text-blue-800"
              : `${hoverBg} ${textColor}`;
            const isEditing = ui.editingProjectId === p.id;

            const nameCell = isEditing
              ? `
              <div class="flex items-center gap-2 flex-1">
                <span class="w-2 h-2 rounded-full ${p.color}"></span>
                <input id="proj-name-input-${p.id}" value="${ui.editingProjectName}"
                       class="w-full bg-transparent text-sm outline-none border-b border-blue-300 text-inherit"
                       autofocus
                       onblur="actions.saveProjectName('${p.id}')"
                       onkeypress="if(event.key==='Enter'){actions.saveProjectName('${p.id}')}" />
              </div>
            `
              : `
              <div class="flex items-center gap-2 flex-1 cursor-pointer"
                   onclick="actions.selectProject('${p.id}')">
                <span class="w-2 h-2 rounded-full ${p.color}"></span>
                <span class="text-sm">${p.name}</span>
              </div>
            `;

            return `
              <div class="flex items-center justify-between px-3 py-2 rounded-lg mb-1 ${rowClasses}">
                ${nameCell}
                <div class="flex items-center gap-1 text-xs">
                  <button onclick="event.stopPropagation(); actions.startEditProject('${p.id}')"
                          class="opacity-80 hover:opacity-100">
                    <i data-lucide="edit-2" class="w-3 h-3"></i>
                  </button>
                  <button onclick="event.stopPropagation(); actions.deleteProject('${p.id}')"
                          class="opacity-80 hover:opacity-100">
                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                  </button>
                </div>
              </div>
            `;
          })
          .join("") || `<div class="text-xs text-gray-400 mt-1">No projects in this workspace.</div>`;

      return `
        <div class="w-72 ${cardBg} border-r ${borderColor} flex flex-col h-full">
          <div class="p-6 border-b ${borderColor}">
            <h1 class="text-2xl font-bold ${textColor} flex items-center gap-2">
              <i data-lucide="layout" class="text-blue-500"></i> WellTask
            </h1>
            <div id="save-status" class="text-xs mt-2 h-4"></div>
          </div>

          <nav class="flex-1 p-4 space-y-6 overflow-y-auto">
            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Workspace</span>
                <button onclick="actions.addWorkspace()"
                        class="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">
                  <i data-lucide="plus" class="w-3 h-3"></i> New
                </button>
              </div>
              ${wsHtml}
            </div>

            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Projects</span>
                <button onclick="actions.addProject()"
                        class="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">
                  <i data-lucide="plus" class="w-3 h-3"></i> New
                </button>
              </div>
              ${projHtml}
            </div>
          </nav>

          <div class="p-4 border-t ${borderColor}">
            <button onclick="actions.toggleTheme()"
                    class="w-full flex items-center justify-between px-4 py-3 rounded-lg ${hoverBg} ${textColor}">
              <span>Theme</span>
              <i data-lucide="${state.darkMode ? "sun" : "moon"}" class="w-5 h-5"></i>
            </button>
          </div>
        </div>
      `;
    }

    function renderColumnsPanel(grp, borderColor, darkMode) {
      return `
        <div class="mb-3 rounded-xl border ${borderColor} ${darkMode ? 'bg-gray-900' : 'bg-gray-50'} p-3 text-xs">
          <div class="flex items-center justify-between mb-2">
            <span class="font-semibold text-gray-600 dark:text-gray-200">Columns for "${grp.name}"</span>
            <button onclick="actions.addColumn('${grp.id}')"
                    class="flex items-center gap-1 text-blue-500 hover:text-blue-700">
              <i data-lucide="plus" class="w-3 h-3"></i> Add Column
            </button>
          </div>
          <div class="space-y-2 max-h-40 overflow-y-auto pr-1">
            ${grp.columns.map(col => `
              <div class="flex items-center gap-2">
                <input id="col-name-${grp.id}-${col.id}" value="${col.name}"
                       class="flex-1 px-2 py-1 rounded border ${borderColor} bg-white dark:bg-gray-800 dark:text-gray-100"
                       onblur="actions.renameColumn('${grp.id}', '${col.id}')"
                       onkeypress="if(event.key==='Enter'){actions.renameColumn('${grp.id}', '${col.id}')}" />
                <span class="text-[10px] px-2 py-1 rounded-full ${col.isDefault ? 'bg-gray-200 text-gray-700' : 'bg-purple-100 text-purple-700'}">
                  ${col.isDefault ? 'Default' : 'Custom'}
                </span>
                <button onclick="actions.deleteColumn('${grp.id}', '${col.id}')"
                        class="text-red-500 hover:text-red-700">
                  <i data-lucide="trash-2" class="w-3 h-3"></i>
                </button>
              </div>
            `).join("")}
          </div>
        </div>
      `;
    }

    function renderCellForColumn(col, t, borderColor) {
      const baseInput =
        `class="w-full px-2 py-1 text-sm border ${borderColor} rounded bg-white dark:bg-gray-800 dark:text-gray-100 focus:outline-none focus:ring-1 focus:ring-blue-400"`;

      if (col.id === "task") {
        if (state.ui.editingTaskId === t.id) {
          return `
            <div class="flex-1 mr-2">
              <input id="task-name-input-${t.id}" value="${t.name}"
                     ${baseInput}
                     autofocus
                     onblur="actions.saveTaskName('${t.id}')"
                     onkeypress="if(event.key==='Enter'){actions.saveTaskName('${t.id}')}" />
            </div>
          `;
        }
        return `
          <div class="flex-1 mr-2 flex items-center gap-2">
            <span class="text-gray-900 dark:text-gray-50">${t.name || "Untitled task"}</span>
            <button onclick="actions.startEditTaskName('${t.id}')"
                    class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
              <i data-lucide="edit-2" class="w-3 h-3"></i>
            </button>
          </div>
        `;
      }

      if (col.id === "assignee") {
        const assigneeName = t.assignee ? t.assignee.name : "";
        const currentName = state.currentUser ? state.currentUser.name : "Owner";
        return `
          <div class="flex-1 mr-2">
            <select ${baseInput}
                    onchange="actions.updateTaskField('${t.id}', 'assignee', this.value || null)">
              <option value="">Unassigned</option>
              <option value="${currentName}" ${assigneeName === currentName ? "selected" : ""}>
                ${currentName}
              </option>
            </select>
          </div>
        `;
      }

      if (col.id === "priority") {
        const priorities = ["Low", "Medium", "High", "Critical"];
        const pillClass = priorityClass(t.priority);
        return `
          <div class="flex-1 mr-2">
            <select
              class="w-full px-2 py-1 text-xs font-medium rounded border ${borderColor} focus:outline-none focus:ring-1 focus:ring-blue-400 ${pillClass}"
              onchange="actions.updateTaskField('${t.id}', 'priority', this.value)">
              ${priorities
            .map(
              p =>
                `<option value="${p}" ${t.priority === p ? "selected" : ""}>${p}</option>`
            )
            .join("")}
            </select>
          </div>
        `;
      }

      if (col.id === "status") {
        const statuses = ["Not Started", "In Progress", "Done"];
        return `
          <div class="flex-1 mr-2">
            <select ${baseInput}
                    onchange="actions.updateTaskField('${t.id}', 'status', this.value)">
              ${statuses
            .map(
              s =>
                `<option value="${s}" ${t.status === s ? "selected" : ""}>${s}</option>`
            )
            .join("")}
            </select>
          </div>
        `;
      }

      if (col.id === "duedate") {
        return `
          <div class="flex-1 mr-2">
            <input type="date" value="${t.dueDate || ""}"
                   ${baseInput}
                   onchange="actions.updateTaskField('${t.id}', 'dueDate', this.value)" />
          </div>
        `;
      }

      const val =
        (t.customFields && t.customFields[col.id]) || "";
      return `
        <div class="flex-1 mr-2">
          <input type="text" value="${val}"
                 ${baseInput}
                 onchange="actions.updateTaskField('${t.id}', 'custom', this.value, '${col.id}')" />
        </div>
      `;
    }

    function renderKanbanView() {
      const { tasks, groups, darkMode, ui, projects, selectedProject } = state;
      if (!selectedProject) {
        return `
          <div class="flex items-center justify-center h-full text-gray-400">
            Select or create a project
          </div>
        `;
      }

      const pageBg = darkMode ? "bg-gray-900" : "bg-gray-50";
      const panelBg = darkMode ? "bg-gray-800" : "bg-white";
      const textColor = darkMode ? "text-gray-100" : "text-gray-900";
      const subtleText = darkMode ? "text-gray-400" : "text-gray-500";
      const borderColor = darkMode ? "border-gray-700" : "border-gray-200";

      const project = projects.find(p => p.id === selectedProject);

      const header = `
        <div class="flex items-center justify-between mb-6">
          <div>
            <p class="text-xs uppercase tracking-wide ${subtleText} mb-1">Project</p>
            <h1 class="text-3xl font-bold ${textColor}">${project ? project.name : "Project"}</h1>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="actions.setView('list')"
                    class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 flex items-center gap-2 text-sm">
              <i data-lucide="layout-list" class="w-4 h-4"></i> List View
            </button>
            <button onclick="actions.addGroup()"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 text-sm">
              <i data-lucide="plus" class="w-4 h-4"></i> New Group
            </button>
          </div>
        </div>
      `;

      const projectGroups = groups.filter(g => g.projectId === selectedProject);

      const columns = projectGroups
        .map(grp => {
          const grpTasks = tasks.filter(t => t.groupId === grp.id);
          const isEditingGroup = ui.editingGroupId === grp.id;
          return `
            <div class="${panelBg} border ${borderColor} rounded-2xl p-4 flex flex-col h-full max-h-[80vh] shadow-sm">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <button onclick="actions.toggleGroupCollapse('${grp.id}')"
                          class="${subtleText} hover:text-gray-600">
                    <i data-lucide="${grp.collapsed ? "chevron-right" : "chevron-down"}" class="w-4 h-4"></i>
                  </button>
                  ${isEditingGroup
              ? `<input id="group-name-input-${grp.id}" value="${ui.editingGroupName}"
                                   class="text-sm font-semibold bg-transparent outline-none border-b border-blue-300 text-${darkMode ? "gray-100" : "gray-900"}"
                                   autofocus
                                   onblur="actions.saveGroupName('${grp.id}')"
                                   onkeypress="if(event.key==='Enter'){actions.saveGroupName('${grp.id}')}" />`
              : `<h2 class="text-sm font-semibold ${textColor}">${grp.name}</h2>`
            }
                  <span class="bg-gray-100 dark:bg-gray-900 ${subtleText} text-xs px-2 py-1 rounded-full">${grpTasks.length}</span>
                </div>
                <div class="flex items-center gap-2 text-xs ${subtleText}">
                  <button onclick="actions.toggleColumnsPanel('${grp.id}')"
                          class="flex items-center gap-1 hover:text-gray-700">
                    <i data-lucide="columns-3" class="w-3 h-3"></i> Columns
                  </button>
                  <button onclick="actions.startEditGroup('${grp.id}')"
                          class="hover:text-gray-700 flex items-center gap-1">
                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                  </button>
                  <button onclick="actions.deleteGroup('${grp.id}')"
                          class="hover:text-red-600 text-red-500 flex items-center gap-1">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                  </button>
                </div>
              </div>

              ${state.ui.columnsGroupId === grp.id ? renderColumnsPanel(grp, borderColor, darkMode) : ""}

              <div class="flex-1 overflow-y-auto space-y-3 pr-1 ${grp.collapsed ? "hidden" : ""}">
                ${grpTasks
              .map(
                t => `
                  <div class="bg-white dark:bg-gray-700 p-3 rounded-lg border ${borderColor} shadow-sm hover:shadow-md transition">
                    <div class="flex items-start justify-between gap-2 mb-2">
                      <div class="flex-1">
                        ${state.ui.editingTaskId === t.id
                    ? `<input id="task-name-input-${t.id}" value="${t.name}"
                                             class="w-full text-sm font-medium bg-transparent outline-none border-b border-blue-300 text-gray-900 dark:text-gray-50"
                                             autofocus
                                             onblur="actions.saveTaskName('${t.id}')"
                                             onkeypress="if(event.key==='Enter'){actions.saveTaskName('${t.id}')}" />`
                    : `<div class="font-medium text-gray-900 dark:text-gray-50">${t.name}</div>`
                  }
                      </div>
                      <div class="flex items-center gap-1">
                        <button onclick="actions.startEditTaskName('${t.id}')"
                                class="${subtleText} hover:text-gray-200">
                          <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick="actions.deleteTask('${t.id}')"
                                class="text-red-500 hover:text-red-700">
                          <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                      </div>
                    </div>
                    <div class="flex justify-between items-center text-xs ${subtleText}">
                      <div class="flex items-center gap-2">
                        <select onchange="actions.moveTaskToGroup('${t.id}', this.value)"
                                class="bg-gray-100 dark:bg-gray-800 rounded px-2 py-1">
                          ${projectGroups
                    .map(
                      g =>
                        `<option value="${g.id}" ${g.id === t.groupId ? "selected" : ""
                        }>${g.name}</option>`
                    )
                    .join("")}
                        </select>
                        <span class="px-2 py-1 rounded text-xs font-medium ${priorityClass(
                  t.priority
                )}">
                          ${t.priority}
                        </span>
                      </div>
                      <span>${t.dueDate || ""}</span>
                    </div>
                  </div>
                `
              )
              .join("")}
              </div>

              <div class="mt-3 pt-3 border-t ${borderColor} ${grp.collapsed ? "hidden" : ""}">
                ${state.ui.showNewTask === grp.id
              ? `
                      <div class="space-y-2">
                        <input id="new-task-name-${grp.id}" type="text" placeholder="Task name..."
                               class="w-full p-2 text-sm border rounded dark:bg-gray-700 dark:text-gray-50"
                               autofocus
                               onkeypress="if(event.key==='Enter'){actions.submitTask('${grp.id}')}" />
                        <button onclick="actions.submitTask('${grp.id}')"
                                class="w-full bg-green-600 text-white px-3 py-1 rounded text-sm">
                          Add Task
                        </button>
                      </div>
                    `
              : `
                      <button onclick="actions.setShowNewTask('${grp.id}')"
                              class="w-full py-2 text-sm text-blue-500 border border-dashed border-blue-300 rounded hover:bg-blue-50 dark:hover:bg-gray-900">
                        + Add Task
                      </button>
                    `
            }
              </div>
            </div>
          `;
        })
        .join("");

      return `
        <div class="p-6 h-full overflow-auto ${pageBg}">
          ${header}
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 min-w-[900px]">
            ${columns}
          </div>
        </div>
      `;
    }

    function renderListView() {
      const { tasks, groups, darkMode, ui, projects, selectedProject } = state;
      const pageBg = darkMode ? "bg-gray-900" : "bg-gray-50";
      const cardBg = darkMode ? "bg-gray-800" : "bg-white";
      const textColor = darkMode ? "text-gray-100" : "text-gray-900";
      const subtleText = darkMode ? "text-gray-400" : "text-gray-500";
      const borderColor = darkMode ? "border-gray-700" : "border-gray-200";

      const project = projects.find(p => p.id === selectedProject);

      const header = `
        <div class="flex items-center justify-between mb-6">
          <div>
            <p class="text-xs uppercase tracking-wide ${subtleText} mb-1">Project</p>
            <h1 class="text-3xl font-bold ${textColor}">${project ? project.name : "Project"}</h1>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="actions.setView('kanban')"
                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2 text-sm">
              <i data-lucide="grid-3x3" class="w-4 h-4"></i> Kanban View
            </button>
            <button onclick="actions.addGroup()"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 text-sm">
              <i data-lucide="plus" class="w-4 h-4"></i> New Group
            </button>
          </div>
        </div>
      `;

      const groupBlocks = groups
        .filter(grp => grp.projectId === selectedProject)
        .map(grp => {
          const grpTasks = tasks.filter(t => t.groupId === grp.id);
          const cols = grp.columns;
          const isEditingGroup = ui.editingGroupId === grp.id;

          const headerCols =
            cols
              .map(
                col =>
                  `<div class="flex-1 text-xs font-semibold ${subtleText}">${col.name}</div>`
              )
              .join("") +
            `<div class="w-16 text-xs font-semibold ${subtleText} text-right">Actions</div>`;

          const rows =
            grpTasks
              .map(
                t => `
            <div class="grid grid-cols-[repeat(${cols.length},minmax(0,1fr))_80px] items-center border-t ${borderColor} px-4 py-3 text-sm hover:bg-gray-50 dark:hover:bg-gray-700">
              ${cols.map(col => renderCellForColumn(col, t, borderColor)).join("")}
              <div class="flex justify-end">
                <button onclick="actions.deleteTask('${t.id}')" class="text-red-500 hover:text-red-700">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
            </div>
          `
              )
              .join("") ||
            `
            <div class="border-t ${borderColor} px-4 py-4 text-sm ${subtleText}">
              No tasks yet. Click "Add Task" to create one.
            </div>
          `;

          return `
            <div class="mb-6 rounded-2xl overflow-hidden border ${borderColor} shadow-sm ${cardBg}">
              <div class="flex items-center justify-between px-4 py-3 border-b ${borderColor}">
                <div class="flex items-center gap-2">
                  <button onclick="actions.toggleGroupCollapse('${grp.id}')"
                          class="${subtleText} hover:text-gray-600">
                    <i data-lucide="${grp.collapsed ? "chevron-right" : "chevron-down"}" class="w-4 h-4"></i>
                  </button>
                  ${isEditingGroup
              ? `<input id="group-name-input-${grp.id}" value="${ui.editingGroupName}"
                                   class="text-sm font-semibold bg-transparent outline-none border-b border-blue-300 text-${darkMode ? "gray-100" : "gray-900"}"
                                   autofocus
                                   onblur="actions.saveGroupName('${grp.id}')"
                                   onkeypress="if(event.key==='Enter'){actions.saveGroupName('${grp.id}')}" />`
              : `<h2 class="text-sm font-semibold ${textColor}">${grp.name}</h2>`
            }
                  <span class="bg-gray-100 dark:bg-gray-900 ${subtleText} text-xs px-2 py-1 rounded-full">${grpTasks.length}</span>
                </div>
                <div class="flex items-center gap-3 text-xs ${subtleText}">
                  <button onclick="actions.toggleColumnsPanel('${grp.id}')"
                          class="flex items-center gap-1 hover:text-gray-700">
                    <i data-lucide="columns-3" class="w-3 h-3"></i> Columns
                  </button>
                  <button onclick="actions.startEditGroup('${grp.id}')"
                          class="hover:text-gray-700 flex items-center gap-1">
                    <i data-lucide="edit-2" class="w-3 h-3"></i> Rename
                  </button>
                  <button onclick="actions.deleteGroup('${grp.id}')"
                          class="hover:text-red-600 text-red-500 flex items-center gap-1">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
                  </button>
                </div>
              </div>

              ${state.ui.columnsGroupId === grp.id ? renderColumnsPanel(grp, borderColor, darkMode) : ""}

              <div class="${grp.collapsed ? "hidden" : "block"}">
                <div class="overflow-x-auto">
                  <div class="min-w-[1000px]">
                    <div class="grid grid-cols-[repeat(${cols.length},minmax(0,1fr))_80px] gap-2 px-4 py-3 text-xs bg-gray-50 dark:bg-gray-900 border-y ${borderColor}">
                      ${headerCols}
                    </div>
                    ${rows}
                  </div>
                </div>

                <div class="border-t ${borderColor} px-4 py-3 bg-gray-50 dark:bg-gray-900">
                  ${state.ui.showNewTask === grp.id
              ? `
                        <div class="flex gap-2">
                          <input id="new-task-name-${grp.id}" type="text" placeholder="Task name..."
                                 class="flex-1 px-3 py-2 text-sm border rounded-lg dark:bg-gray-700 dark:text-gray-50"
                                 autofocus
                                 onkeypress="if(event.key==='Enter'){actions.submitTask('${grp.id}')}" />
                          <button onclick="actions.submitTask('${grp.id}')"
                                  class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                            Add
                          </button>
                        </div>
                      `
              : `
                        <button onclick="actions.setShowNewTask('${grp.id}')"
                                class="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">
                          <i data-lucide="plus" class="w-3 h-3"></i> Add Task
                        </button>
                      `
            }
                </div>
              </div>
            </div>
          `;
        })
        .join("");

      return `
        <div class="p-6 h-full overflow-auto ${pageBg}">
          ${header}
          ${groupBlocks}
        </div>
      `;
    }

    function renderLogin() {
      return `
        <div class="h-screen flex items-center justify-center bg-gray-100 text-xl text-gray-600">
          Please open WellTask from Zoho Cliq.
        </div>
      `;
    }

    function renderApp() {
      const app = document.getElementById("app");
      if (!app) return;

      if (state.showLogin) {
        app.innerHTML = renderLogin();
      } else {
        document.documentElement.classList.toggle("dark", state.darkMode);
        const bgColor = state.darkMode ? "bg-gray-900" : "bg-gray-50";

        app.innerHTML = `
          <div class="flex h-screen ${bgColor} overflow-hidden font-sans relative">
            ${state.isLoading
            ? `<div class="absolute inset-0 bg-black/20 z-50 flex items-center justify-center">
                     <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                   </div>`
            : ""
          }
            ${renderSidebar()}
            <div class="flex-1 overflow-hidden">
              ${state.currentView === "kanban"
            ? renderKanbanView()
            : renderListView()
          }
            </div>
          </div>
        `;
        renderStatusIndicator();
      }

      lucide.createIcons();
    }

    // ==========================
    // BOOT
    // ==========================
    // If we have a boardid (channel/user) OR a currentUser, try to load
    if (boardid || state.currentUser) {
      api.load();
    } else {
      renderApp();
    }
  </script>
</body>
</html>
