<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WellTask Kanban Dashboard</title>
    <!-- Tailwind CSS CDN for modern, clean UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Zoho Cliq Web SDK (The essential bridge) -->
    <script src="https://js.zohocdn.com/cliq/v1/embed/sdk.js"></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        .kanban-container {
            height: calc(100vh - 80px); /* Adjust height for mobile/desktop view */
            overflow-x: auto;
            display: flex;
            padding-bottom: 1rem;
        }
        .kanban-col {
            min-width: 300px;
            max-height: 100%;
            overflow-y: auto;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        /* Hide the annoying scrollbar on mobile */
        .kanban-col::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 font-sans">
    
    <!-- HEADER BAR -->
    <div class="flex justify-between items-center mb-6 bg-white p-3 rounded-lg shadow-md">
        <h1 class="text-xl font-extrabold text-blue-800">ðŸŽ¯ WellTask Dashboard</h1>
        <div id="user-info" class="text-sm text-gray-600">Loading User...</div>
        <button onclick="openTaskForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg shadow-md text-sm font-medium transition duration-150">
            + New Task
        </button>
    </div>

    <!-- MAIN KANBAN INTERFACE (Monday.com Style) -->
    <div class="kanban-container">

        <!-- Column 1: Focus/To Do -->
        <div id="col-todo" class="kanban-col bg-white rounded-xl shadow-lg">
            <h2 class="sticky top-0 bg-blue-500 text-white font-bold text-lg p-3 rounded-t-xl mb-3 flex justify-between items-center">
                <span>To Do</span>
                <span class="text-xs bg-white text-blue-700 px-2 rounded-full" id="count-todo">0</span>
            </h2>
            <div class="px-3 pb-3 space-y-3" id="task-list-todo">
                <!-- Task Cards will be inserted here by JavaScript -->
                <div class="text-gray-400 text-sm text-center p-8">Your tasks will appear here.</div>
            </div>
        </div>

        <!-- Column 2: In Progress -->
        <div id="col-in-progress" class="kanban-col bg-white rounded-xl shadow-lg">
            <h2 class="sticky top-0 bg-yellow-500 text-white font-bold text-lg p-3 rounded-t-xl mb-3 flex justify-between items-center">
                <span>In Progress</span>
                <span class="text-xs bg-white text-yellow-700 px-2 rounded-full" id="count-progress">1</span>
            </h2>
            <div class="px-3 pb-3 space-y-3" id="task-list-progress">
                <!-- Placeholder Card with Timer Demo -->
                <div id="demo-card-1" class="task-card bg-white border-l-4 border-yellow-500 shadow-lg rounded-lg p-4 hover:shadow-xl transition cursor-pointer" data-task-id="demo1">
                    <h3 class="font-bold text-gray-800 text-base">Build Cliq Widget UI</h3>
                    <div class="flex justify-between items-center mt-3">
                        <span class="bg-yellow-100 text-yellow-700 text-xs font-semibold px-2 py-1 rounded-full">Development</span>
                        <!-- Live Timer UI Element -->
                        <span id="timer-demo1" class="font-mono text-sm text-gray-700">00:00:00</span>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100 flex justify-end">
                         <button id="timer-btn-demo1" onclick="toggleTimer('demo1')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-lg">Start Timer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Column 3: Done -->
        <div id="col-done" class="kanban-col bg-white rounded-xl shadow-lg">
            <h2 class="sticky top-0 bg-green-500 text-white font-bold text-lg p-3 rounded-t-xl mb-3 flex justify-between items-center">
                <span>Done</span>
                <span class="text-xs bg-white text-green-700 px-2 rounded-full" id="count-done">0</span>
            </h2>
            <div class="px-3 pb-3 space-y-3" id="task-list-done">
                <div class="text-gray-400 text-sm text-center p-8">Time to celebrate!</div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        let currentUserId = null;
        let timerIntervals = {}; // To manage multiple timers if needed

        // --- 1. SDK Initialization and User Context ---
        ZohoCliq.onLoad(function() {
             var context = ZohoCliq.getContext();
             currentUserId = context.user.id;
             var userName = context.user.name || "Zoho User";

             console.log("Cliq Widget loaded successfully for User ID:", currentUserId);

             // Update UI to show the logged-in user
             document.getElementById('user-info').innerText = 'User: ' + userName;

             // NOTE: This is where you would call your Deluge function
             // to fetch and render the real tasks from your database.
             // fetchTasks(currentUserId);
        });

        // --- 2. Interactivity Functions ---

        function openTaskForm() {
            // FIX: Use SDK's openPopup to display a modal instead of browser alert
            if (typeof ZohoCliq !== 'undefined' && currentUserId) {
                // You would replace this URL with the URL of your dedicated "New Task" HTML page,
                // or a simple static message to show the functionality works.
                ZohoCliq.openPopup({
                    "url": "https://placehold.co/400x300?text=New+Task+Form+Opens+Here",
                    "title": "Create New WellTask",
                    "height": "400px",
                    "width": "600px"
                });
            } else {
                console.error("ZohoCliq SDK not initialized or User ID missing.");
                // Fallback for local testing
                alert("Task creation functionality triggered! (User: " + currentUserId + ")");
            }
        }

        function toggleTimer(taskId) {
            const timerDisplay = document.getElementById(`timer-${taskId}`);
            const timerButton = document.getElementById(`timer-btn-${taskId}`);
            
            // Check if the timer is currently running for this task
            if (timerButton.classList.contains('bg-red-500')) {
                // STOP TIMER LOGIC
                clearInterval(timerIntervals[taskId]);
                timerButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                timerButton.classList.add('bg-green-500', 'hover:bg-green-600');
                timerButton.innerText = 'Resume Timer';
                delete timerIntervals[taskId];

                // Send STOP signal to Deluge Backend
                console.log(`[DB ACTION] Stopping timer for task ${taskId}. Sending duration to Deluge.`);
                if (typeof ZohoCliq !== 'undefined' && currentUserId) {
                    // This call would hit your Deluge function to record the time spent
                    ZohoCliq.http().post("/api/v2/functions/stop_task_timer", { 
                        task_id: taskId, 
                        user_id: currentUserId,
                        time_spent_seconds: timerDisplay.dataset.seconds // Use the stored time
                    }).then(response => {
                        console.log("Timer stopped in DB (Mock Response):", response);
                        // Optional: Show success banner via SDK
                        // ZohoCliq.showConfirmation({ message: "Time tracked successfully!" }); 
                    });
                }

            } else {
                // START TIMER LOGIC
                // Clear any other running timer for simplicity
                for (const runningId in timerIntervals) {
                    if (runningId !== taskId) {
                        // Implement pause logic for other tasks if necessary
                        clearInterval(timerIntervals[runningId]); 
                        delete timerIntervals[runningId];
                    }
                }

                let seconds = parseInt(timerDisplay.dataset.seconds || 0);

                timerIntervals[taskId] = setInterval(() => {
                    seconds++;
                    timerDisplay.dataset.seconds = seconds; // Store time in dataset
                    const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
                    const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                    const s = String(seconds % 60).padStart(2, '0');
                    timerDisplay.innerText = `${h}:${m}:${s}`;
                }, 1000);

                timerButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                timerButton.classList.add('bg-red-500', 'hover:bg-red-600');
                timerButton.innerText = 'Stop Timer';
                
                // Send START signal to Deluge Backend
                console.log(`[DB ACTION] Starting timer for task ${taskId}. Notifying Deluge.`);
                if (typeof ZohoCliq !== 'undefined' && currentUserId) {
                     // This call would hit your Deluge function to record the start time
                    ZohoCliq.http().post("/api/v2/functions/start_task_timer", { 
                        task_id: taskId, 
                        user_id: currentUserId,
                        start_time: new Date().toISOString()
                    }).then(response => {
                        console.log("Timer started in DB (Mock Response):", response);
                    });
                }
            }
        }
        
    </script>
</body>
</html>