<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>WellTask</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script src="https://unpkg.com/lucide@latest"></script>

Â  <script>
Â  Â  tailwind.config = {
Â  Â  Â  darkMode: 'class',
Â  Â  Â  theme: {
Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  gray: { 750: '#2d3748' }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  </script>

Â  <style>
Â  Â  ::-webkit-scrollbar{width:8px;height:8px;}
Â  Â  ::-webkit-scrollbar-track{background:transparent;}
Â  Â  ::-webkit-scrollbar-thumb{background:#cbd5e0;border-radius:4px;}
Â  Â  .dark ::-webkit-scrollbar-thumb{background:#4a5568;}
Â  </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-200">
<div id="app"></div>

<script>
Â  // ðŸ”´ API Configuration
Â  const ZOHO_API_URL = "/api/proxy?";

Â  // ---------- Auth ----------
Â  const urlParams = new URLSearchParams(window.location.search);
Â  const token = urlParams.get('token');

Â  let currentUser = null;
Â  if (token) {
Â  Â  try {
Â  Â  Â  const decoded = atob(token);
Â  Â  Â  const parts = decoded.split("::");
Â  Â  Â  if (parts.length === 2) {
Â  Â  Â  Â  currentUser = {
Â  Â  Â  Â  Â  id: parts[1],
Â  Â  Â  Â  Â  name: parts[0].split('@')[0],
Â  Â  Â  Â  Â  email: parts[0],
Â  Â  Â  Â  Â  role: 'owner'
Â  Â  Â  Â  };
Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  console.error("Auth Failed", e);
Â  Â  }
Â  }

Â  const uid = () => Date.now() + Math.floor(Math.random() * 1000);

Â  // ---------- State ----------
Â  const initialState = {
Â  Â  darkMode: false,
Â  Â  currentView: 'list',
Â  Â  currentUser,
Â  Â  showLogin: !currentUser,

Â  Â  // These start empty and will be filled by the Database
Â  Â  workspaces: [],
Â  Â  selectedWorkspace: null,

Â  Â  projects: [],
Â  Â  selectedProject: null,

Â  Â  groups: [],
Â  Â  tasks: [],

Â  Â  ui: {
Â  Â  Â  showNewTask: null,
Â  Â  Â  newTask: { name: '', assignee: null, priority: 'Medium', status: 'Not Started', dueDate: '', customFields: {} },
Â  Â  Â  columnsGroupId: null,
Â  Â  Â  editingWorkspaceId: null, editingWorkspaceName: '',
Â  Â  Â  editingProjectId: null, editingProjectName: '',
Â  Â  Â  editingTaskId: null,
Â  Â  Â  editingGroupId: null, editingGroupName: ''
Â  Â  }
Â  };

Â  let state = { ...initialState };

Â  // ---------- Helpers ----------
Â  function getGroupIdFromStatus(status) {
Â  Â  if (status === 'In Progress') return 2;
Â  Â  if (status === 'Done') return 3;
Â  Â  return 1;
Â  }

Â  function priorityClass(priority) {
Â  Â  switch (priority) {
Â  Â  Â  case 'Critical': return 'bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300';
Â  Â  Â  case 'High':Â  Â  Â return 'bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-300';
Â  Â  Â  case 'Medium':Â  Â return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-200';
Â  Â  Â  case 'Low':Â  Â  Â  return 'bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300';
Â  Â  Â  default:Â  Â  Â  Â  Â return 'bg-gray-100 text-gray-800 dark:bg-gray-500/20 dark:text-gray-200';
Â  Â  }
Â  }

Â  // ---------- API ----------
Â  const api = {
Â  Â  // 1. SYNC ALL (Fetch Tasks AND Structure)
Â  Â  syncAll: async () => {
Â  Â  Â  if (!state.currentUser) return;
Â  Â  Â  try {
Â  Â  Â  Â  // ðŸ”´ DEBUG: Log the GET request starting
Â  Â  Â  Â  console.log("API: Starting syncAll (GET). User:", state.currentUser.email);
Â  Â  Â  Â  
Â  Â  Â  Â  const res = await fetch(`${ZOHO_API_URL}&request_method=GET&user_email=${state.currentUser.email}`);
Â  Â  Â  Â  const json = await res.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ðŸ”´ DEBUG: Log the raw response from Deluge
Â  Â  Â  Â  console.log("API: syncAll response (Deluge Output):", json); 
Â  Â  Â  Â  
Â  Â  Â  Â  if (json.status === 'success' && json.data) {
Â  Â  Â  Â  Â  const serverTasks = json.data.tasks || [];
Â  Â  Â  Â  Â  const serverMeta = json.data.metadata || [];

Â  Â  Â  Â  Â  // A. Rebuild Structure (Workspaces -> Projects -> Groups)
Â  Â  Â  Â  Â  if(serverMeta.length > 0) {
Â  Â  Â  Â  Â  Â  Â  const workspaces = [];
Â  Â  Â  Â  Â  Â  Â  const projects = [];
Â  Â  Â  Â  Â  Â  Â  const groups = [];
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  serverMeta.forEach(m => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  let attrs = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  try { attrs = JSON.parse(m.attributes); } catch(e){}
Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  if(m.recordtype === 'workspace') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  workspaces.push({ id: String(m.id), name: m.name });
Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if(m.recordtype === 'project') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projects.push({ id: String(m.id), name: m.name, workspaceId: m.relatedid, color: attrs.color || 'bg-blue-500' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if(m.recordtype === 'group') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  groups.push({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: String(m.id),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: m.name,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectId: m.relatedid,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  collapsed: attrs.collapsed || false,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  columns: attrs.columns || []Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  state.workspaces = workspaces;
Â  Â  Â  Â  Â  Â  Â  state.projects = projects;
Â  Â  Â  Â  Â  Â  Â  state.groups = groups;
Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  // If DB is empty, initialize defaults so the UI isn't blank
Â  Â  Â  Â  Â  Â  Â  console.log("API: Database is empty. Initializing defaults.");
Â  Â  Â  Â  Â  Â  Â  api.initDefaults();Â 
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // B. Rebuild Tasks
Â  Â  Â  Â  Â  state.tasks = serverTasks.map(t => {
Â  Â  Â  Â  Â  Â  let extras = { duedate: "", custom: {}, groupId: null };
Â  Â  Â  Â  Â  Â  try { if (t.customattributes) extras = JSON.parse(t.customattributes); } catch (e) {}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Use saved Group ID or fallback to status logic
Â  Â  Â  Â  Â  Â  let gId = extras.groupId;
Â  Â  Â  Â  Â  Â  if(!gId) gId = getGroupIdFromStatus(t.status);

Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  id: String(t.id),
Â  Â  Â  Â  Â  Â  Â  name: t.taskname,
Â  Â  Â  Â  Â  Â  Â  status: t.status || 'Not Started',
Â  Â  Â  Â  Â  Â  Â  priority: t.priority || 'Medium',
Â  Â  Â  Â  Â  Â  Â  assignee: t.assignee === 'Unassigned' ? null : { name: t.assignee },
Â  Â  Â  Â  Â  Â  Â  dueDate: extras.duedate || "",
Â  Â  Â  Â  Â  Â  Â  customFields: extras.custom || {},
Â  Â  Â  Â  Â  Â  Â  projectId: state.selectedProject,Â 
Â  Â  Â  Â  Â  Â  Â  groupId: gId
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  // Ensure a workspace/project is selected
Â  Â  Â  Â  Â  if(state.workspaces.length > 0 && !state.selectedWorkspace) state.selectedWorkspace = state.workspaces[0].id;
Â  Â  Â  Â  Â  if(state.projects.length > 0 && !state.selectedProject) state.selectedProject = state.projects[0].id;

Â  Â  Â  Â  Â  renderApp();
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) { console.error("Sync Error", e); }
Â  Â  },

Â  Â  // Initialize Default Data on First Run
Â  Â  initDefaults: () => {
Â  Â  Â  Â  const wId = String(uid());
Â  Â  Â  Â  const pId = String(uid());
Â  Â  Â  Â  const g1 = String(uid()), g2 = String(uid()), g3 = String(uid());
Â  Â  Â  Â Â 
Â  Â  Â  Â  state.workspaces = [{id: wId, name: 'My Workspace'}];
Â  Â  Â  Â  state.projects = [{id: pId, name: 'Marketing Campaign', color: 'bg-purple-500', workspaceId: wId}];
Â  Â  Â  Â  state.groups = [
Â  Â  Â  Â  Â  Â  {id: g1, name: 'To Do', projectId: pId, collapsed: false, columns: []},
Â  Â  Â  Â  Â  Â  {id: g2, name: 'In Progress', projectId: pId, collapsed: false, columns: []},
Â  Â  Â  Â  Â  Â  {id: g3, name: 'Done', projectId: pId, collapsed: false, columns: []}
Â  Â  Â  Â  ];
Â  Â  Â  Â  state.selectedWorkspace = wId;
Â  Â  Â  Â  state.selectedProject = pId;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Save these defaults to DB so they persist
Â  Â  Â  Â  console.log("API: Sending default structure to save...");
Â  Â  Â  Â  api.saveMetadata('create', 'workspace', state.workspaces[0]);
Â  Â  Â  Â  api.saveMetadata('create', 'project', state.projects[0]);
Â  Â  Â  Â  state.groups.forEach(g => api.saveMetadata('create', 'group', g));
Â  Â  },

Â  Â  // 2. SAVE METADATA (Structure)
Â  Â  saveMetadata: async (action, type, data) => {
Â  Â  Â  Â  Â const payload = {
Â  Â  Â  Â  Â  Â  Â name: data.name,
Â  Â  Â  Â  Â  Â  Â recordtype: type,
Â  Â  Â  Â  Â  Â  Â relatedid: data.relatedId || data.workspaceId || data.projectId || "",
Â  Â  Â  Â  Â  Â  Â attributes: JSON.stringify(data.attributes || {color: data.color, collapsed: data.collapsed, columns: data.columns} || {})
Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â let url = `${ZOHO_API_URL}&request_method=POST&type=metadata&action=${action}&user_email=${state.currentUser.email}`;
Â  Â  Â  Â  Â for (const [key, value] of Object.entries(payload)) { url += `&${key}=${encodeURIComponent(value)}`; }
Â  Â  Â  Â  Â if(data.id && action !== 'create') url += `&id=${data.id}`;
           // ðŸ”´ DEBUG: Log metadata POST URL before sending
            console.log(`API: Sending Metadata ${action} URL:`, url);
Â  Â  Â  Â  Â try { 
            const res = await fetch(url); 
            const json = await res.json(); // Read response for success/error
            console.log(`API: Metadata ${action} response:`, json); // Check this log for DB ID!
            
            if(action === 'create' && json.status === 'success') {
                // If this is the initial structure, sync everything immediately.
                api.syncAll(); 
            }
            if (json.status !== 'success' || (json.data && !json.data.id && json.data.status !== 'success' && json.data.error)) {
                console.error(`DELUGE ERROR: Metadata ${action} failed. Response:`, json);
                // alert(`Metadata Error: ${json.data.message || 'Check Cliq logs.'}`); // Optional alert for persistent failure
                return; 
            }
        } catch(e) { console.error(`API: Metadata ${action} Error:`, e); }
Â  Â  },

Â  Â  // 3. TASK OPERATIONS
Â  Â  createTask: async (groupId) => {
Â  Â  Â  const taskData = state.ui.newTask;
Â  Â  Â  if (!taskData.name.trim()) return;

Â  Â  Â  // --- Client-side temporary update ---
Â  Â  Â  const tempId = String(uid());
Â  Â  Â  state.tasks.push({ id: tempId, groupId, projectId: state.selectedProject, ...taskData });
Â  Â  Â  state.ui.showNewTask = null;
Â  Â  Â  renderApp();

Â  Â  Â  // --- Prepare data for server ---
Â  Â  Â  const packed = JSON.stringify({Â 
Â  Â  Â  Â  Â  duedate: taskData.dueDate,Â 
Â  Â  Â  Â  Â  custom: taskData.customFields,
Â  Â  Â  Â  Â  groupId: groupIdÂ 
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  // ðŸ”´ DEBUG: Construct the full URL for the POST request
Â  Â  Â  Â  const postUrl = 
Â  Â  Â  Â  Â  `${ZOHO_API_URL}&request_method=POST&type=task&action=create` +
Â  Â  Â  Â  Â  `&name=${encodeURIComponent(taskData.name)}` +
Â  Â  Â  Â  Â  `&user_email=${state.currentUser.email}` +
Â  Â  Â  Â  Â  `&status=${encodeURIComponent(taskData.status)}` +
Â  Â  Â  Â  Â  `&priority=${encodeURIComponent(taskData.priority)}` +
Â  Â  Â  Â  Â  `&assignee=${encodeURIComponent(taskData.assignee?.name || 'Unassigned')}` +
Â  Â  Â  Â  Â  `&attributes=${encodeURIComponent(packed)}`;
Â  Â  Â  Â  
Â  Â  Â  Â  console.log("API: Sending Task Create URL:", postUrl); // CHECK THIS URL!
Â  Â  Â  Â  
        // ðŸ”´ CRITICAL FIX: Await the full response from the proxy/Deluge
Â  Â  Â  Â  const response = await fetch(postUrl);
        const json = await response.json(); // Read the JSON result from the Deluge handler
        
        console.log("API: Task Create Response (Deluge Result):", json); // CHECK THIS RESULT!

        if (json.status !== 'success' || (json.data && !json.data.id && json.data.status !== 'success')) {
            console.error("DELUGE ERROR: Task failed to save. Full Response:", json);
            alert("Error saving task: Please check Cliq logs for details.");
            return; 
        }

Â  Â  Â  Â  // ONLY run syncAll if the save was successful (and fully awaited)
Â  Â  Â  Â  api.syncAll();
Â  Â  Â  } catch (e) { console.error("Network or Proxy Error:", e); }
Â  Â  },

Â  Â  updateTask: async (task) => {
Â  Â  Â  try {
Â  Â  Â  Â  const packed = JSON.stringify({ duedate: task.dueDate || "", custom: task.customFields || {}, groupId: task.groupId });
Â  Â  Â  Â  const updateUrl = 
Â  Â  Â  Â  Â  `${ZOHO_API_URL}&request_method=POST&type=task&action=update` +
Â  Â  Â  Â  Â  `&id=${encodeURIComponent(task.id)}` +
Â  Â  Â  Â  Â  `&name=${encodeURIComponent(task.name)}` +
Â  Â  Â  Â  Â  `&user_email=${state.currentUser.email}` +
Â  Â  Â  Â  Â  `&status=${encodeURIComponent(task.status)}` +
Â  Â  Â  Â  Â  `&priority=${encodeURIComponent(task.priority)}` +
Â  Â  Â  Â  Â  `&assignee=${encodeURIComponent(task.assignee?.name || 'Unassigned')}` +
Â  Â  Â  Â  Â  `&attributes=${encodeURIComponent(packed)}`;

        console.log("API: Sending Task Update URL:", updateUrl);
Â  Â  Â  Â  const response = await fetch(updateUrl);
        const json = await response.json();
        console.log("API: Task Update Response:", json);
         if (json.status !== 'success') { console.error("DELUGE ERROR: Task update failed. Full Response:", json); }

Â  Â  Â  } catch (e) { console.error(e); }
Â  Â  },

Â  Â  deleteTask: async (id) => {
Â  Â  Â  state.tasks = state.tasks.filter(t => t.id !== id);
Â  Â  Â  renderApp();
Â  Â  Â  try { 
        const deleteUrl = `${ZOHO_API_URL}&request_method=POST&type=task&action=delete&id=${encodeURIComponent(id)}`;
        console.log("API: Sending Task Delete URL:", deleteUrl);
        const response = await fetch(deleteUrl);
        const json = await response.json();
        console.log("API: Task Delete Response:", json);
        
    } catch (e) {}
Â  Â  }
Â  };

Â  // ---------- Actions (UI Interactions) ----------
Â  const actions = {
Â  Â  render: () => renderApp(),
Â  Â  toggleTheme: () => { state.darkMode = !state.darkMode; renderApp(); },
Â  Â  setView: (view) => { state.currentView = view; renderApp(); },

Â  Â  // WORKSPACES
Â  Â  selectWorkspace: (id) => {
Â  Â  Â  state.selectedWorkspace = String(id);
Â  Â  Â  const proj = state.projects.find(p => String(p.workspaceId) === String(id));
Â  Â  Â  if (proj) state.selectedProject = proj.id;
Â  Â  Â  renderApp();
Â  Â  },
Â  Â  addWorkspace: () => {
Â  Â  Â  const id = String(uid());
Â  Â  Â  const newWS = { id, name: 'New Workspace' };
Â  Â  Â  state.workspaces.push(newWS);
Â  Â  Â  state.selectedWorkspace = id;
Â  Â  Â  renderApp();
Â  Â  Â  api.saveMetadata('create', 'workspace', newWS);
Â  Â  },
Â  Â  startEditWorkspace: (id) => {
Â  Â  Â  const ws = state.workspaces.find(w => String(w.id) === String(id));
Â  Â  Â  if(ws) { state.ui.editingWorkspaceId = id; state.ui.editingWorkspaceName = ws.name; renderApp(); }
Â  Â  },
Â  Â  saveWorkspaceName: (id) => {
Â  Â  Â  const input = document.getElementById(`ws-name-input-${id}`);
Â  Â  Â  const ws = state.workspaces.find(w => String(w.id) === String(id));
Â  Â  Â  if (ws && input && input.value.trim()) {
Â  Â  Â  Â  ws.name = input.value.trim();
Â  Â  Â  Â  api.saveMetadata('update', 'workspace', ws);
Â  Â  Â  }
Â  Â  Â  state.ui.editingWorkspaceId = null;
Â  Â  Â  renderApp();
Â  Â  },
Â  Â  deleteWorkspace: (id) => {
Â  Â  Â  Â  if(state.workspaces.length <= 1) return;
Â  Â  Â  Â  state.workspaces = state.workspaces.filter(w => String(w.id) !== String(id));
Â  Â  Â  Â  if(String(state.selectedWorkspace) === String(id)) state.selectedWorkspace = state.workspaces[0].id;
Â  Â  Â  Â  renderApp();
Â  Â  Â  Â  api.saveMetadata('delete', 'workspace', {id});
Â  Â  },

Â  Â  // PROJECTS
Â  Â  addProject: () => {
Â  Â  Â  const id = String(uid());
Â  Â  Â  const newProj = { id, name: 'New Project', color: 'bg-green-500', workspaceId: state.selectedWorkspace };
Â  Â  Â  state.projects.push(newProj);
Â  Â  Â  state.selectedProject = id;
Â  Â  Â  renderApp();
Â  Â  Â  api.saveMetadata('create', 'project', { name: newProj.name, relatedId: newProj.workspaceId, attributes: { color: newProj.color } });
Â  Â  },
Â  Â  selectProject: (id) => { state.selectedProject = String(id); renderApp(); },
Â  Â  startEditProject: (id) => {Â 
Â  Â  Â  Â  const p = state.projects.find(pr => String(pr.id) === String(id));
Â  Â  Â  Â  if(p) { state.ui.editingProjectId = id; state.ui.editingProjectName = p.name; renderApp(); }
Â  Â  },
Â  Â  saveProjectName: (id) => {
Â  Â  Â  Â  const input = document.getElementById(`proj-name-input-${id}`);
Â  Â  Â  Â  const p = state.projects.find(pr => String(pr.id) === String(id));
Â  Â  Â  Â  if(p && input && input.value.trim()) { p.name = input.value.trim(); api.saveMetadata('update', 'project', {id:p.id, name:p.name, relatedId:p.workspaceId, attributes:{color:p.color}}); }
Â  Â  Â  Â  state.ui.editingProjectId = null; renderApp();
Â  Â  },
Â  Â  deleteProject: (id) => {
Â  Â  Â  Â  state.projects = state.projects.filter(p => String(p.id) !== String(id));
Â  Â  Â  Â  renderApp();
Â  Â  Â  Â  api.saveMetadata('delete', 'project', {id});
Â  Â  },

Â  Â  // GROUPS
Â  Â  addGroup: () => {
Â  Â  Â  const id = String(uid());
Â  Â  Â  const newGroup = { id, name: 'New Group', projectId: state.selectedProject, collapsed: false, columns: [] };
Â  Â  Â  state.groups.push(newGroup);
Â  Â  Â  renderApp();
Â  Â  Â  api.saveMetadata('create', 'group', { name: newGroup.name, relatedId: newGroup.projectId, attributes: { collapsed: false, columns: [] } });
Â  Â  },
Â  Â  startEditGroup: (id) => {Â 
Â  Â  Â  Â  const g = state.groups.find(gr => String(gr.id) === String(id));
Â  Â  Â  Â  if(g) { state.ui.editingGroupId = id; state.ui.editingGroupName = g.name; renderApp(); }
Â  Â  },
Â  Â  saveGroupName: (id) => {
Â  Â  Â  Â  const input = document.getElementById(`group-name-input-${id}`);
Â  Â  Â  Â  const g = state.groups.find(gr => String(gr.id) === String(id));
Â  Â  Â  Â  if(g && input && input.value.trim()) { g.name = input.value.trim(); api.saveMetadata('update', 'group', {id:g.id, name:g.name, relatedId:g.projectId, attributes:{collapsed:g.collapsed, columns:g.columns}}); }
Â  Â  Â  Â  state.ui.editingGroupId = null; renderApp();
Â  Â  },
Â  Â  toggleGroupCollapse: (id) => {
Â  Â  Â  Â  const g = state.groups.find(gr => String(gr.id) === String(id));
Â  Â  Â  Â  if(g) { g.collapsed = !g.collapsed; renderApp(); api.saveMetadata('update', 'group', {id: g.id, name: g.name, relatedId: g.projectId, attributes: {collapsed: g.collapsed, columns: g.columns}}); }
Â  Â  },
Â  Â  deleteGroup: (id) => {
Â  Â  Â  Â  state.groups = state.groups.filter(g => String(g.id) !== String(id));
Â  Â  Â  Â  renderApp();
Â  Â  Â  Â  api.saveMetadata('delete', 'group', {id});
Â  Â  },

Â  Â  // TASKS
Â  Â  setShowNewTask: (groupId) => {
Â  Â  Â  const grp = state.groups.find(g => String(g.id) === String(groupId));
Â  Â  Â  state.ui.showNewTask = groupId;
Â  Â  Â  state.ui.newTask = { name: '', assignee: null, priority: 'Medium', status: grp ? grp.name : 'Not Started', dueDate: '', customFields: {} };
Â  Â  Â  renderApp();
Â  Â  },
Â  Â  submitTask: (groupId) => {
Â  Â  Â  const input = document.getElementById(`new-task-name-${groupId}`);
Â  Â  Â  if (input) state.ui.newTask.name = input.value;
Â  Â  Â  api.createTask(groupId);
Â  Â  },
Â  Â  deleteTask: (id) => api.deleteTask(id),
Â  Â Â 
Â  Â  startEditTaskName: (id) => { state.ui.editingTaskId = id; renderApp(); setTimeout(()=>document.getElementById(`task-name-input-${id}`)?.focus(), 50); },
Â  Â  saveTaskName: (id) => {
Â  Â  Â  Â  const input = document.getElementById(`task-name-input-${id}`);
Â  Â  Â  Â  const t = state.tasks.find(task => String(task.id) === String(id));
Â  Â  Â  Â  if(t && input && input.value.trim()) { t.name = input.value.trim(); api.updateTask(t); }
Â  Â  Â  Â  state.ui.editingTaskId = null; renderApp();
Â  Â  },
Â  Â  updateTaskField: (id, field, value) => {
Â  Â  Â  Â  const t = state.tasks.find(task => String(task.id) === String(id));
Â  Â  Â  Â  if(t) {
Â  Â  Â  Â  Â  Â  if(field === 'assignee') t.assignee = value ? {name: value} : null;
Â  Â  Â  Â  Â  Â  else t[field] = value;
Â  Â  Â  Â  Â  Â  renderApp(); api.updateTask(t);
Â  Â  Â  Â  }
Â  Â  },
Â  Â  moveTaskToGroup: (id, groupId) => {
Â  Â  Â  const t = state.tasks.find(task => String(task.id) === String(id));
Â  Â  Â  if (!t) return;
Â  Â  Â  t.groupId = groupId;
Â  Â  Â  // Also update status string for safety
Â  Â  Â  if (groupId === 1) t.status = 'Not Started';
Â  Â  Â  if (groupId === 2) t.status = 'In Progress';
Â  Â  Â  if (groupId === 3) t.status = 'Done';
Â  Â  Â  renderApp();
Â  Â  Â  api.updateTask(t);
Â  Â  }
Â  };
Â  window.actions = actions;

Â  // ---------- RENDER FUNCTIONS ----------
Â  function renderSidebar() {
Â  Â  const { workspaces, selectedWorkspace, projects, selectedProject, ui } = state;
Â  Â  const isEditWS = (id) => String(ui.editingWorkspaceId) === String(id);
Â  Â  const isEditProj = (id) => String(ui.editingProjectId) === String(id);

Â  Â  return `
Â  Â  Â  <div class="w-72 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 flex flex-col h-full">
Â  Â  Â  Â  <div class="p-6 border-b dark:border-gray-800"><h1 class="font-bold text-xl dark:text-white">WellTask</h1></div>
Â  Â  Â  Â  <div class="p-4 flex-1 overflow-y-auto">
Â  Â  Â  Â  Â  Â <div class="mb-4 flex justify-between"><span class="text-xs font-bold text-gray-500">WORKSPACES</span><button onclick="actions.addWorkspace()" class="text-blue-500 text-xs">+ New</button></div>
Â  Â  Â  Â  Â  Â ${workspaces.map(w => `
Â  Â  Â  Â  Â  Â  Â <div class="flex items-center justify-between p-2 rounded cursor-pointer ${String(w.id)===String(selectedWorkspace)?'bg-blue-100 text-blue-700': 'text-gray-700 dark:text-gray-300'}" onclick="actions.selectWorkspace('${w.id}')">
Â  Â  Â  Â  Â  Â  Â  Â ${isEditWS(w.id)Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â ? `<input id="ws-name-input-${w.id}" value="${w.name}" onblur="actions.saveWorkspaceName('${w.id}')" onkeypress="if(event.key==='Enter') actions.saveWorkspaceName('${w.id}')" class="bg-transparent border-b w-full" autofocus>`
Â  Â  Â  Â  Â  Â  Â  Â  Â : `<span>${w.name}</span>`
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â <div class="flex gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="event.stopPropagation(); actions.startEditWorkspace('${w.id}')"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="event.stopPropagation(); actions.deleteWorkspace('${w.id}')"><i data-lucide="trash-2" class="w-3 h-3 text-red-500"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â `).join('')}
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â <div class="mt-6 mb-4 flex justify-between"><span class="text-xs font-bold text-gray-500">PROJECTS</span><button onclick="actions.addProject()" class="text-blue-500 text-xs">+ New</button></div>
Â  Â  Â  Â  Â  Â ${projects.filter(p=>String(p.workspaceId)===String(selectedWorkspace)).map(p => `
Â  Â  Â  Â  Â  Â  Â <div class="flex items-center justify-between p-2 rounded cursor-pointer ${String(p.id)===String(selectedProject)?'bg-blue-100 text-blue-700': 'text-gray-700 dark:text-gray-300'}" onclick="actions.selectProject('${p.id}')">
Â  Â  Â  Â  Â  Â  Â  Â ${isEditProj(p.id)Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â ? `<input id="proj-name-input-${p.id}" value="${p.name}" onblur="actions.saveProjectName('${p.id}')" onkeypress="if(event.key==='Enter') actions.saveProjectName('${p.id}')" class="bg-transparent border-b w-full" autofocus>`
Â  Â  Â  Â  Â  Â  Â  Â  Â : `<span>${p.name}</span>`
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â <div class="flex gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="event.stopPropagation(); actions.startEditProject('${p.id}')"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="event.stopPropagation(); actions.deleteProject('${p.id}')"><i data-lucide="trash-2" class="w-3 h-3 text-red-500"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â `).join('')}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="p-4 border-t dark:border-gray-800"><button onclick="actions.toggleTheme()" class="w-full flex justify-between p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 dark:text-white"><span>Theme</span><i data-lucide="${state.darkMode ? 'sun' : 'moon'}" class="w-4 h-4"></i></button></div>
Â  Â  Â  </div>
Â  Â  `;
Â  }

Â  function renderKanbanView() {
Â  Â  const { groups, tasks, selectedProject, ui } = state;
Â  Â  const projectGroups = groups.filter(g => String(g.projectId) === String(selectedProject));
Â  Â Â 
Â  Â  return `
Â  Â  Â  <div class="flex h-full p-6 space-x-4 overflow-x-auto bg-gray-50 dark:bg-gray-900">
Â  Â  Â  Â  ${projectGroups.map(grp => {
Â  Â  Â  Â  Â  Â  const grpTasks = tasks.filter(t => String(t.groupId) === String(grp.id));
Â  Â  Â  Â  Â  Â  const isEditGrp = String(ui.editingGroupId) === String(grp.id);
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div class="w-80 flex-shrink-0 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-col max-h-full">
Â  Â  Â  Â  Â  Â  Â  Â <div class="p-3 border-b dark:border-gray-700 flex justify-between items-center font-semibold dark:text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${isEditGrp
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ? `<input id="group-name-input-${grp.id}" value="${grp.name}" onblur="actions.saveGroupName('${grp.id}')" onkeypress="if(event.key==='Enter') actions.saveGroupName('${grp.id}')" class="bg-transparent border-b w-32" autofocus>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : `<span>${grp.name}</span>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-xs text-gray-400">(${grpTasks.length})</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex gap-1 text-gray-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="actions.startEditGroup('${grp.id}')"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="actions.deleteGroup('${grp.id}')"><i data-lucide="trash-2" class="w-3 h-3 hover:text-red-500"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â <div class="flex-1 overflow-y-auto p-3 space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â ${grpTasks.map(t => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="p-3 bg-white dark:bg-gray-700 border dark:border-gray-600 rounded shadow-sm hover:shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${String(ui.editingTaskId)===String(t.id)Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ? `<input id="task-name-input-${t.id}" value="${t.name}" onblur="actions.saveTaskName('${t.id}')" onkeypress="if(event.key==='Enter') actions.saveTaskName('${t.id}')" class="w-full bg-transparent border-b" autofocus>`Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : `<div class="font-medium dark:text-white cursor-pointer" onclick="actions.startEditTaskName('${t.id}')">${t.name}</div>`}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="mt-2 flex justify-between items-center text-xs text-gray-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select onchange="actions.moveTaskToGroup('${t.id}', '${grp.id}')" class="bg-transparent"><option>${t.priority}</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="actions.deleteTask('${t.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â  Â  Â <div class="p-3 border-t dark:border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â ${String(ui.showNewTask)===String(grp.id)Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ? `<div class="space-y-2"><input id="new-task-name-${grp.id}" class="w-full border p-1 rounded text-sm dark:bg-gray-700 dark:text-white" placeholder="Name..." autofocus onkeypress="if(event.key==='Enter') actions.submitTask('${grp.id}')"><button onclick="actions.submitTask('${grp.id}')" class="w-full bg-green-500 text-white text-sm rounded py-1">Add</button></div>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : `<button onclick="actions.setShowNewTask('${grp.id}')" class="w-full text-blue-500 text-sm py-1 border border-dashed border-blue-300 rounded hover:bg-blue-50">+ Add Task</button>`}
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  <button onclick="actions.addGroup()" class="w-80 h-12 flex-shrink-0 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center text-gray-500 hover:border-blue-400 hover:text-blue-500 gap-2"><i data-lucide="plus"></i> Add Group</button>
Â  Â  Â  </div>
Â  Â  `;
Â  }

Â  function renderApp() {
Â  Â  const app = document.getElementById('app');
Â  Â  if (state.showLogin) { app.innerHTML = `<div class="h-screen flex items-center justify-center text-gray-500">Access via Zoho Cliq</div>`; return; }
Â  Â  document.documentElement.classList.toggle('dark', state.darkMode);
Â  Â  app.innerHTML = `<div class="flex h-screen overflow-hidden">${renderSidebar()}<div class="flex-1 overflow-hidden">${renderKanbanView()}</div></div>`;
Â  Â  lucide.createIcons();
Â  }

Â  if (state.currentUser) api.syncAll();
Â  renderApp();
</script>
</body>
</html>
