<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WellTask</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: { gray: { 750: "#2d3748" } }
        }
      }
    };
  </script>

  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <script>
    // âœ… FIREBASE CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyCaVEmWvh0_hcxFJQG00QAXNxRsIMpgy94",
      authDomain: "welltask-8bbcf.firebaseapp.com",
      projectId: "welltask-8bbcf",
      storageBucket: "welltask-8bbcf.firebasestorage.app",
      messagingSenderId: "533119656804",
      appId: "1:533119656804:web:ec296e70c7b7e5746c1071",
      measurementId: "G-3HD74YPC52"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    console.log("ðŸ”¥ Firebase initialized.");
  </script>
</head>

<body class="bg-gray-50 text-gray-800 transition-colors duration-200">
  <div id="app"></div>

  <script>
    // ======================================================
    // ðŸ”’ 1. SECURITY & AUTHENTICATION
    // ======================================================
    
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");
    const mode = urlParams.get("mode") || "personal"; 
    // Handle empty channelId string from Zoho
    const rawChannelId = urlParams.get("channelId");
    const channelId = (rawChannelId && rawChannelId.trim() !== "") ? rawChannelId : null;

    let currentUser = null;
    let currentBoardId = null; 

    // Decode Token
    if (token) {
      try {
        const decoded = atob(token);
        const parts = decoded.split("::");
        if (parts.length >= 3) {
          currentUser = {
            email: parts[0],
            id: parts[1],
            name: parts[2]
          };
          console.log("ðŸ”’ Identity Verified:", currentUser.email);
        }
      } catch (e) {
        console.error("Auth Token Error", e);
      }
    }

    // THE AUTHENTICATION WINDOW
    if (!currentUser) {
        document.body.innerHTML = `
            <div class="h-screen flex flex-col items-center justify-center bg-red-50 text-red-900 font-sans">
                <i data-lucide="shield-alert" class="w-16 h-16 mb-4 text-red-600"></i>
                <h1 class="text-2xl font-bold mb-2">Authentication Failed</h1>
                <p class="text-gray-600">Please open WellTask from within Zoho Cliq.</p>
            </div>`;
        lucide.createIcons();
        throw new Error("No Identity");
    }

    const uid = () => Date.now().toString() + Math.floor(Math.random() * 1000);

    // ======================================================
    // ðŸ’¾ 2. SECURE FIREBASE LOGIC
    // ======================================================

    async function firebaseSecureLoad() {
        try {
            console.log(`ðŸ” [SECURE LOAD] Mode: ${mode} | Channel: ${channelId || 'N/A'}`);
            
            // SECURITY CHECK: Must be in 'allowed_users'
            let q = db.collection("boards")
                      .where("allowed_users", "array-contains", currentUser.email);

            // CONTEXT CHECK
            if (mode === "team" && channelId) {
                console.log("ðŸ‘¥ TEAM MODE DETECTED");
                q = q.where("channel_id", "==", channelId);
                q = q.where("board_type", "==", "team");
            } else {
                console.log("ðŸ‘¤ PERSONAL MODE DETECTED");
                q = q.where("board_type", "==", "personal");
            }

            const snap = await q.get();

            if (!snap.empty) {
                const doc = snap.docs[0];
                console.log("âœ… Secure Access Granted. Board ID:", doc.id);
                currentBoardId = doc.id;
                return doc.data();
            } else {
                console.log("âš ï¸ No board found. Triggering creation.");
                return null; 
            }
        } catch (e) {
            console.error("ðŸ’¥ Query Error:", e);
            if(e.message.includes("requires an index")) {
                // ALERT for Personal Mode Index creation
                alert("DEV NOTE: Open Console (F12) -> Click the Firebase Index Link!");
            }
            return null;
        }
    }

    async function firebaseSaveBoard(docId, payload) {
        if (!docId) return;
        try {
            await db.collection("boards").doc(docId).set({ 
                ...payload, 
                updatedAt: Date.now() 
            }, { merge: true });
        } catch(e) { console.error("Save Error:", e); }
    }

    // ======================================================
    // ðŸ§  3. STATE & API
    // ======================================================
    const initialState = {
      darkMode: false,
      currentUser,
      isLoading: true, 
      saveStatus: "saved",
      currentView: "list",
      workspaces: [], selectedWorkspace: null, projects: [],
      selectedProject: null, groups: [], tasks: [],
      ui: { showNewTask: null, newTask: {}, columnsGroupId: null, editingWorkspaceId: null, editingWorkspaceName: "", editingProjectId: null, editingProjectName: "", editingTaskId: null, editingGroupId: null, editingGroupName: "", editingColumnGroupId: null, editingColumnId: null }
    };

    let state = { ...initialState };

    const api = {
      saveTimer: null,
      
      load: async () => {
        renderApp();
        const fbData = await firebaseSecureLoad();

        if (fbData) {
            applyLoadedState(fbData);
        } else {
            // Auto-Create if missing
            await api.initSecureDefaults();
        }

        state.isLoading = false;
        renderApp();
      },

      initSecureDefaults: async () => {
        console.log("ðŸš€ Initializing new Secure Board...");
        const newDocId = uid(); 
        currentBoardId = newDocId;

        const wsId = uid(); const pId = uid(); 
        const g1 = uid(); const g2 = uid(); const g3 = uid();
        const defaultColumns = [{id:"task",name:"Task",isDefault:true},{id:"assignee",name:"Assignee",isDefault:true},{id:"priority",name:"Priority",isDefault:true},{id:"status",name:"Status",isDefault:true},{id:"duedate",name:"Due Date",isDefault:true}];

        const isTeam = (mode === "team");
        const boardName = isTeam ? "Team Tasks" : "My Personal Tasks";
        const wsName = isTeam ? "Team Workspace" : "My Workspace";

        const payload = {
            boardid: newDocId,
            allowed_users: [currentUser.email], 
            board_type: mode, 
            channel_id: channelId || null,
            owner_email: currentUser.email,
            name: boardName,
            darkMode: false, currentView: "list",
            workspaces: [{ id: wsId, name: wsName }],
            projects: [{ id: pId, name: "General Project", color: "bg-blue-500", workspaceId: wsId }],
            groups: [
                { id: g1, name: "To Do", projectId: pId, collapsed: false, columns: JSON.parse(JSON.stringify(defaultColumns)) },
                { id: g2, name: "In Progress", projectId: pId, collapsed: false, columns: JSON.parse(JSON.stringify(defaultColumns)) },
                { id: g3, name: "Done", projectId: pId, collapsed: false, columns: JSON.parse(JSON.stringify(defaultColumns)) }
            ],
            tasks: []
        };

        await firebaseSaveBoard(newDocId, payload);
        applyLoadedState(payload);
      },

      triggerSave: () => {
        if (api.saveTimer) clearTimeout(api.saveTimer);
        state.saveStatus = "pending";
        renderStatusIndicator();
        api.saveTimer = setTimeout(api.performSave, 1500);
      },

      performSave: async () => {
        if (!currentBoardId) return;
        try {
          state.saveStatus = "saving";
          renderStatusIndicator();
          const payload = { darkMode: state.darkMode, currentView: state.currentView, workspaces: state.workspaces, projects: state.projects, groups: state.groups, tasks: state.tasks };
          await firebaseSaveBoard(currentBoardId, payload);
          state.saveStatus = "saved";
        } catch (e) { state.saveStatus = "error"; } finally { renderStatusIndicator(); }
      }
    };

    function applyLoadedState(parsed) {
        state.workspaces = parsed.workspaces || []; state.projects = parsed.projects || [];
        state.groups = parsed.groups || []; state.tasks = parsed.tasks || [];
        state.currentView = parsed.currentView || "list"; state.darkMode = !!parsed.darkMode;
        if (state.workspaces.length > 0) state.selectedWorkspace = state.workspaces[0].id;
        if (state.projects.length > 0) { const proj = state.projects.find(p => p.workspaceId === state.selectedWorkspace); state.selectedProject = (proj && proj.id) || state.projects[0].id; }
    }

    // ======================================================
    // âš¡ 5. ACTIONS
    // ======================================================
    const actions = {
      toggleTheme: () => { state.darkMode = !state.darkMode; renderApp(); api.triggerSave(); },
      setView: (view) => { state.currentView = view; renderApp(); api.triggerSave(); },
      selectWorkspace: (id) => { state.selectedWorkspace = id; const p = state.projects.find(x=>x.workspaceId===id); state.selectedProject = p?p.id:null; renderApp(); },
      addWorkspace: () => { const id=uid(); state.workspaces.push({id,name:"New Workspace"}); state.selectedWorkspace=id; renderApp(); api.triggerSave(); },
      startEditWorkspace: (id) => { const w=state.workspaces.find(x=>x.id===id); if(w){ state.ui.editingWorkspaceId=id; state.ui.editingWorkspaceName=w.name; renderApp(); } },
      saveWorkspaceName: (id) => { const el=document.getElementById(`ws-name-input-${id}`); const w=state.workspaces.find(x=>x.id===id); if(w&&el){ w.name=el.value; api.triggerSave(); } state.ui.editingWorkspaceId=null; renderApp(); },
      deleteWorkspace: (id) => { if(state.workspaces.length<=1)return alert("Keep at least one workspace."); state.workspaces=state.workspaces.filter(x=>x.id!==id); if(state.selectedWorkspace===id)state.selectedWorkspace=state.workspaces[0].id; state.projects=state.projects.filter(x=>x.workspaceId!==id); renderApp(); api.triggerSave(); },
      addProject: () => { if(!state.selectedWorkspace)return; const id=uid(); state.projects.push({id,name:"New Project",color:"bg-green-500",workspaceId:state.selectedWorkspace}); state.selectedProject=id; const g1=uid(); state.groups.push({id:g1,name:"To Do",projectId:id,collapsed:false,columns:[{id:"task",name:"Task",isDefault:true},{id:"assignee",name:"Assignee",isDefault:true},{id:"priority",name:"Priority",isDefault:true},{id:"status",name:"Status",isDefault:true},{id:"duedate",name:"Due Date",isDefault:true}]}); renderApp(); api.triggerSave(); },
      selectProject: (id) => { state.selectedProject=id; renderApp(); },
      startEditProject: (id) => { const p=state.projects.find(x=>x.id===id); if(p){ state.ui.editingProjectId=id; state.ui.editingProjectName=p.name; renderApp(); } },
      saveProjectName: (id) => { const el=document.getElementById(`proj-name-input-${id}`); const p=state.projects.find(x=>x.id===id); if(p&&el){ p.name=el.value; api.triggerSave(); } state.ui.editingProjectId=null; renderApp(); },
      deleteProject: (id) => { if(!confirm("Delete Project?"))return; state.projects=state.projects.filter(x=>x.id!==id); state.groups=state.groups.filter(x=>x.projectId!==id); state.tasks=state.tasks.filter(x=>x.projectId!==id); state.selectedProject=state.projects[0]?.id||null; renderApp(); api.triggerSave(); },
      toggleGroupCollapse: (id) => { const g=state.groups.find(x=>x.id===id); if(g){ g.collapsed=!g.collapsed; renderApp(); api.triggerSave(); } },
      addGroup: () => { if(!state.selectedProject)return; const base=state.groups.find(x=>x.projectId===state.selectedProject); state.groups.push({id:uid(),name:"New Group",projectId:state.selectedProject,collapsed:false,columns:base?JSON.parse(JSON.stringify(base.columns)):[]}); renderApp(); api.triggerSave(); },
      startEditGroup: (id) => { const g=state.groups.find(x=>x.id===id); if(g){ state.ui.editingGroupId=id; state.ui.editingGroupName=g.name; renderApp(); } },
      saveGroupName: (id) => { const el=document.getElementById(`group-name-input-${id}`); const g=state.groups.find(x=>x.id===id); if(g&&el){ g.name=el.value; api.triggerSave(); } state.ui.editingGroupId=null; renderApp(); },
      deleteGroup: (id) => { if(!confirm("Delete group?"))return; state.groups=state.groups.filter(x=>x.id!==id); renderApp(); api.triggerSave(); },
      toggleColumnsPanel: (id) => { state.ui.columnsGroupId=state.ui.columnsGroupId===id?null:id; renderApp(); },
      addColumn: (gid) => { const g=state.groups.find(x=>x.id===gid); if(g){ g.columns.push({id:"col_"+uid(),name:"New Column",isDefault:false}); renderApp(); api.triggerSave(); } },
      deleteColumn: (gid,cid) => { const g=state.groups.find(x=>x.id===gid); if(g){ g.columns=g.columns.filter(x=>x.id!==cid); renderApp(); api.triggerSave(); } },
      startEditColumn: (gid,cid) => { state.ui.editingColumnGroupId=gid; state.ui.editingColumnId=cid; renderApp(); setTimeout(()=>{document.getElementById(`col-name-input-${gid}-${cid}`)?.focus()},50); },
      saveColumnName: (gid,cid) => { const el=document.getElementById(`col-name-input-${gid}-${cid}`); const g=state.groups.find(x=>x.id===gid); if(g&&el){ const c=g.columns.find(x=>x.id===cid); if(c){ c.name=el.value; api.triggerSave(); } } state.ui.editingColumnGroupId=null; state.ui.editingColumnId=null; renderApp(); },
      setShowNewTask: (gid) => { state.ui.showNewTask=gid; renderApp(); },
      submitTask: (gid) => { const el=document.getElementById(`new-task-name-${gid}`); if(!el||!el.value.trim())return; state.tasks.push({id:uid(),name:el.value.trim(),groupId:gid,projectId:state.selectedProject,priority:"Medium",status:"Not Started",assignee:null,dueDate:"",customFields:{}}); state.ui.showNewTask=null; renderApp(); api.triggerSave(); },
      startEditTaskName: (id) => { state.ui.editingTaskId=id; renderApp(); setTimeout(()=>{document.getElementById(`task-name-input-${id}`)?.focus()},10); },
      saveTaskName: (id) => { const el=document.getElementById(`task-name-input-${id}`); const t=state.tasks.find(x=>x.id===id); if(t&&el){ t.name=el.value.trim(); api.triggerSave(); } state.ui.editingTaskId=null; renderApp(); },
      updateTaskField: (id,f,v,ex) => { const t=state.tasks.find(x=>x.id===id); if(!t)return; if(f==="assignee")t.assignee=v?{name:v}:null; else if(f==="custom"){if(!t.customFields)t.customFields={};t.customFields[ex]=v;} else t[f]=v; renderApp(); api.triggerSave(); },
      deleteTask: (id) => { state.tasks=state.tasks.filter(x=>x.id!==id); renderApp(); api.triggerSave(); }
    };
    window.actions = actions;

    // ======================================================
    // ðŸŽ¨ 6. RENDERING FUNCTIONS (MOVED TO GLOBAL SCOPE)
    // ======================================================
    
    function priorityClass(p) { 
        return p==="Critical"?"bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300":p==="High"?"bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-300":p==="Medium"?"bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-200":p==="Low"?"bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300":"bg-gray-100 text-gray-800 dark:bg-gray-500/20 dark:text-gray-200"; 
    }
    
    function renderStatusIndicator() {
      const el = document.getElementById("save-status"); if(!el) return;
      el.innerHTML = state.saveStatus==="saving" ? '<span class="text-blue-500">Saving...</span>' : state.saveStatus==="error" ? '<span class="text-red-500">Error</span>' : state.saveStatus==="pending" ? '...' : '<span class="text-green-500">Saved</span>';
    }

    // DEFINED GLOBALLY TO FIX REFERENCE ERROR
    function renderCellForColumn(task, col) {
      if (col.id === 'task') {
        return state.ui.editingTaskId === task.id
          ? `<input id="task-name-input-${task.id}" class="w-full bg-white dark:bg-gray-700 border border-blue-400 rounded px-2 py-1" value="${task.name}" onblur="actions.saveTaskName('${task.id}')" onkeydown="if(event.key==='Enter') actions.saveTaskName('${task.id}')" />`
          : `<span class="cursor-text hover:text-blue-600 dark:hover:text-blue-400" onclick="actions.startEditTaskName('${task.id}')">${task.name}</span>`;
      }
      if (col.id === 'priority') {
        const p = task.priority || 'Medium';
        return `
          <select onchange="actions.updateTaskField('${task.id}', 'priority', this.value)" 
                  class="text-xs border-0 bg-transparent rounded px-1.5 py-0.5 cursor-pointer ${priorityClass(p)}">
            <option value="Low" ${p==='Low'?'selected':''}>Low</option>
            <option value="Medium" ${p==='Medium'?'selected':''}>Medium</option>
            <option value="High" ${p==='High'?'selected':''}>High</option>
            <option value="Critical" ${p==='Critical'?'selected':''}>Critical</option>
          </select>`;
      }
      if (col.id === 'status') {
         return `
           <select onchange="actions.updateTaskField('${task.id}', 'status', this.value)" class="bg-transparent text-xs border border-gray-200 dark:border-gray-600 rounded px-1">
             <option value="Not Started" ${task.status==='Not Started'?'selected':''}>Not Started</option>
             <option value="In Progress" ${task.status==='In Progress'?'selected':''}>In Progress</option>
             <option value="Done" ${task.status==='Done'?'selected':''}>Done</option>
             <option value="Stuck" ${task.status==='Stuck'?'selected':''}>Stuck</option>
           </select>
         `;
      }
      if (col.id === 'assignee') {
         return `<input type="text" placeholder="Unassigned" class="bg-transparent w-full text-xs focus:outline-none" value="${task.assignee?.name || ''}" onchange="actions.updateTaskField('${task.id}', 'assignee', this.value)" />`;
      }
      if (col.id === 'duedate') {
         return `<input type="date" class="bg-transparent text-xs text-gray-500 dark:text-gray-400 focus:outline-none" value="${task.dueDate||''}" onchange="actions.updateTaskField('${task.id}', 'dueDate', this.value)" />`;
      }
      const val = (task.customFields && task.customFields[col.id]) || "";
      return `<input type="text" class="bg-transparent w-full text-xs focus:outline-none text-gray-600 dark:text-gray-300" value="${val}" onchange="actions.updateTaskField('${task.id}', 'custom', this.value, '${col.id}')" />`;
    }

    function renderColumnsPanel(group) {
      return `
        <div class="absolute right-0 top-6 w-48 bg-white dark:bg-gray-800 shadow-xl rounded-lg border dark:border-gray-700 z-10 p-2">
           <div class="text-xs font-bold text-gray-500 mb-2">ADD COLUMNS</div>
           <button onclick="actions.addColumn('${group.id}')" class="w-full text-left px-2 py-1 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-blue-500">+ Custom Text</button>
        </div>
      `;
    }
    
    function renderSidebar() {
      const activeWs = state.workspaces.find(w => w.id === state.selectedWorkspace);
      const wsProjects = state.projects.filter(p => p.workspaceId === state.selectedWorkspace);
      return `
        <div class="w-64 border-r dark:border-gray-700 bg-white dark:bg-gray-800 flex flex-col h-full">
          <div class="p-4 border-b flex justify-between dark:border-gray-700">
             <div class="font-bold text-gray-700 dark:text-gray-100">WellTask</div>
             <div id="save-status" class="text-xs"></div>
          </div>
          <div class="px-4 py-2 text-xs font-mono bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 border-b dark:border-gray-600">
             ${mode === 'team' ? 'ðŸ‘¥ Team Mode' : 'ðŸ‘¤ Personal Mode'}
          </div>

          <div class="p-3 flex-1 overflow-y-auto">
             <div class="mb-4">
                <div class="text-xs font-bold text-gray-400 mb-2">WORKSPACE</div>
                <div class="relative group">
                   ${state.ui.editingWorkspaceId === state.selectedWorkspace 
                     ? `<div class="flex items-center gap-1"><input id="ws-name-input-${state.selectedWorkspace}" class="w-full px-2 py-1 text-sm border rounded dark:bg-gray-700" value="${state.ui.editingWorkspaceName}" /><button onclick="actions.saveWorkspaceName('${state.selectedWorkspace}')" class="text-green-600">âœ“</button></div>`
                     : `<div class="flex justify-between p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" onclick="actions.startEditWorkspace('${state.selectedWorkspace}')"><span>${activeWs?.name || 'Loading...'}</span></div>`
                   }
                </div>
                <div class="mt-2 space-y-1">
                   ${state.workspaces.map(w => `<div onclick="actions.selectWorkspace('${w.id}')" class="p-2 rounded cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${w.id===state.selectedWorkspace?'bg-blue-50 text-blue-600':''}">${w.name}</div>`).join('')}
                   <button onclick="actions.addWorkspace()" class="w-full text-left text-xs text-blue-500 mt-1 px-2">+ New Workspace</button>
                </div>
             </div>
             <div>
                <div class="text-xs font-bold text-gray-400 mb-2 flex justify-between">PROJECTS <button onclick="actions.addProject()">+</button></div>
                ${wsProjects.map(p => `
                   <div class="group flex justify-between p-2 rounded cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${p.id===state.selectedProject?'bg-blue-50 text-blue-600':''}" onclick="actions.selectProject('${p.id}')">
                      <div class="flex gap-2 truncate">
                         <span class="w-2 h-2 rounded-full ${p.color||'bg-gray-400'}"></span>
                         ${state.ui.editingProjectId===p.id 
                           ? `<input id="proj-name-input-${p.id}" class="w-24 px-1 py-0.5 text-xs border" value="${state.ui.editingProjectName}" onclick="event.stopPropagation()" onblur="actions.saveProjectName('${p.id}')" />`
                           : `<span ondblclick="event.stopPropagation(); actions.startEditProject('${p.id}')">${p.name}</span>`}
                      </div>
                      <div class="hidden group-hover:flex gap-1">
                         <i data-lucide="edit-2" class="w-3 h-3 text-gray-400 hover:text-blue-500" onclick="event.stopPropagation(); actions.startEditProject('${p.id}')"></i>
                         <i data-lucide="trash" class="w-3 h-3 text-gray-400 hover:text-red-500" onclick="event.stopPropagation(); actions.deleteProject('${p.id}')"></i>
                      </div>
                   </div>
                `).join('')}
             </div>
          </div>
          <div class="p-4 border-t dark:border-gray-700">
             <button onclick="actions.toggleTheme()" class="text-xs text-gray-500">Toggle Theme</button>
          </div>
        </div>`;
    }

    function renderListView() {
      if(!state.selectedProject) return `<div class="p-10">Select a project</div>`;
      const groups = state.groups.filter(g => g.projectId === state.selectedProject);
      const proj = state.projects.find(p => p.id === state.selectedProject);
      
      return `
        <div class="h-full flex flex-col bg-white dark:bg-gray-900">
           <div class="px-6 py-4 border-b flex justify-between dark:border-gray-700">
              <h1 class="text-xl font-bold dark:text-white">${proj?.name}</h1>
              <div><button onclick="actions.setView('kanban')" class="text-sm bg-gray-100 px-2 py-1 rounded">Kanban</button></div>
           </div>
           <div class="flex-1 overflow-y-auto p-6">
              ${groups.map(g => {
                  const tasks = state.tasks.filter(t => t.groupId === g.id);
                  return `
                    <div class="mb-8">
                       <div class="flex items-center gap-2 mb-2 group">
                          <button onclick="actions.toggleGroupCollapse('${g.id}')" class="p-1"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>
                          ${state.ui.editingGroupId===g.id 
                            ? `<input id="group-name-input-${g.id}" value="${state.ui.editingGroupName}" class="border px-1" onblur="actions.saveGroupName('${g.id}')" />`
                            : `<h2 class="font-bold cursor-pointer" ondblclick="actions.startEditGroup('${g.id}')">${g.name}</h2>`
                          }
                          <span class="text-xs bg-gray-100 px-2 rounded">${tasks.length}</span>
                          <div class="relative ml-auto">
                             <button onclick="actions.toggleColumnsPanel('${g.id}')" class="text-xs text-blue-500">+ Col</button>
                             ${state.ui.columnsGroupId===g.id ? renderColumnsPanel(g) : ''}
                          </div>
                          <button onclick="actions.deleteGroup('${g.id}')" class="opacity-0 group-hover:opacity-100 text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                       </div>
                       ${!g.collapsed ? `
                       <div class="border rounded dark:border-gray-700 overflow-x-auto">
                          <table class="w-full text-left">
                             <thead class="bg-gray-50 dark:bg-gray-800 text-xs">
                                <tr>
                                   <th class="w-8"></th>
                                   ${g.columns.map(c => `
                                      <th class="p-2 border-r dark:border-gray-700 font-normal">
                                         ${state.ui.editingColumnGroupId===g.id && state.ui.editingColumnId===c.id 
                                           ? `<input id="col-name-input-${g.id}-${c.id}" value="${c.name}" class="w-full" onblur="actions.saveColumnName('${g.id}','${c.id}')" />`
                                           : `<span ondblclick="actions.startEditColumn('${g.id}','${c.id}')">${c.name}</span>`
                                         }
                                      </th>
                                   `).join('')}
                                </tr>
                             </thead>
                             <tbody class="text-sm dark:text-gray-300 divide-y dark:divide-gray-700">
                                ${tasks.map(t => `
                                   <tr class="group/row hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                      <td class="p-2 text-center text-gray-300">::</td>
                                      ${g.columns.map(c => `<td class="p-2 border-r dark:border-gray-700">${renderCellForColumn(t,c)}</td>`).join('')}
                                      <td class="p-2"><button onclick="actions.deleteTask('${t.id}')" class="opacity-0 group-hover/row:opacity-100 text-red-500"><i data-lucide="trash" class="w-3 h-3"></i></button></td>
                                   </tr>
                                `).join('')}
                                ${state.ui.showNewTask===g.id ? `
                                   <tr>
                                      <td></td>
                                      <td colspan="${g.columns.length}"><div class="flex gap-2 p-2"><input id="new-task-name-${g.id}" class="border w-full" autofocus /><button onclick="actions.submitTask('${g.id}')">Add</button></div></td>
                                   </tr>` 
                                   : `<tr><td colspan="${g.columns.length+1}" class="p-2"><button onclick="actions.setShowNewTask('${g.id}')" class="text-gray-400 text-xs">+ Add Task</button></td></tr>`
                                }
                             </tbody>
                          </table>
                       </div>` : ''}
                    </div>`;
              }).join('')}
              <button onclick="actions.addGroup()" class="w-full py-2 border-2 border-dashed text-gray-400 hover:border-blue-500 hover:text-blue-500">+ Add Group</button>
           </div>
        </div>`;
    }

    function renderKanbanView() {
        const projectGroups = state.groups.filter(g => g.projectId === state.selectedProject);
        return `
        <div class="h-full flex flex-col bg-gray-50 dark:bg-gray-900">
           <div class="px-6 py-4 border-b flex justify-between dark:border-gray-700">
              <h1 class="text-xl font-bold dark:text-white">Kanban View</h1>
              <div><button onclick="actions.setView('list')" class="text-sm bg-gray-100 px-2 py-1 rounded">List</button></div>
           </div>
           <div class="flex-1 overflow-x-auto p-6 flex gap-4">
              ${projectGroups.map(g => {
                  const tasks = state.tasks.filter(t => t.groupId === g.id);
                  return `<div class="w-72 bg-gray-100 dark:bg-gray-800 p-3 rounded-lg h-full overflow-y-auto">
                     <div class="font-bold mb-2 dark:text-white">${g.name}</div>
                     ${tasks.map(t => `<div class="bg-white dark:bg-gray-700 p-2 mb-2 rounded shadow text-sm dark:text-gray-200">${t.name}</div>`).join('')}
                  </div>`;
              }).join('')}
           </div>
        </div>`;
    }

    function renderApp() {
      const app = document.getElementById("app"); if(!app)return;
      document.documentElement.classList.toggle("dark", state.darkMode);
      const bg = state.darkMode ? "bg-gray-900" : "bg-gray-50";
      app.innerHTML = `<div class="flex h-screen ${bg} overflow-hidden font-sans relative">
         ${state.isLoading ? `<div class="absolute inset-0 bg-black/50 z-50 flex items-center justify-center text-white">Loading...</div>` : ''}
         ${renderSidebar()}
         <div class="flex-1 overflow-hidden">${state.currentView==="kanban"?renderKanbanView():renderListView()}</div>
      </div>`;
      renderStatusIndicator(); lucide.createIcons();
    }

    // ======================================================
    // ðŸš€ 7. BOOT
    // ======================================================
    api.load();

  </script>
</body>
</html>
