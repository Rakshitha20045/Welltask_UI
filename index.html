<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WellTask</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            gray: { 750: '#2d3748' }
          }
        }
      }
    }
  </script>

  <style>
    ::-webkit-scrollbar{width:8px;height:8px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:#cbd5e0;border-radius:4px;}
    .dark ::-webkit-scrollbar-thumb{background:#4a5568;}
  </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-200">
<div id="app"></div>

<script>
  // ðŸ”´ IMPORTANT: Point to your local Vercel Proxy
  const ZOHO_API_URL = "/api/proxy?";

  // ---------- Auth ----------
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  let currentUser = null;
  if (token) {
    try {
      const decoded = atob(token);
      const parts = decoded.split("::");
      if (parts.length === 2) {
        currentUser = {
          id: parts[1],
          name: parts[0].split('@')[0],
          email: parts[0],
          role: 'owner'
        };
      }
    } catch (e) {
      console.error("Auth Failed", e);
    }
  }

  const uid = () => Date.now() + Math.floor(Math.random() * 1000);

  // ---------- State ----------
  const initialState = {
    darkMode: false,
    currentView: 'list',
    currentUser,
    showLogin: !currentUser,

    // Default structure (will be overwritten by Database data)
    workspaces: [ { id: 1, name: 'My Workspace' } ],
    selectedWorkspace: 1,
    projects: [ { id: 1, name: 'Marketing Campaign', color: 'bg-purple-500', workspaceId: 1 } ],
    selectedProject: 1,
    groups: [
      { id: 1, name: 'To Do', projectId: 1, collapsed: false, columns: [] },
      { id: 2, name: 'In Progress', projectId: 1, collapsed: false, columns: [] },
      { id: 3, name: 'Done', projectId: 1, collapsed: false, columns: [] }
    ],
    tasks: [],

    ui: {
      showNewTask: null,
      newTask: { name: '', assignee: null, priority: 'Medium', status: 'Not Started', dueDate: '', customFields: {} },
      columnsGroupId: null,
      editingWorkspaceId: null, editingWorkspaceName: '',
      editingProjectId: null, editingProjectName: '',
      editingTaskId: null,
      editingGroupId: null, editingGroupName: ''
    }
  };

  let state = { ...initialState };

  // ---------- Helpers ----------
  function getGroupIdFromStatus(status) {
    if (status === 'In Progress') return 2;
    if (status === 'Done') return 3;
    return 1;
  }

  function priorityClass(priority) {
    switch (priority) {
      case 'Critical': return 'bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300';
      case 'High':     return 'bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-300';
      case 'Medium':   return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-200';
      case 'Low':      return 'bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300';
      default:         return 'bg-gray-100 text-gray-800 dark:bg-gray-500/20 dark:text-gray-200';
    }
  }

  // ---------- API ----------
  const api = {
    // 1. SYNC ALL (Fetch Tasks + Metadata)
    syncAll: async () => {
      if (!state.currentUser) return;
      try {
        const res = await fetch(`${ZOHO_API_URL}&request_method=GET&user_email=${state.currentUser.email}`);
        const json = await res.json();
        
        if (json.status === 'success' && json.data) {
          const serverTasks = json.data.tasks || [];
          const serverMeta = json.data.metadata || [];

          // A. Process Metadata (Rebuild Structure)
          if(serverMeta.length > 0) {
              const workspaces = [];
              const projects = [];
              const groups = [];
              
              serverMeta.forEach(m => {
                  let attrs = {};
                  try { attrs = JSON.parse(m.attributes); } catch(e){}
                  
                  if(m.recordtype === 'workspace') {
                      workspaces.push({ id: String(m.id), name: m.name });
                  } else if(m.recordtype === 'project') {
                      projects.push({ id: String(m.id), name: m.name, workspaceId: m.relatedid, color: attrs.color || 'bg-blue-500' });
                  } else if(m.recordtype === 'group') {
                      groups.push({ 
                          id: String(m.id), 
                          name: m.name, 
                          projectId: m.relatedid, 
                          collapsed: attrs.collapsed || false,
                          columns: attrs.columns || [] 
                      });
                  }
              });
              
              if(workspaces.length) state.workspaces = workspaces;
              if(projects.length) state.projects = projects;
              if(groups.length) state.groups = groups;
              
              // Reset selection logic
              if(!state.workspaces.find(w => String(w.id) === String(state.selectedWorkspace))) state.selectedWorkspace = state.workspaces[0]?.id;
              if(!state.projects.find(p => String(p.id) === String(state.selectedProject))) state.selectedProject = state.projects[0]?.id;
          }

          // B. Process Tasks
          state.tasks = serverTasks.map(t => {
            let extras = { duedate: "", custom: {} };
            try { if (t.customattributes) extras = JSON.parse(t.customattributes); } catch (e) {}
            
            // Map Status to Group ID logic
            let gId = getGroupIdFromStatus(t.status);
            // If we have custom groups loaded from DB, try to match status to group name
            if(state.groups.length > 0) {
                const matchingGroup = state.groups.find(g => g.name === t.status && String(g.projectId) === String(state.selectedProject));
                if(matchingGroup) gId = matchingGroup.id;
            }

            return {
              id: String(t.id),
              name: t.taskname,
              status: t.status || 'Not Started',
              priority: t.priority || 'Medium',
              assignee: t.assignee === 'Unassigned' ? null : { name: t.assignee },
              dueDate: extras.duedate || "",
              customFields: extras.custom || {},
              projectId: state.selectedProject, 
              groupId: gId
            };
          });

          renderApp();
        }
      } catch (e) {
        console.error("Sync Error", e);
      }
    },

    // 2. SAVE METADATA (Structure)
    saveMetadata: async (action, type, data) => {
         const payload = {
             name: data.name,
             recordtype: type,
             relatedid: data.relatedId || "",
             attributes: JSON.stringify(data.attributes || {})
         };
         
         let url = `${ZOHO_API_URL}&request_method=POST&type=metadata&action=${action}&user_email=${state.currentUser.email}`;
         for (const [key, value] of Object.entries(payload)) {
             url += `&${key}=${encodeURIComponent(value)}`;
         }
         if(data.id && action !== 'create') url += `&id=${data.id}`;

         try {
             await fetch(url);
             if(action === 'create') api.syncAll(); 
         } catch(e) { console.error(e); }
    },

    // 3. TASK OPERATIONS
    createTask: async (groupId) => {
      const taskData = state.ui.newTask;
      if (!taskData.name.trim()) return;

      // Optimistic
      state.tasks.push({ id: String(uid()), groupId, projectId: state.selectedProject, ...taskData });
      state.ui.showNewTask = null;
      renderApp();

      const packed = JSON.stringify({ duedate: taskData.dueDate, custom: taskData.customFields });
      
      try {
        await fetch(
          `${ZOHO_API_URL}&request_method=POST&type=task&action=create` +
          `&name=${encodeURIComponent(taskData.name)}` +
          `&user_email=${state.currentUser.email}` +
          `&status=${encodeURIComponent(taskData.status)}` +
          `&priority=${encodeURIComponent(taskData.priority)}` +
          `&assignee=${encodeURIComponent(taskData.assignee?.name || 'Unassigned')}` +
          `&attributes=${encodeURIComponent(packed)}`
        );
        api.syncAll();
      } catch (e) { console.error(e); }
    },

    updateTask: async (task) => {
      try {
        const packed = JSON.stringify({ duedate: task.dueDate || "", custom: task.customFields || {} });
        await fetch(
          `${ZOHO_API_URL}&request_method=POST&type=task&action=update` +
          `&id=${encodeURIComponent(task.id)}` +
          `&name=${encodeURIComponent(task.name)}` +
          `&user_email=${state.currentUser.email}` +
          `&status=${encodeURIComponent(task.status)}` +
          `&priority=${encodeURIComponent(task.priority)}` +
          `&assignee=${encodeURIComponent(task.assignee?.name || 'Unassigned')}` +
          `&attributes=${encodeURIComponent(packed)}`
        );
      } catch (e) { console.error(e); }
    },

    deleteTask: async (id) => {
      state.tasks = state.tasks.filter(t => t.id !== id);
      renderApp();
      try {
        await fetch(`${ZOHO_API_URL}&request_method=POST&type=task&action=delete&id=${encodeURIComponent(id)}`);
      } catch (e) { console.error(e); }
    }
  };

  // ---------- Actions (UI Logic) ----------
  const actions = {
    render: () => renderApp(),
    toggleTheme: () => { state.darkMode = !state.darkMode; renderApp(); },
    setView: (view) => { state.currentView = view; renderApp(); },

    // Workspaces
    selectWorkspace: (id) => {
      state.selectedWorkspace = String(id);
      const proj = state.projects.find(p => String(p.workspaceId) === String(id));
      if (proj) state.selectedProject = proj.id;
      renderApp();
    },
    addWorkspace: () => {
      const id = String(uid());
      const newWS = { id, name: 'New Workspace' };
      state.workspaces.push(newWS);
      state.selectedWorkspace = id;
      renderApp();
      api.saveMetadata('create', 'workspace', newWS);
    },
    startEditWorkspace: (id) => {
      const ws = state.workspaces.find(w => String(w.id) === String(id));
      if (ws) { state.ui.editingWorkspaceId = id; state.ui.editingWorkspaceName = ws.name; renderApp(); }
    },
    saveWorkspaceName: (id) => {
      const input = document.getElementById(`ws-name-input-${id}`);
      const ws = state.workspaces.find(w => String(w.id) === String(id));
      if (ws && input && input.value.trim()) {
        ws.name = input.value.trim();
        api.saveMetadata('update', 'workspace', ws);
      }
      state.ui.editingWorkspaceId = null;
      renderApp();
    },
    deleteWorkspace: (id) => {
        if(state.workspaces.length <= 1) return;
        state.workspaces = state.workspaces.filter(w => String(w.id) !== String(id));
        if(String(state.selectedWorkspace) === String(id)) state.selectedWorkspace = state.workspaces[0].id;
        renderApp();
        api.saveMetadata('delete', 'workspace', {id});
    },

    // Projects
    addProject: () => {
      const id = String(uid());
      const newProj = { id, name: 'New Project', color: 'bg-green-500', workspaceId: state.selectedWorkspace };
      state.projects.push(newProj);
      state.selectedProject = id;
      renderApp();
      api.saveMetadata('create', 'project', { name: newProj.name, relatedId: newProj.workspaceId, attributes: { color: newProj.color } });
    },
    selectProject: (id) => { state.selectedProject = String(id); renderApp(); },
    deleteProject: (id) => {
        state.projects = state.projects.filter(p => String(p.id) !== String(id));
        renderApp();
        api.saveMetadata('delete', 'project', {id});
    },

    // Groups
    addGroup: () => {
      const id = String(uid());
      const newGroup = { id, name: 'New Group', projectId: state.selectedProject, collapsed: false, columns: [] };
      state.groups.push(newGroup);
      renderApp();
      api.saveMetadata('create', 'group', { name: newGroup.name, relatedId: newGroup.projectId, attributes: { collapsed: false, columns: [] } });
    },
    toggleGroupCollapse: (id) => {
        const g = state.groups.find(gr => String(gr.id) === String(id));
        if(g) { g.collapsed = !g.collapsed; renderApp(); api.saveMetadata('update', 'group', {id: g.id, name: g.name, relatedId: g.projectId, attributes: {collapsed: g.collapsed, columns: g.columns}}); }
    },

    // Tasks
    setShowNewTask: (groupId) => {
      const grp = state.groups.find(g => String(g.id) === String(groupId));
      state.ui.showNewTask = groupId;
      state.ui.newTask = { name: '', assignee: null, priority: 'Medium', status: grp ? grp.name : 'Not Started', dueDate: '', customFields: {} };
      renderApp();
    },
    submitTask: (groupId) => {
      const input = document.getElementById(`new-task-name-${groupId}`);
      if (input) state.ui.newTask.name = input.value;
      api.createTask(groupId);
    },
    deleteTask: (id) => api.deleteTask(id),
    
    // UI Helpers (Task Rename)
    startEditTaskName: (id) => { state.ui.editingTaskId = id; renderApp(); setTimeout(()=>document.getElementById(`task-name-input-${id}`)?.focus(), 50); },
    saveTaskName: (id) => {
        const input = document.getElementById(`task-name-input-${id}`);
        const t = state.tasks.find(task => String(task.id) === String(id));
        if(t && input && input.value.trim()) { t.name = input.value.trim(); api.updateTask(t); }
        state.ui.editingTaskId = null; renderApp();
    },
    updateTaskField: (id, field, value) => {
        const t = state.tasks.find(task => String(task.id) === String(id));
        if(t) {
            if(field === 'assignee') t.assignee = value ? {name: value} : null;
            else t[field] = value;
            renderApp(); api.updateTask(t);
        }
    }
  };
  window.actions = actions;

  // ---------- Sidebar & Render Functions ----------
  // (Simplified for brevity - Assuming standard render logic here as per previous versions)
  function renderSidebar() {
    const { workspaces, selectedWorkspace, projects, selectedProject } = state;
    return `
      <div class="w-72 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 flex flex-col h-full">
        <div class="p-4 border-b dark:border-gray-800"><h1 class="font-bold text-xl dark:text-white">WellTask</h1></div>
        <div class="p-4 flex-1 overflow-y-auto">
           <div class="mb-4 flex justify-between"><span class="text-xs font-bold text-gray-500">WORKSPACES</span><button onclick="actions.addWorkspace()" class="text-blue-500 text-xs">+ New</button></div>
           ${workspaces.map(w => `<div onclick="actions.selectWorkspace('${w.id}')" class="p-2 rounded cursor-pointer ${String(w.id)===String(selectedWorkspace)?'bg-blue-100 text-blue-700': 'text-gray-700 dark:text-gray-300'}">${w.name}</div>`).join('')}
           
           <div class="mt-6 mb-4 flex justify-between"><span class="text-xs font-bold text-gray-500">PROJECTS</span><button onclick="actions.addProject()" class="text-blue-500 text-xs">+ New</button></div>
           ${projects.filter(p=>String(p.workspaceId)===String(selectedWorkspace)).map(p => `<div onclick="actions.selectProject('${p.id}')" class="p-2 rounded cursor-pointer ${String(p.id)===String(selectedProject)?'bg-blue-100 text-blue-700': 'text-gray-700 dark:text-gray-300'} flex justify-between group"><span>${p.name}</span><button onclick="event.stopPropagation(); actions.deleteProject('${p.id}')" class="hidden group-hover:block text-red-500 text-xs">Del</button></div>`).join('')}
        </div>
      </div>
    `;
  }

  function renderKanbanView() {
    const { groups, tasks, selectedProject } = state;
    const projectGroups = groups.filter(g => String(g.projectId) === String(selectedProject));
    
    return `
      <div class="flex h-full p-6 space-x-4 overflow-x-auto bg-gray-50 dark:bg-gray-900">
        ${projectGroups.map(grp => {
            const grpTasks = tasks.filter(t => String(t.groupId) === String(grp.id));
            return `
            <div class="w-80 flex-shrink-0 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-col max-h-full">
               <div class="p-3 border-b dark:border-gray-700 flex justify-between font-semibold dark:text-white"><span>${grp.name} <span class="text-xs text-gray-400">(${grpTasks.length})</span></span></div>
               <div class="flex-1 overflow-y-auto p-3 space-y-2">
                 ${grpTasks.map(t => `
                   <div class="p-3 bg-white dark:bg-gray-700 border dark:border-gray-600 rounded shadow-sm hover:shadow-md">
                     ${String(state.ui.editingTaskId)===String(t.id) 
                       ? `<input id="task-name-input-${t.id}" value="${t.name}" onblur="actions.saveTaskName('${t.id}')" class="w-full bg-transparent border-b" autofocus>` 
                       : `<div class="font-medium dark:text-white cursor-pointer" onclick="actions.startEditTaskName('${t.id}')">${t.name}</div>`}
                     <div class="mt-2 flex justify-between items-center text-xs text-gray-500">
                        <span>${t.priority}</span>
                        <button onclick="actions.deleteTask('${t.id}')" class="text-red-500">Del</button>
                     </div>
                   </div>
                 `).join('')}
               </div>
               <div class="p-3 border-t dark:border-gray-700">
                 ${String(state.ui.showNewTask)===String(grp.id) 
                   ? `<input id="new-task-name-${grp.id}" class="w-full border p-1 rounded mb-1 text-sm dark:bg-gray-700 dark:text-white" placeholder="Name..." onkeypress="if(event.key==='Enter') actions.submitTask('${grp.id}')"><button onclick="actions.submitTask('${grp.id}')" class="w-full bg-blue-500 text-white text-sm rounded py-1">Save</button>`
                   : `<button onclick="actions.setShowNewTask('${grp.id}')" class="w-full text-blue-500 text-sm py-1 border border-dashed border-blue-300 rounded">+ Add Task</button>`}
               </div>
            </div>`;
        }).join('')}
        <button onclick="actions.addGroup()" class="w-80 h-12 flex-shrink-0 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center text-gray-500 hover:border-blue-400 hover:text-blue-500">+ Add Group</button>
      </div>
    `;
  }

  function renderApp() {
    const app = document.getElementById('app');
    if (state.showLogin) { app.innerHTML = `<div class="h-screen flex items-center justify-center text-gray-500">Access via Zoho Cliq</div>`; return; }
    document.documentElement.classList.toggle('dark', state.darkMode);
    app.innerHTML = `<div class="flex h-screen overflow-hidden">${renderSidebar()}<div class="flex-1 overflow-hidden">${renderKanbanView()}</div></div>`;
    lucide.createIcons();
  }

  // Initial Sync
  if (state.currentUser) api.syncAll();
  renderApp();
</script>
</body>
</html>
