<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WellTask</title>

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            gray: { 750: "#2d3748" }
          }
        }
      }
    };
  </script>

  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 transition-colors duration-200">
  <div id="app"></div>

  <script>
    // ==========================
    // ✅ CONFIG FOR SHARED CHANNEL DASHBOARD
    // ==========================
    const ZOHO_API_URL = "/api/proxy";

    // Read parameters from widget URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");
    const boardidFromUrl = urlParams.get("boardid"); // shared board identifier

    let currentUser = null;
    let boardid = boardidFromUrl || null;

    // Decode token from widget
    if (token) {
      try {
        const decoded = atob(token);
        const parts = decoded.split("::");

        // supports: email::userid or email::userid::channelId
        currentUser = {
          id: parts[1],
          name: parts[0].split("@")[0],
          email: parts[0]
        };

        if (!boardid && parts.length >= 3) {
          boardid = parts[2]; // channel-based shared board
        }
      } catch (e) {
        console.error("Auth Failed", e);
      }
    }

    if (!boardid) {
      console.error("❌ Missing boardid — shared dashboard cannot load");
    }

    const uid = () => Date.now().toString() + Math.floor(Math.random() * 1000);

    // ✅ Key now based on boardid → shared per channel
    function getStorageKey() {
      return boardid ? `welltask_state_${boardid}` : null;
    }

    function priorityClass(priority) {
      switch (priority) {
        case "Critical": return "bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300";
        case "High": return "bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-300";
        case "Medium": return "bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-200";
        case "Low": return "bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300";
        default: return "bg-gray-100 text-gray-800 dark:bg-gray-500/20 dark:text-gray-200";
      }
    }

    // ==========================
    // ✅ STATE (UNCHANGED UI)
    // ==========================
    const initialState = {
      darkMode: false,
      currentUser,
      showLogin: !currentUser,
      isLoading: false,
      saveStatus: "saved",
      currentView: "list",

      workspaces: [],
      selectedWorkspace: null,
      projects: [],
      selectedProject: null,
      groups: [],
      tasks: [],

      ui: {
        showNewTask: null,
        newTask: {
          name: "",
          assignee: null,
          priority: "Medium",
          status: "Not Started",
          dueDate: "",
          customFields: {}
        },
        columnsGroupId: null,
        editingWorkspaceId: null,
        editingWorkspaceName: "",
        editingProjectId: null,
        editingProjectName: "",
        editingTaskId: null,
        editingGroupId: null,
        editingGroupName: ""
      }
    };

    let state = { ...initialState };

    // ==========================
    // ✅ API + LOCAL STORAGE updated for boardid
    // ==========================
    const api = {
      saveTimer: null,

      load: async () => {
        if (!boardid) return;

        state.isLoading = true;
        renderApp();

        try {
          const key = getStorageKey();
          if (key) {
            const stored = localStorage.getItem(key);
            if (stored) {
              Object.assign(state, JSON.parse(stored));
              state.isLoading = false;
              renderApp();
              return;
            }
          }

          const res = await fetch(ZOHO_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "load", boardid })
          });

          const data = await res.json();
          if (data && data.data) {
            Object.assign(state, data.data);
          } else {
            api.initDefaults();
          }
        } catch (e) {
          api.initDefaults();
        }

        state.isLoading = false;
        renderApp();
      },

      initDefaults: () => {
        const wsId = uid();
        const pId = uid();
        const g1 = uid(), g2 = uid(), g3 = uid();

        const defaultColumns = [
          { id: "task", name: "Task", isDefault: true },
          { id: "assignee", name: "Assignee", isDefault: true },
          { id: "priority", name: "Priority", isDefault: true },
          { id: "status", name: "Status", isDefault: true },
          { id: "duedate", name: "Due Date", isDefault: true }
        ];

        state.workspaces = [{ id: wsId, name: "My Workspace" }];
        state.projects = [
          {
            id: pId,
            name: "Marketing Campaign",
            color: "bg-purple-500",
            workspaceId: wsId
          }
        ];
        state.groups = [
          { id: g1, name: "To Do", projectId: pId, collapsed: false, columns: [...defaultColumns] },
          { id: g2, name: "In Progress", projectId: pId, collapsed: false, columns: [...defaultColumns] },
          { id: g3, name: "Done", projectId: pId, collapsed: false, columns: [...defaultColumns] }
        ];
        state.tasks = [];
        state.selectedWorkspace = wsId;
        state.selectedProject = pId;

        api.triggerSave();
      },

      triggerSave: () => {
        if (api.saveTimer) clearTimeout(api.saveTimer);
        state.saveStatus = "pending";
        renderStatusIndicator();
        api.saveTimer = setTimeout(api.performSave, 1500);
      },

      performSave: async () => {
        if (!boardid) return;

        state.saveStatus = "saving";
        renderStatusIndicator();

        const payload = {
          darkMode: state.darkMode,
          currentView: state.currentView,
          workspaces: state.workspaces,
          projects: state.projects,
          groups: state.groups,
          tasks: state.tasks
        };

        const key = getStorageKey();
        if (key) localStorage.setItem(key, JSON.stringify(payload));

        await fetch(ZOHO_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "save", boardid, data_payload: JSON.stringify(payload) })
        });

        state.saveStatus = "saved";
        renderStatusIndicator();
      }
    };

    // ✅ UI + features remain EXACTLY same — no modifications below

    renderApp();
    if (currentUser) api.load();
  </script>
</body></html>
