<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WellTask</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { gray: { 750: '#2d3748' } } } }
    }
  </script>
  <style>
    ::-webkit-scrollbar{width:8px;height:8px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:#cbd5e0;border-radius:4px;}
    .dark ::-webkit-scrollbar-thumb{background:#4a5568;}
  </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-200">
<div id="app"></div>

<script>
  // ========== CONFIGURATION ==========
  const ZOHO_API_URL = "/api/proxy";
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  let currentUser = null;
  if (token) {
    try {
      const decoded = atob(token);
      const parts = decoded.split("::");
      if (parts.length === 2) {
        currentUser = {
          id: parts[1],
          name: parts[0].split('@')[0],
          email: parts[0],
          role: 'owner'
        };
      }
    } catch (e) {
      console.error("Auth Failed", e);
    }
  }

  const uid = () => Date.now().toString() + Math.floor(Math.random() * 1000);

  // ========== STATE ==========
  const initialState = {
    darkMode: false,
    currentView: 'kanban',
    currentUser,
    showLogin: !currentUser,
    userRecordId: null, // Database record ID

    workspaces: [],
    selectedWorkspace: null,
    projects: [],
    selectedProject: null,
    groups: [],
    tasks: [],

    ui: {
      showNewTask: null,
      newTask: { name: '', assignee: null, priority: 'Medium', status: 'Not Started', dueDate: '', customFields: {} },
      editingWorkspaceId: null, editingWorkspaceName: '',
      editingProjectId: null, editingProjectName: '',
      editingTaskId: null,
      editingGroupId: null, editingGroupName: ''
    }
  };

  let state = { ...initialState };

  function priorityClass(priority) {
    switch (priority) {
      case 'Critical': return 'bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300';
      case 'High': return 'bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-300';
      case 'Medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-200';
      case 'Low': return 'bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300';
      default: return 'bg-gray-100 text-gray-800 dark:bg-gray-500/20 dark:text-gray-200';
    }
  }

  // ========== API ==========
  const api = {
    // Load all data from database
    load: async () => {
      if (!state.currentUser) return;
      
      try {
        console.log("ðŸ”„ Loading data from database...");
        const res = await fetch(`${ZOHO_API_URL}?request_method=GET&user_email=${encodeURIComponent(state.currentUser.email)}`);
        const json = await res.json();
        
        console.log("âœ… Database response:", json);

        if (json.status === 'success' && json.data) {
          // Store the record ID for future updates
          state.userRecordId = json.user_record_id;

          // Load workspaces, projects, groups, tasks
          if (json.data.workspaces && json.data.workspaces.length > 0) {
            state.workspaces = json.data.workspaces;
            state.projects = json.data.projects || [];
            state.groups = json.data.groups || [];
            state.tasks = json.data.tasks || [];
            
            // Set selections
            state.selectedWorkspace = state.workspaces[0]?.id;
            const firstProject = state.projects.find(p => p.workspaceId === state.selectedWorkspace);
            state.selectedProject = firstProject?.id;
          } else {
            // Initialize defaults if database is empty
            console.log("ðŸ“¦ Initializing default data...");
            api.initDefaults();
          }
        }
        
        renderApp();
      } catch (e) {
        console.error("âŒ Load error:", e);
      }
    },

    // Initialize default structure
    initDefaults: () => {
      const wsId = uid();
      const pId = uid();
      const g1 = uid(), g2 = uid(), g3 = uid();

      state.workspaces = [{ id: wsId, name: 'My Workspace' }];
      state.projects = [{ id: pId, name: 'Marketing Campaign', color: 'bg-purple-500', workspaceId: wsId }];
      state.groups = [
        { id: g1, name: 'To Do', projectId: pId, collapsed: false },
        { id: g2, name: 'In Progress', projectId: pId, collapsed: false },
        { id: g3, name: 'Done', projectId: pId, collapsed: false }
      ];
      state.tasks = [];
      
      state.selectedWorkspace = wsId;
      state.selectedProject = pId;

      // Save to database
      api.save();
    },

    // Save all data to database
    save: async () => {
      if (!state.currentUser) return;

      try {
        const payload = {
          workspaces: state.workspaces,
          projects: state.projects,
          groups: state.groups,
          tasks: state.tasks
        };

        const dataString = JSON.stringify(payload);
        console.log("ðŸ’¾ Saving to database...", { recordId: state.userRecordId, dataLength: dataString.length });

        const url = `${ZOHO_API_URL}?request_method=POST&user_email=${encodeURIComponent(state.currentUser.email)}&data_payload=${encodeURIComponent(dataString)}&record_id=${state.userRecordId || ''}&action=${state.userRecordId ? 'update' : 'create'}`;
        
        const res = await fetch(url);
        const json = await res.json();
        
        console.log("âœ… Save response:", json);

        // Update record ID if it was a create operation
        if (json.new_record_id) {
          state.userRecordId = json.new_record_id;
        }
      } catch (e) {
        console.error("âŒ Save error:", e);
      }
    }
  };

  // ========== ACTIONS ==========
  const actions = {
    toggleTheme: () => { state.darkMode = !state.darkMode; renderApp(); },
    setView: (view) => { state.currentView = view; renderApp(); },

    // Workspaces
    selectWorkspace: (id) => {
      state.selectedWorkspace = id;
      const proj = state.projects.find(p => p.workspaceId === id);
      if (proj) state.selectedProject = proj.id;
      renderApp();
    },
    addWorkspace: () => {
      const id = uid();
      state.workspaces.push({ id, name: 'New Workspace' });
      state.selectedWorkspace = id;
      renderApp();
      api.save();
    },
    startEditWorkspace: (id) => {
      const ws = state.workspaces.find(w => w.id === id);
      if (ws) {
        state.ui.editingWorkspaceId = id;
        state.ui.editingWorkspaceName = ws.name;
        renderApp();
      }
    },
    saveWorkspaceName: (id) => {
      const input = document.getElementById(`ws-name-input-${id}`);
      const ws = state.workspaces.find(w => w.id === id);
      if (ws && input && input.value.trim()) {
        ws.name = input.value.trim();
        api.save();
      }
      state.ui.editingWorkspaceId = null;
      renderApp();
    },
    deleteWorkspace: (id) => {
      if (state.workspaces.length <= 1) return;
      state.workspaces = state.workspaces.filter(w => w.id !== id);
      if (state.selectedWorkspace === id) {
        state.selectedWorkspace = state.workspaces[0]?.id;
      }
      renderApp();
      api.save();
    },

    // Projects
    addProject: () => {
      const id = uid();
      state.projects.push({
        id,
        name: 'New Project',
        color: 'bg-green-500',
        workspaceId: state.selectedWorkspace
      });
      state.selectedProject = id;
      renderApp();
      api.save();
    },
    selectProject: (id) => {
      state.selectedProject = id;
      renderApp();
    },
    startEditProject: (id) => {
      const p = state.projects.find(pr => pr.id === id);
      if (p) {
        state.ui.editingProjectId = id;
        state.ui.editingProjectName = p.name;
        renderApp();
      }
    },
    saveProjectName: (id) => {
      const input = document.getElementById(`proj-name-input-${id}`);
      const p = state.projects.find(pr => pr.id === id);
      if (p && input && input.value.trim()) {
        p.name = input.value.trim();
        api.save();
      }
      state.ui.editingProjectId = null;
      renderApp();
    },
    deleteProject: (id) => {
      state.projects = state.projects.filter(p => p.id !== id);
      const another = state.projects.find(p => p.workspaceId === state.selectedWorkspace);
      state.selectedProject = another?.id || state.projects[0]?.id;
      renderApp();
      api.save();
    },

    // Groups
    addGroup: () => {
      const id = uid();
      state.groups.push({
        id,
        name: 'New Group',
        projectId: state.selectedProject,
        collapsed: false
      });
      renderApp();
      api.save();
    },
    startEditGroup: (id) => {
      const g = state.groups.find(gr => gr.id === id);
      if (g) {
        state.ui.editingGroupId = id;
        state.ui.editingGroupName = g.name;
        renderApp();
      }
    },
    saveGroupName: (id) => {
      const input = document.getElementById(`group-name-input-${id}`);
      const g = state.groups.find(gr => gr.id === id);
      if (g && input && input.value.trim()) {
        g.name = input.value.trim();
        api.save();
      }
      state.ui.editingGroupId = null;
      renderApp();
    },
    toggleGroupCollapse: (id) => {
      const g = state.groups.find(gr => gr.id === id);
      if (g) {
        g.collapsed = !g.collapsed;
        renderApp();
        api.save();
      }
    },
    deleteGroup: (id) => {
      state.groups = state.groups.filter(g => g.id !== id);
      state.tasks = state.tasks.filter(t => t.groupId !== id);
      renderApp();
      api.save();
    },

    // Tasks
    setShowNewTask: (groupId) => {
      const grp = state.groups.find(g => g.id === groupId);
      state.ui.showNewTask = groupId;
      state.ui.newTask = {
        name: '',
        assignee: null,
        priority: 'Medium',
        status: grp ? grp.name : 'Not Started',
        dueDate: '',
        customFields: {}
      };
      renderApp();
    },
    submitTask: (groupId) => {
      const input = document.getElementById(`new-task-name-${groupId}`);
      if (!input || !input.value.trim()) return;

      const id = uid();
      state.tasks.push({
        id,
        name: input.value.trim(),
        groupId,
        projectId: state.selectedProject,
        ...state.ui.newTask
      });
      state.ui.showNewTask = null;
      renderApp();
      api.save();
    },
    deleteTask: (id) => {
      state.tasks = state.tasks.filter(t => t.id !== id);
      renderApp();
      api.save();
    },
    startEditTaskName: (id) => {
      state.ui.editingTaskId = id;
      renderApp();
      setTimeout(() => {
        const input = document.getElementById(`task-name-input-${id}`);
        if (input) input.focus();
      }, 50);
    },
    saveTaskName: (id) => {
      const input = document.getElementById(`task-name-input-${id}`);
      const t = state.tasks.find(task => task.id === id);
      if (t && input && input.value.trim()) {
        t.name = input.value.trim();
        api.save();
      }
      state.ui.editingTaskId = null;
      renderApp();
    },
    updateTaskField: (id, field, value) => {
      const t = state.tasks.find(task => task.id === id);
      if (t) {
        if (field === 'assignee') {
          t.assignee = value ? { name: value } : null;
        } else {
          t[field] = value;
        }
        renderApp();
        api.save();
      }
    },
    moveTaskToGroup: (id, groupId) => {
      const t = state.tasks.find(task => task.id === id);
      const grp = state.groups.find(g => g.id === groupId);
      if (t && grp) {
        t.groupId = groupId;
        t.status = grp.name;
        renderApp();
        api.save();
      }
    }
  };
  window.actions = actions;

  // ========== RENDER ==========
  function renderSidebar() {
    const { workspaces, selectedWorkspace, projects, selectedProject, ui, darkMode } = state;
    const cardBg = darkMode ? 'bg-gray-900' : 'bg-white';
    const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
    const borderColor = darkMode ? 'border-gray-800' : 'border-gray-200';

    return `
      <div class="w-72 ${cardBg} border-r ${borderColor} flex flex-col h-full">
        <div class="p-6 border-b ${borderColor}">
          <h1 class="text-2xl font-bold ${textColor}">WellTask</h1>
        </div>

        <nav class="flex-1 p-4 space-y-6 overflow-y-auto">
          <div>
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Workspaces</span>
              <button onclick="actions.addWorkspace()" class="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">
                <i data-lucide="plus" class="w-3 h-3"></i> New
              </button>
            </div>
            ${workspaces.map(w => `
              <div class="flex items-center justify-between px-3 py-2 rounded-lg mb-1 ${w.id === selectedWorkspace ? 'bg-blue-600 text-white' : 'hover:bg-gray-100 dark:hover:bg-gray-800 ' + textColor}">
                ${ui.editingWorkspaceId === w.id
                  ? `<input id="ws-name-input-${w.id}" value="${w.name}" class="flex-1 bg-transparent text-sm outline-none border-b border-blue-300" autofocus onblur="actions.saveWorkspaceName('${w.id}')" onkeypress="if(event.key==='Enter'){actions.saveWorkspaceName('${w.id}')}" />`
                  : `<div class="flex-1 cursor-pointer" onclick="actions.selectWorkspace('${w.id}')"><span class="text-sm font-medium">${w.name}</span></div>`
                }
                <div class="flex items-center gap-1">
                  <button onclick="event.stopPropagation(); actions.startEditWorkspace('${w.id}')" class="opacity-80 hover:opacity-100">
                    <i data-lucide="edit-2" class="w-3 h-3"></i>
                  </button>
                  <button onclick="event.stopPropagation(); actions.deleteWorkspace('${w.id}')" class="opacity-80 hover:opacity-100">
                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>

          <div>
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Projects</span>
              <button onclick="actions.addProject()" class="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">
                <i data-lucide="plus" class="w-3 h-3"></i> New
              </button>
            </div>
            ${projects.filter(p => p.workspaceId === selectedWorkspace).map(p => `
              <div class="flex items-center justify-between px-3 py-2 rounded-lg mb-1 ${p.id === selectedProject ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'hover:bg-gray-100 dark:hover:bg-gray-800 ' + textColor}">
                ${ui.editingProjectId === p.id
                  ? `<div class="flex items-center gap-2 flex-1">
                      <span class="w-2 h-2 rounded-full ${p.color}"></span>
                      <input id="proj-name-input-${p.id}" value="${p.name}" class="flex-1 bg-transparent text-sm outline-none border-b border-blue-300" autofocus onblur="actions.saveProjectName('${p.id}')" onkeypress="if(event.key==='Enter'){actions.saveProjectName('${p.id}')}" />
                    </div>`
                  : `<div class="flex items-center gap-2 flex-1 cursor-pointer" onclick="actions.selectProject('${p.id}')">
                      <span class="w-2 h-2 rounded-full ${p.color}"></span>
                      <span class="text-sm">${p.name}</span>
                    </div>`
                }
                <div class="flex items-center gap-1">
                  <button onclick="event.stopPropagation(); actions.startEditProject('${p.id}')" class="opacity-80 hover:opacity-100">
                    <i data-lucide="edit-2" class="w-3 h-3"></i>
                  </button>
                  <button onclick="event.stopPropagation(); actions.deleteProject('${p.id}')" class="opacity-80 hover:opacity-100">
                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        </nav>

        <div class="p-4 border-t ${borderColor}">
          <button onclick="actions.toggleTheme()" class="w-full flex items-center justify-between px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 ${textColor}">
            <span>Theme</span>
            <i data-lucide="${darkMode ? 'sun' : 'moon'}" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    `;
  }

  function renderKanbanView() {
    const { tasks, groups, darkMode, ui, projects, selectedProject } = state;
    const pageBg = darkMode ? 'bg-gray-900' : 'bg-gray-50';
    const panelBg = darkMode ? 'bg-gray-800' : 'bg-white';
    const textColor = darkMode ? 'text-gray-100' : 'text-gray-900';
    const subtleText = darkMode ? 'text-gray-400' : 'text-gray-500';
    const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';

    const project = projects.find(p => p.id === selectedProject);
    const projectGroups = groups.filter(g => g.projectId === selectedProject);

    return `
      <div class="p-6 h-full overflow-auto ${pageBg}">
        <div class="flex items-center justify-between mb-6">
          <div>
            <p class="text-xs uppercase tracking-wide ${subtleText} mb-1">Project</p>
            <h1 class="text-3xl font-bold ${textColor}">${project ? project.name : 'Project'}</h1>
          </div>
          <button onclick="actions.addGroup()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 text-sm">
            <i data-lucide="plus" class="w-4 h-4"></i> New Group
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 min-w-[900px]">
          ${projectGroups.map(grp => {
            const grpTasks = tasks.filter(t => t.groupId === grp.id);
            return `
              <div class="${panelBg} border ${borderColor} rounded-2xl p-4 flex flex-col h-full max-h-[80vh] shadow-sm">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <button onclick="actions.toggleGroupCollapse('${grp.id}')" class="${subtleText} hover:text-gray-600">
                      <i data-lucide="${grp.collapsed ? 'chevron-right' : 'chevron-down'}" class="w-4 h-4"></i>
                    </button>
                    ${ui.editingGroupId === grp.id
                      ? `<input id="group-name-input-${grp.id}" value="${grp.name}" class="text-sm font-semibold bg-transparent outline-none border-b border-blue-300 ${textColor}" autofocus onblur="actions.saveGroupName('${grp.id}')" onkeypress="if(event.key==='Enter'){actions.saveGroupName('${grp.id}')}" />`
                      : `<h2 class="text-sm font-semibold ${textColor}">${grp.name}</h2>`
                    }
                    <span class="bg-gray-100 dark:bg-gray-900 ${subtleText} text-xs px-2 py-1 rounded-full">${grpTasks.length}</span>
                  </div>
                  <div class="flex items-center gap-2 ${subtleText}">
                    <button onclick="actions.startEditGroup('${grp.id}')" class="hover:text-gray-700">
                      <i data-lucide="edit-2" class="w-4 h-4"></i>
                    </button>
                    <button onclick="actions.deleteGroup('${grp.id}')" class="hover:text-red-600 text-red-500">
                      <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                  </div>
                </div>

                <div class="flex-1 overflow-y-auto space-y-3 pr-1 ${grp.collapsed ? 'hidden' : ''}">
                  ${grpTasks.map(t => `
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-lg border ${borderColor} shadow-sm hover:shadow-md transition">
                      <div class="flex items-start justify-between gap-2 mb-2">
                        <div class="flex-1">
                          ${ui.editingTaskId === t.id
                            ? `<input id="task-name-input-${t.id}" value="${t.name}" class="w-full text-sm font-medium bg-transparent outline-none border-b border-blue-300 text-gray-900 dark:text-gray-50" autofocus onblur="actions.saveTaskName('${t.id}')" onkeypress="if(event.key==='Enter'){actions.saveTaskName('${t.id}')}" />`
                            : `<div class="font-medium text-gray-900 dark:text-gray-50 cursor-pointer" onclick="actions.startEditTaskName('${t.id}')">${t.name}</div>`
                          }
                        </div>
                        <div class="flex items-center gap-1">
                          <button onclick="actions.deleteTask('${t.id}')" class="text-red-500 hover:text-red-700">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                          </button>
                        </div>
                      </div>
                      <div class="flex justify-between items-center text-xs ${subtleText}">
                        <div class="flex items-center gap-2">
                          <select onchange="actions.moveTaskToGroup('${t.id}', this.value)" class="bg-gray-100 dark:bg-gray-800 rounded px-2 py-1 text-xs">
                            ${projectGroups.map(g => `<option value="${g.id}" ${g.id === t.groupId ? 'selected' : ''}>${g.name}</option>`).join('')}
                          </select>
                          <span class="px-2 py-1 rounded text-xs font-medium ${priorityClass(t.priority)}">
                            ${t.priority}
                          </span>
                        </div>
                        <span>${t.dueDate || ''}</span>
                      </div>
                    </div>
                  `).join('')}
                </div>

                <div class="mt-3 pt-3 border-t ${borderColor} ${grp.collapsed ? 'hidden' : ''}">
                  ${ui.showNewTask === grp.id
                    ? `<div class="space-y-2">
                        <input id="new-task-name-${grp.id}" type="text" placeholder="Task name..." class="w-full p-2 text-sm border rounded dark:bg-gray-700 dark:text-gray-50" autofocus onkeypress="if(event.key==='Enter') actions.submitTask('${grp.id}')">
                        <button onclick="actions.submitTask('${grp.id}')" class="w-full bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                          Add Task
                        </button>
                      </div>`
                    : `<button onclick="actions.setShowNewTask('${grp.id}')" class="w-full py-2 text-sm text-blue-500 border border-dashed border-blue-300 rounded hover:bg-blue-50 dark:hover:bg-gray-900">
                        + Add Task
                      </button>`
                  }
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }

  function renderLogin() {
    return `
      <div class="h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-purple-50 dark:from-gray-900 dark:to-gray-800">
        <div class="text-center">
          <div class="text-6xl mb-4">ðŸŽ¯</div>
          <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2">WellTask</h1>
          <p class="text-gray-600 dark:text-gray-400">Please access this dashboard via Zoho Cliq Widget</p>
        </div>
      </div>
    `;
  }

  function renderApp() {
    const app = document.getElementById('app');

    if (state.showLogin) {
      app.innerHTML = renderLogin();
    } else {
      document.documentElement.classList.toggle('dark', state.darkMode);
      const bgColor = state.darkMode ? 'bg-gray-900' : 'bg-gray-50';

      app.innerHTML = `
        <div class="flex h-screen ${bgColor}">
          ${renderSidebar()}
          <div class="flex-1 overflow-hidden">
            ${renderKanbanView()}
          </div>
        </div>
      `;
    }
    lucide.createIcons();
  }

  // ========== INIT ==========
  if (state.currentUser) {
    api.load();
  } else {
    renderApp();
  }
</script>
</body>
</html>
