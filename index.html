<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WellTask Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { gray: { 750: '#2d3748' } } } }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-200">

    <div id="app"></div>

    <script>
        // ========================================================================
        // ⚠️ PASTE YOUR ZOHO WEBHOOK URL HERE ⚠️
        // ========================================================================
        const ZOHO_API_URL = "https://cliq.zoho.com/api/v2/functions/apischema/invoke?zapikey=1001.3d8aae64bab5fe65c5682907e19fcb45.41d161bac1cea527694b74dbdc843360"; 

        // --- 1. AUTHENTICATION ---
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        let currentUser = null;

        if (token) {
            try {
                const decoded = atob(token);
                const parts = decoded.split("::");
                if (parts.length === 2) {
                    currentUser = { id: parts[1], name: parts[0].split('@')[0], email: parts[0], role: 'owner' };
                }
            } catch (e) { console.error("Auth Failed", e); }
        }

        // --- 2. STATE ---
        const initialState = {
            darkMode: false,
            currentView: 'list',
            currentUser: currentUser,
            showLogin: !currentUser,
            
            workspaces: [{ id: 1, name: 'My Workspace', collapsed: false }],
            selectedWorkspace: 1,
            projects: [
                { id: 1, name: 'Marketing Campaign', color: 'bg-purple-500', workspaceId: 1, collapsed: false },
                { id: 2, name: 'Product Development', color: 'bg-blue-500', workspaceId: 1, collapsed: false }
            ],
            selectedProject: 1,
            
            // Group Structure (UI Configuration)
            groups: [
                { id: 1, name: 'To Do', projectId: 1, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] },
                { id: 2, name: 'In Progress', projectId: 1, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] },
                { id: 3, name: 'Done', projectId: 1, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] }
            ],
            
            tasks: [], // API Data

            ui: {
                showNewWorkspace: false, showWorkspaceMenu: false, editingWorkspace: null,
                showNewProject: false, editingProject: null, showNewGroup: false,
                editingGroup: null, editingColumns: null, showNewTask: null,
                newTask: { name: '', assignee: null, priority: 'Medium', status: 'Not Started', dueDate: new Date().toISOString().split('T')[0], customFields: {} }
            }
        };

        let state = { ...initialState };

        // --- 3. API ENGINE ---
        const api = {
            fetchTasks: async () => {
                if (!state.currentUser || ZOHO_API_URL.includes("PASTE_YOUR")) return;
                try {
                    const res = await fetch(`${ZOHO_API_URL}&request_method=GET&user_email=${state.currentUser.email}`);
                    const json = await res.json();
                    if(json.status === 'success' && json.data) {
                        state.tasks = json.data.map(t => {
                            let extras = { duedate: "", custom: {} };
                            try { if(t.attributes) extras = JSON.parse(t.attributes); } catch(e) {}
                            return {
                                id: t.id, name: t.taskname, status: t.status, priority: t.priority,
                                assignee: t.assignee === 'Unassigned' ? null : { name: t.assignee, id: 0 },
                                dueDate: extras.duedate || "", customFields: extras.custom || {},
                                projectId: 1, groupId: getGroupId(t.status)
                            };
                        });
                        actions.render();
                    }
                } catch (e) { console.error("Sync Error", e); }
            },
            createTask: async (groupId) => {
                const taskData = state.ui.newTask;
                if(!taskData.name.trim()) return;
                const tempId = Date.now();
                state.tasks.push({ id: tempId, groupId, projectId: 1, ...taskData });
                state.ui.showNewTask = null;
                actions.render();
                
                const packed = JSON.stringify({ duedate: taskData.dueDate, custom: taskData.customFields });
                try {
                    await fetch(`${ZOHO_API_URL}&request_method=POST&action=create&name=${encodeURIComponent(taskData.name)}&user_email=${state.currentUser.email}&attributes=${encodeURIComponent(packed)}`);
                    api.fetchTasks();
                } catch (e) { console.error("Create Error", e); }
            },
            deleteTask: async (id) => {
                state.tasks = state.tasks.filter(t => t.id !== id);
                actions.render();
                await fetch(`${ZOHO_API_URL}&request_method=POST&action=delete&id=${id}`);
            }
        };

        function getGroupId(status) {
            if(status === 'In Progress') return 2;
            if(status === 'Done') return 3;
            return 1;
        }

        // --- 4. ACTIONS & LOGIC ---
        const actions = {
            render: () => renderApp(),
            toggleTheme: () => { state.darkMode = !state.darkMode; document.documentElement.classList.toggle('dark', state.darkMode); actions.render(); },
            setView: (view) => { state.currentView = view; actions.render(); },
            
            // Workspace & Project Actions
            toggleWorkspaceMenu: () => { state.ui.showWorkspaceMenu = !state.ui.showWorkspaceMenu; actions.render(); },
            setShowNewWorkspace: (v) => { state.ui.showNewWorkspace = v; actions.render(); },
            addWorkspace: () => { const val = document.getElementById('ws-input').value; if(val){ state.workspaces.push({id: Date.now(), name: val, collapsed:false}); state.ui.showNewWorkspace = false; actions.render(); }},
            setShowNewProject: (v) => { state.ui.showNewProject = v; actions.render(); },
            addProject: () => { const val = document.getElementById('proj-input').value; if(val){ state.projects.push({id: Date.now(), name: val, color: 'bg-green-500', workspaceId:1, collapsed:false}); state.ui.showNewProject = false; actions.render(); }},
            selectProject: (id) => { state.selectedProject = id; actions.render(); },

            // Group Actions
            setShowNewGroup: (v) => { state.ui.showNewGroup = v; actions.render(); },
            addGroup: () => { const val = document.getElementById('grp-input').value; if(val){ state.groups.push({id: Date.now(), name: val, projectId: state.selectedProject, collapsed: false, columns:['Task', 'Priority', 'Status']}); state.ui.showNewGroup = false; actions.render(); }},
            toggleGroup: (id) => { const g = state.groups.find(x=>x.id===id); if(g) g.collapsed = !g.collapsed; actions.render(); },
            deleteGroup: (id) => { state.groups = state.groups.filter(g=>g.id!==id); actions.render(); },
            
            // Column Actions
            setEditingColumns: (id) => { state.ui.editingColumns = state.ui.editingColumns === id ? null : id; actions.render(); },
            addColumn: (grpId) => { const val = document.getElementById(`col-input-${grpId}`).value; if(val){ state.groups.find(g=>g.id===grpId).columns.push(val); actions.render(); }},
            deleteColumn: (grpId, col) => { const g = state.groups.find(g=>g.id===grpId); g.columns = g.columns.filter(c=>c!==col); actions.render(); },

            // Task Actions
            setShowNewTask: (id) => { state.ui.showNewTask = id; state.ui.newTask = {name:'', priority:'Medium', status:'Not Started', dueDate: new Date().toISOString().split('T')[0], customFields:{}}; actions.render(); },
            updateNewTaskField: (f, v) => { if(f.startsWith('c_')) state.ui.newTask.customFields[f.substring(2)] = v; else state.ui.newTask[f] = v; },
            addTask: (grpId) => { const inp = document.getElementById(`new-task-name-${grpId}`); if(inp){ state.ui.newTask.name = inp.value; api.createTask(grpId); } },
            deleteTask: (id) => api.deleteTask(id)
        };
        window.actions = actions;

        // --- 5. RENDERERS ---
        const cardBg = () => state.darkMode ? 'bg-gray-800' : 'bg-white';
        const txtCol = () => state.darkMode ? 'text-gray-100' : 'text-gray-800';
        const border = () => state.darkMode ? 'border-gray-700' : 'border-gray-200';
        const inputBg = () => state.darkMode ? 'bg-gray-700' : 'bg-white';

        function renderSidebar() {
            const ws = state.workspaces[0]; 
            return `
                <div class="w-64 ${cardBg()} border-r ${border()} flex flex-col h-full">
                    <div class="p-6 border-b ${border()}"><h1 class="text-2xl font-bold ${txtCol()}">WellTask</h1></div>
                    <nav class="flex-1 p-4 overflow-y-auto">
                        <div class="mb-6">
                            <div class="flex justify-between mb-2"><span class="text-xs font-bold text-gray-500">WORKSPACE</span> <button onclick="actions.toggleWorkspaceMenu()" class="text-blue-500"><i data-lucide="settings" class="w-4 h-4"></i></button></div>
                            <div class="px-3 py-2 rounded bg-blue-50 text-blue-700 font-medium mb-2">${ws.name}</div>
                            ${state.ui.showWorkspaceMenu ? `<div class="p-2 border rounded mb-2"><button onclick="actions.setShowNewWorkspace(true)" class="text-sm flex gap-2"><i data-lucide="plus" class="w-4"></i> New Workspace</button></div>` : ''}
                            ${state.ui.showNewWorkspace ? `<div class="mb-2"><input id="ws-input" class="w-full border p-1 rounded mb-1 text-sm ${inputBg()}" placeholder="Name"><button onclick="actions.addWorkspace()" class="bg-green-500 text-white px-2 py-1 rounded text-xs">Add</button></div>` : ''}
                        </div>
                        <div>
                            <div class="flex justify-between mb-2"><span class="text-xs font-bold text-gray-500">PROJECTS</span> <button onclick="actions.setShowNewProject(true)" class="text-blue-500"><i data-lucide="plus" class="w-4 h-4"></i></button></div>
                            ${state.ui.showNewProject ? `<div class="mb-2"><input id="proj-input" class="w-full border p-1 rounded mb-1 text-sm ${inputBg()}" placeholder="Project Name"><button onclick="actions.addProject()" class="bg-green-500 text-white px-2 py-1 rounded text-xs">Add</button></div>` : ''}
                            ${state.projects.map(p => `<div onclick="actions.selectProject(${p.id})" class="flex items-center gap-2 px-3 py-2 rounded cursor-pointer ${state.selectedProject===p.id ? 'bg-blue-600 text-white' : `hover:bg-gray-100 dark:hover:bg-gray-700 ${txtCol()}`}"><div class="w-2 h-2 rounded-full ${p.color}"></div><span class="text-sm">${p.name}</span></div>`).join('')}
                        </div>
                    </nav>
                    <div class="p-4 border-t ${border()}"><button onclick="actions.toggleTheme()" class="flex justify-between w-full ${txtCol()}"><span>Theme</span><i data-lucide="${state.darkMode?'sun':'moon'}" class="w-4"></i></button></div>
                </div>
            `;
        }

        function renderListView() {
            const proj = state.projects.find(p=>p.id === state.selectedProject);
            const groups = state.groups.filter(g=>g.projectId === state.selectedProject);
            
            const header = `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded flex items-center justify-center text-white font-bold ${proj.color}">${proj.name[0]}</div>
                        <h1 class="text-2xl font-bold ${txtCol()}">${proj.name}</h1>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="actions.setView('kanban')" class="bg-purple-600 text-white px-4 py-2 rounded flex gap-2"><i data-lucide="grid-3x3" class="w-4"></i> Kanban View</button>
                        <button onclick="actions.setShowNewGroup(true)" class="bg-blue-600 text-white px-4 py-2 rounded flex gap-2"><i data-lucide="plus" class="w-4"></i> New Group</button>
                    </div>
                </div>
                ${state.ui.showNewGroup ? `<div class="p-4 border rounded mb-4 ${cardBg()}"><div class="flex gap-2"><input id="grp-input" class="border p-2 rounded flex-1 ${inputBg()} ${txtCol()}" placeholder="Group Name"><button onclick="actions.addGroup()" class="bg-green-500 text-white px-4 rounded">Save</button></div></div>` : ''}
            `;

            const groupHtml = groups.map(grp => {
                const tasks = state.tasks.filter(t=>t.groupId === grp.id);
                const gridCols = `repeat(${grp.columns.length}, 1fr) 50px`;
                
                // Helper to render input fields for creating a task
                const renderNewInputs = () => grp.columns.map(col => {
                    if(col === 'Task') return `<input id="new-task-name-${grp.id}" class="border p-1 rounded w-full ${inputBg()} ${txtCol()}" placeholder="Task Name">`;
                    if(col === 'Priority') return `<select onchange="actions.updateNewTaskField('priority', this.value)" class="border p-1 rounded w-full ${inputBg()} ${txtCol()}"><option>Medium</option><option>High</option><option>Low</option><option>Critical</option></select>`;
                    if(col === 'Status') return `<select onchange="actions.updateNewTaskField('status', this.value)" class="border p-1 rounded w-full ${inputBg()} ${txtCol()}"><option>Not Started</option><option>In Progress</option><option>Done</option></select>`;
                    if(col === 'Due Date') return `<input type="date" onchange="actions.updateNewTaskField('dueDate', this.value)" class="border p-1 rounded w-full ${inputBg()} ${txtCol()}">`;
                    if(col === 'Assignee') return `<select class="border p-1 rounded w-full ${inputBg()} ${txtCol()}"><option>Unassigned</option></select>`;
                    return `<input onchange="actions.updateNewTaskField('c_${col}', this.value)" class="border p-1 rounded w-full ${inputBg()} ${txtCol()}" placeholder="${col}">`;
                }).join('');

                // Helper to render READ-ONLY rows (Rich UI style)
                const renderRow = (t) => grp.columns.map(col => {
                    if(col==='Task') return `<span class="font-medium ${txtCol()}">${t.name}</span>`;
                    if(col==='Priority') {
                        const colors = {'High':'bg-orange-100 text-orange-700','Medium':'bg-yellow-100 text-yellow-700','Critical':'bg-red-100 text-red-700','Low':'bg-blue-100 text-blue-700'};
                        return `<span class="px-2 py-1 rounded text-xs ${colors[t.priority] || 'bg-gray-100'}">${t.priority}</span>`;
                    }
                    if(col==='Status') return `<span class="px-2 py-1 rounded text-xs bg-blue-500 text-white">${t.status}</span>`;
                    if(col==='Due Date') return `<span class="text-sm text-gray-500">${t.dueDate || '-'}</span>`;
                    if(col==='Assignee') return `<span class="text-sm text-gray-500">${t.assignee ? t.assignee.name : 'Unassigned'}</span>`;
                    return `<span class="text-sm text-gray-500">${t.customFields[col] || '-'}</span>`;
                }).join('');

                return `
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-2 p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 group">
                            <div class="flex items-center gap-2">
                                <button onclick="actions.toggleGroup(${grp.id})"><i data-lucide="${grp.collapsed?'chevron-right':'chevron-down'}" class="w-4 ${txtCol()}"></i></button>
                                <span class="font-bold text-lg ${txtCol()}">${grp.name}</span>
                                <span class="bg-gray-200 text-gray-600 px-2 rounded-full text-xs">${tasks.length}</span>
                            </div>
                            <div class="flex gap-3 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="actions.setEditingColumns(${grp.id})" class="text-purple-600 text-sm flex gap-1"><i data-lucide="settings" class="w-4"></i> Columns</button>
                                <button onclick="actions.setShowNewTask(${grp.id})" class="text-blue-600 text-sm flex gap-1"><i data-lucide="plus" class="w-4"></i> Add Task</button>
                                <button onclick="actions.deleteGroup(${grp.id})" class="text-red-500"><i data-lucide="trash-2" class="w-4"></i></button>
                            </div>
                        </div>

                        ${state.ui.editingColumns === grp.id ? `
                            <div class="p-4 border rounded mb-2 ${cardBg()}">
                                <div class="flex gap-2 mb-2">
                                    <input id="col-input-${grp.id}" class="border p-1 flex-1 rounded ${inputBg()} ${txtCol()}" placeholder="New Column Name">
                                    <button onclick="actions.addColumn(${grp.id})" class="bg-blue-600 text-white px-3 rounded">Add</button>
                                </div>
                                <div class="flex gap-2 flex-wrap">${grp.columns.map(c=>`<div class="bg-gray-200 px-2 py-1 rounded flex gap-2 items-center text-sm">${c} <button onclick="actions.deleteColumn(${grp.id}, '${c}')" class="text-red-500">×</button></div>`).join('')}</div>
                            </div>
                        ` : ''}

                        ${!grp.collapsed ? `
                            <div class="${cardBg()} border ${border()} rounded-lg shadow-sm">
                                <div class="grid gap-4 p-3 border-b ${border()} bg-gray-50 dark:bg-gray-700 font-semibold text-sm text-gray-500" style="grid-template-columns: ${gridCols}">
                                    ${grp.columns.map(c => `<div>${c}</div>`).join('')} <div></div>
                                </div>
                                
                                ${state.ui.showNewTask === grp.id ? `
                                    <div class="grid gap-4 p-3 border-b ${border()} bg-blue-50 dark:bg-gray-900 items-center" style="grid-template-columns: ${gridCols}">
                                        ${renderNewInputs()}
                                        <div class="flex gap-2">
                                            <button onclick="actions.addTask(${grp.id})" class="text-green-600"><i data-lucide="check" class="w-4"></i></button>
                                            <button onclick="actions.setShowNewTask(null)" class="text-red-500"><i data-lucide="x" class="w-4"></i></button>
                                        </div>
                                    </div>
                                ` : ''}

                                ${tasks.map(t => `
                                    <div class="grid gap-4 p-3 border-b ${border()} hover:bg-gray-50 dark:hover:bg-gray-700 items-center transition" style="grid-template-columns: ${gridCols}">
                                        ${renderRow(t)}
                                        <button onclick="actions.deleteTask('${t.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4"></i></button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            return `<div class="p-8 h-full overflow-auto">${header}${groupHtml}</div>`;
        }

        function renderApp() {
            const app = document.getElementById('app');
            if(state.showLogin) {
                app.innerHTML = `<div class="flex h-screen justify-center items-center bg-gray-100 text-gray-500 text-xl">Please access via Zoho Cliq Widget</div>`;
            } else {
                const { darkMode } = state;
                const bg = darkMode ? 'bg-gray-900' : 'bg-gray-50';
                app.innerHTML = `<div class="flex h-screen ${bg}">${renderSidebar()}<div class="flex-1 overflow-hidden">${state.currentView === 'list' ? renderListView() : renderKanbanView()}</div></div>`;
            }
            lucide.createIcons();
        }
        
        // Logic specific to Kanban is simplified here for brevity, but List View is full featured as requested.
        function renderKanbanView() {
             const { tasks, groups } = state;
             const header = `<div class="flex justify-between p-6"><h1 class="text-2xl font-bold ${txtCol()}">Kanban Board</h1><button onclick="actions.setView('list')" class="bg-gray-600 text-white px-4 py-2 rounded flex gap-2"><i data-lucide="layout-list" class="w-4"></i> List View</button></div>`;
             const cols = groups.map(g => {
                 const gTasks = tasks.filter(t=>t.groupId === g.id);
                 return `<div class="p-4 border rounded ${cardBg()} flex-1"><h3 class="font-bold mb-4 ${txtCol()}">${g.name} (${gTasks.length})</h3><div class="space-y-2">${gTasks.map(t=>`<div class="p-2 border rounded ${darkMode?'bg-gray-700':'bg-white'} ${txtCol()}">${t.name}</div>`).join('')}</div></div>`;
             }).join('');
             return `<div class="h-full flex flex-col">${header}<div class="flex gap-4 p-6 h-full overflow-auto">${cols}</div></div>`;
        }

        // INIT
        if(state.currentUser) api.fetchTasks();
        setInterval(() => { if(state.currentUser) api.fetchTasks(); }, 3000);
        renderApp();

    </script>
</body>
</html>
