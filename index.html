<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WellTask Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { gray: { 750: '#2d3748' } } } }
        }
    </script>

    <style>
        /* Custom Scrollbar Styles for cross-browser consistency */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-200">

    <div id="app"></div>

    <script>
        // ========================================================================
        // ⚠️ PASTE YOUR ZOHO WEBHOOK URL HERE ⚠️ (MOCK DATA WILL BE USED IF EMPTY)
        // ========================================================================
        const ZOHO_API_URL = "https://cliq.zoho.com/api/v2/functions/apischema/invoke?zapikey=1001.3d8aae64bab5fe65c5682907e19fcb45.41d161bac1cea527694b74dbdc843360";  
        const IS_MOCK_MODE = ZOHO_API_URL.includes("PASTE_YOUR") || ZOHO_API_URL === "";

        // --- 1. AUTHENTICATION ---
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        let currentUser = null;

        if (token) {
            try {
                const decoded = atob(token);
                const parts = decoded.split("::");
                if (parts.length === 2) {
                    currentUser = { id: parts[1], name: parts[0].split('@')[0], email: parts[0], role: 'owner' };
                }
            } catch (e) { console.error("Auth Failed", e); }
        }

        // --- 2. STATE ---
        const initialState = {
            darkMode: false,
            currentView: 'list',
            currentUser: currentUser,
            showLogin: !currentUser,
            
            workspaces: [{ id: 1, name: 'Main Workspace', collapsed: false }],
            selectedWorkspace: 1,
            projects: [
                { id: 101, name: 'Marketing Campaign', color: 'bg-purple-500', workspaceId: 1, collapsed: false },
                { id: 102, name: 'Product Development', color: 'bg-blue-500', workspaceId: 1, collapsed: false }
            ],
            selectedProject: 101,
            
            groups: [
                { id: 1, name: 'To Do', projectId: 101, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date', 'Department'] },
                { id: 2, name: 'In Progress', projectId: 101, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date', 'Department'] },
                { id: 3, name: 'Done', projectId: 101, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date', 'Department'] }
            ],
            
            tasks: [], // Mock data will be loaded here
            
            ui: {
                showNewWorkspace: false, showWorkspaceMenu: false, 
                showNewProject: false, showNewGroup: false,
                editingColumns: null, showNewTask: null,
                newTask: { name: '', assignee: null, priority: 'Medium', status: 'Not Started', dueDate: new Date().toISOString().split('T')[0], customFields: {} }
            }
        };

        let state = { ...initialState };

        // Utility function to determine group ID based on status
        function getGroupId(status) {
            if(status === 'In Progress') return 2;
            if(status === 'Done') return 3;
            return 1;
        }

        // --- 3. API ENGINE (Stubs for demonstration) ---
        const api = {
            fetchTasks: async () => {
                if (IS_MOCK_MODE) {
                    if(state.tasks.length === 0) {
                      state.tasks.push(
                        { id: 'm1', name: 'Design new landing page', status: 'In Progress', priority: 'High', assignee: { name: 'You', id: 0 }, dueDate: '2025-12-01', customFields: { 'Department': 'Marketing' }, projectId: 101, groupId: 2 },
                        { id: 'm2', name: 'Review Q4 budget', status: 'Done', priority: 'Critical', assignee: { name: 'Admin', id: 1 }, dueDate: '2025-11-15', customFields: { 'Department': 'Finance' }, projectId: 101, groupId: 3 },
                        { id: 'm3', name: 'Setup tracking tags', status: 'Not Started', priority: 'Medium', assignee: null, dueDate: '2025-12-10', customFields: { 'Department': 'Marketing' }, projectId: 101, groupId: 1 }
                      );
                    }
                    actions.render();
                    return;
                }
                // Real API fetch logic (omitted for brevity, keeping structure)
                try {
                    const res = await fetch(`${ZOHO_API_URL}&request_method=GET&user_email=${state.currentUser.email}`);
                    const json = await res.json();
                    if(json.status === 'success' && json.data) {
                        state.tasks = json.data.map(/* mapping logic here */);
                        actions.render();
                    }
                } catch (e) { console.error("Sync Error", e); }
            },
            createTask: async (groupId) => {
                const taskData = state.ui.newTask;
                if(!taskData.name.trim()) return;
                const tempId = Date.now();
                // Add task to frontend state immediately
                state.tasks.push({ id: tempId, groupId, projectId: state.selectedProject, ...taskData });
                state.ui.showNewTask = null;
                actions.render();
                
                // API Call (stub)
                if (!IS_MOCK_MODE) {
                    const packed = JSON.stringify({ duedate: taskData.dueDate, custom: taskData.customFields });
                    try {
                        await fetch(`${ZOHO_API_URL}&request_method=POST&action=create&name=${encodeURIComponent(taskData.name)}&user_email=${state.currentUser.email}&attributes=${encodeURIComponent(packed)}`);
                        api.fetchTasks();
                    } catch (e) { console.error("Create Error", e); }
                }
            },
            deleteTask: async (id) => {
                state.tasks = state.tasks.filter(t => t.id !== id);
                actions.render();
                // API Call (stub)
                // if (!IS_MOCK_MODE) { await fetch(`${ZOHO_API_URL}&request_method=POST&action=delete&id=${id}`); }
            }
        };


        // --- 4. ACTIONS & LOGIC ---
        const actions = {
            render: () => renderApp(),
            toggleTheme: () => { state.darkMode = !state.darkMode; document.documentElement.classList.toggle('dark', state.darkMode); actions.render(); },
            setView: (view) => { state.currentView = view; actions.render(); },
            
            // Workspace Actions (FULLY WORKING)
            toggleWorkspaceMenu: () => { state.ui.showWorkspaceMenu = !state.ui.showWorkspaceMenu; actions.render(); },
            setShowNewWorkspace: (v) => { state.ui.showNewWorkspace = v; actions.render(); },
            addWorkspace: () => { 
                const val = document.getElementById('ws-input').value; 
                if(val && val.trim()){ 
                    const newId = Date.now();
                    state.workspaces.push({id: newId, name: val.trim(), collapsed:false}); 
                    state.selectedWorkspace = newId; 
                    state.ui.showNewWorkspace = false; 
                    actions.render(); 
                }
            },
            renameWorkspace: (id) => {
                const ws = state.workspaces.find(x=>x.id===id);
                const newName = prompt(`Rename workspace "${ws.name}":`, ws.name);
                if (newName && newName.trim()) { ws.name = newName.trim(); actions.render(); }
            },
            deleteWorkspace: (id) => {
                if(state.workspaces.length > 1 && confirm('Are you sure you want to delete this workspace and all its projects/tasks?')) {
                    state.workspaces = state.workspaces.filter(w => w.id !== id);
                    state.projects = state.projects.filter(p => p.workspaceId !== id);
                    state.tasks = state.tasks.filter(t => state.projects.some(p => p.id === t.projectId));
                    state.selectedWorkspace = state.workspaces[0].id;
                    state.selectedProject = state.projects.find(p => p.workspaceId === state.selectedWorkspace)?.id || null;
                    actions.render();
                } else if(state.workspaces.length === 1) {
                    alert('Cannot delete the last workspace.');
                }
            },

            // Project Actions (FULLY WORKING)
            setShowNewProject: (v) => { state.ui.showNewProject = v; actions.render(); },
            addProject: () => { 
                const val = document.getElementById('proj-input').value; 
                if(val && val.trim()){ 
                    const newId = Date.now();
                    state.projects.push({id: newId, name: val.trim(), color: 'bg-green-500', workspaceId:state.selectedWorkspace, collapsed:false}); 
                    state.selectedProject = newId; 
                    state.ui.showNewProject = false; 
                    actions.render(); 
                }
            },
            selectProject: (id) => { state.selectedProject = id; actions.render(); },
            renameProject: (id) => {
                const proj = state.projects.find(x=>x.id===id);
                const newName = prompt(`Rename project "${proj.name}":`, proj.name);
                if (newName && newName.trim()) { proj.name = newName.trim(); actions.render(); }
            },
            deleteProject: (id) => {
                if(confirm('Are you sure you want to delete this project and all its tasks?')) {
                    state.projects = state.projects.filter(p => p.id !== id);
                    state.tasks = state.tasks.filter(t => t.projectId !== id);
                    state.groups = state.groups.filter(g => g.projectId !== id);
                    // Select the first available project in the current workspace, or null
                    state.selectedProject = state.projects.find(p => p.workspaceId === state.selectedWorkspace)?.id || null;
                    actions.render();
                }
            },

            // Group Actions (FULLY WORKING)
            setShowNewGroup: (v) => { state.ui.showNewGroup = v; actions.render(); },
            addGroup: () => { const val = document.getElementById('grp-input').value; if(val){ state.groups.push({id: Date.now(), name: val, projectId: state.selectedProject, collapsed: false, columns:['Task', 'Priority', 'Status']}); state.ui.showNewGroup = false; actions.render(); }},
            toggleGroup: (id) => { const g = state.groups.find(x=>x.id===id); if(g) g.collapsed = !g.collapsed; actions.render(); },
            deleteGroup: (id) => { 
                state.groups = state.groups.filter(g=>g.id!==id); 
                state.tasks = state.tasks.filter(t=>t.groupId !== id);
                actions.render(); 
            },
            renameGroup: (id) => {
                const grp = state.groups.find(x=>x.id===id);
                const newName = prompt(`Rename group "${grp.name}":`, grp.name);
                if (newName && newName.trim()) { grp.name = newName.trim(); actions.render(); }
            },

            // Column Actions (FULLY WORKING)
            setEditingColumns: (id) => { state.ui.editingColumns = state.ui.editingColumns === id ? null : id; actions.render(); },
            addColumn: (grpId) => { 
                const input = document.getElementById(`col-input-${grpId}`);
                const val = input.value.trim(); 
                if(val){ 
                    state.groups.find(g=>g.id===grpId).columns.push(val); 
                    input.value = '';
                    actions.render(); 
                }
            },
            deleteColumn: (grpId, col) => { 
                const g = state.groups.find(g=>g.id===grpId); 
                g.columns = g.columns.filter(c=>c!==col); 
                actions.render(); 
            },

            // Task Actions (FULLY WORKING)
            setShowNewTask: (id) => { 
                state.ui.showNewTask = state.ui.showNewTask === id ? null : id;
                state.ui.newTask = {name:'', priority:'Medium', status:'Not Started', dueDate: new Date().toISOString().split('T')[0], customFields:{}}; 
                actions.render(); 
            },
            updateNewTaskField: (f, v) => { if(f.startsWith('c_')) state.ui.newTask.customFields[f.substring(2)] = v; else state.ui.newTask[f] = v; },
            addTask: (grpId) => { 
                const inp = document.getElementById(`new-task-name-${grpId}`); 
                if(inp){ 
                    state.ui.newTask.name = inp.value; 
                    api.createTask(grpId); 
                } 
            },
            deleteTask: (id) => api.deleteTask(id),
            renameTask: (id, currentName) => {
                const task = state.tasks.find(t=>t.id===id);
                const newName = prompt(`Rename task "${currentName}":`, currentName);
                if (newName && newName.trim()) { 
                    task.name = newName.trim(); 
                    actions.render(); 
                }
            }
        };
        window.actions = actions;

        // --- 5. RENDERERS ---
        const cardBg = () => state.darkMode ? 'bg-gray-800' : 'bg-white';
        const txtCol = () => state.darkMode ? 'text-gray-100' : 'text-gray-800';
        const border = () => state.darkMode ? 'border-gray-700' : 'border-gray-200';
        const inputBg = () => state.darkMode ? 'bg-gray-700' : 'bg-white';
        const hoverBg = () => state.darkMode ? 'hover:bg-gray-750' : 'hover:bg-gray-100';

        function renderSidebar() {
            const selectedWs = state.workspaces.find(w => w.id === state.selectedWorkspace);
            const currentProjects = state.projects.filter(p => p.workspaceId === state.selectedWorkspace);
            
            return `
                <div class="w-64 ${cardBg()} border-r ${border()} flex flex-col h-full">
                    <div class="p-6 border-b ${border()}"><h1 class="text-2xl font-bold ${txtCol()}">WellTask</h1></div>
                    <nav class="flex-1 p-4 overflow-y-auto">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-gray-500">WORKSPACES</span>
                                <button onclick="actions.toggleWorkspaceMenu()" class="text-blue-500"><i data-lucide="settings" class="w-4 h-4"></i></button>
                            </div>

                                                        ${state.workspaces.map(ws => `
                                <div 
                                    onclick="state.selectedWorkspace = ${ws.id}; state.selectedProject = state.projects.find(p=>p.workspaceId===${ws.id})?.id || null; actions.render();"
                                    class="px-3 py-2 rounded font-medium mb-2 flex justify-between items-center cursor-pointer 
                                    ${state.selectedWorkspace === ws.id ? 'bg-blue-600 text-white' : 'bg-blue-50 text-blue-700 hover:bg-blue-100'}">
                                        <span>${ws.name}</span>
                                        <button onclick="event.stopPropagation(); actions.renameWorkspace(${ws.id})" class="text-current opacity-75 hover:opacity-100"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                </div>
                            `).join('')}

                            ${state.ui.showWorkspaceMenu ? `
                                <div class="p-2 border rounded mb-2 space-y-2">
                                    <button onclick="actions.setShowNewWorkspace(true)" class="text-sm flex gap-2 ${txtCol()} ${hoverBg()} w-full p-1 rounded"><i data-lucide="plus" class="w-4"></i> New Workspace</button>
                                    ${state.workspaces.length > 1 ? `<button onclick="actions.deleteWorkspace(${selectedWs.id})" class="text-red-500 text-sm flex gap-2 ${hoverBg()} w-full p-1 rounded"><i data-lucide="trash-2" class="w-4"></i> Delete Workspace</button>` : ''}
                                </div>
                            ` : ''}

                            ${state.ui.showNewWorkspace ? `<div class="mb-2"><input id="ws-input" class="w-full border p-1 rounded mb-1 text-sm ${inputBg()}" placeholder="Name"><button onclick="actions.addWorkspace()" class="bg-green-500 text-white px-2 py-1 rounded text-xs">Add</button></div>` : ''}
                        </div>
                        <div>
                            <div class="flex justify-between mb-2"><span class="text-xs font-bold text-gray-500">PROJECTS (${selectedWs.name})</span> <button onclick="actions.setShowNewProject(true)" class="text-blue-500"><i data-lucide="plus" class="w-4 h-4"></i></button></div>
                            ${state.ui.showNewProject ? `<div class="mb-2"><input id="proj-input" class="w-full border p-1 rounded mb-1 text-sm ${inputBg()}" placeholder="Project Name"><button onclick="actions.addProject()" class="bg-green-500 text-white px-2 py-1 rounded text-xs">Add</button></div>` : ''}
                            ${currentProjects.map(p => `
                                <div class="flex items-center justify-between px-3 py-2 rounded cursor-pointer ${state.selectedProject===p.id ? 'bg-blue-600 text-white' : `${hoverBg()} ${txtCol()}`}">
                                    <div onclick="actions.selectProject(${p.id})" class="flex items-center gap-2 flex-1">
                                        <div class="w-2 h-2 rounded-full ${p.color}"></div>
                                        <span class="text-sm">${p.name}</span>
                                    </div>
                                    <div class="flex gap-2 text-gray-400 ${state.selectedProject===p.id ? 'text-white' : ''}">
                                        <button onclick="actions.renameProject(${p.id})" class="hover:text-blue-300"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                        <button onclick="actions.deleteProject(${p.id})" class="hover:text-red-300"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </nav>
                    <div class="p-4 border-t ${border()}"><button onclick="actions.toggleTheme()" class="flex justify-between w-full ${txtCol()}"><span>Theme</span><i data-lucide="${state.darkMode?'sun':'moon'}" class="w-4"></i></button></div>
                </div>
            `;
        }

        function renderListView() {
            const proj = state.projects.find(p=>p.id === state.selectedProject);
            const groups = state.groups.filter(g=>g.projectId === state.selectedProject);
            
            if (!proj) return `<div class="p-8 h-full flex justify-center items-center ${txtCol()}">Select or Create a Project</div>`;

            const header = `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded flex items-center justify-center text-white font-bold ${proj.color}">${proj.name[0]}</div>
                        <h1 class="text-2xl font-bold ${txtCol()}">${proj.name}</h1>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="actions.setView('kanban')" class="bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white px-4 py-2 rounded flex gap-2 items-center hover:bg-gray-300 dark:hover:bg-gray-600"><i data-lucide="grid-3x3" class="w-4"></i> Kanban View</button>
                        <button onclick="actions.setShowNewGroup(true)" class="bg-blue-600 text-white px-4 py-2 rounded flex gap-2 items-center"><i data-lucide="plus" class="w-4"></i> New Group</button>
                    </div>
                </div>
                ${state.ui.showNewGroup ? `<div class="p-4 border rounded mb-4 ${cardBg()}"><div class="flex gap-2"><input id="grp-input" class="border p-2 rounded flex-1 ${inputBg()} ${txtCol()}" placeholder="Group Name"><button onclick="actions.addGroup()" class="bg-green-500 text-white px-4 rounded">Save</button></div></div>` : ''}
            `;

            const groupHtml = groups.map(grp => {
                const tasks = state.tasks.filter(t=>t.projectId === state.selectedProject && t.groupId === grp.id);
                const gridCols = `repeat(${grp.columns.length}, minmax(100px, 1fr)) 50px`; 
                
                // Helper to render input fields for creating a task
                const renderNewInputs = () => grp.columns.map(col => {
                    if(col === 'Task') return `<input id="new-task-name-${grp.id}" class="border p-1 rounded w-full ${inputBg()} ${txtCol()}" placeholder="Task Name">`;
                    if(col === 'Priority') return `<select onchange="actions.updateNewTaskField('priority', this.value)" class="border p-1 rounded w-full ${inputBg()} ${txtCol()}"><option ${state.ui.newTask.priority==='Medium'?'selected':''}>Medium</option><option ${state.ui.newTask.priority==='High'?'selected':''}>High</option><option ${state.ui.newTask.priority==='Low'?'selected':''}>Low</option><option ${state.ui.newTask.priority==='Critical'?'selected':''}>Critical</option></select>`;
                    if(col === 'Status') return `<select onchange="actions.updateNewTaskField('status', this.value)" class="border p-1 rounded w-full ${inputBg()} ${txtCol()}"><option ${state.ui.newTask.status==='Not Started'?'selected':''}>Not Started</option><option ${state.ui.newTask.status==='In Progress'?'selected':''}>In Progress</option><option ${state.ui.newTask.status==='Done'?'selected':''}>Done</option></select>`;
                    if(col === 'Due Date') return `<input type="date" value="${state.ui.newTask.dueDate}" onchange="actions.updateNewTaskField('dueDate', this.value)" class="border p-1 rounded w-full ${inputBg()} ${txtCol()}">`;
                    if(col === 'Assignee') return `<select class="border p-1 rounded w-full ${inputBg()} ${txtCol()}"><option>Unassigned</option><option>You</option><option>Admin</option></select>`;
                    // Custom Field
                    return `<input onchange="actions.updateNewTaskField('c_${col}', this.value)" class="border p-1 rounded w-full ${inputBg()} ${txtCol()}" placeholder="${col}">`;
                }).join('');

                // Helper to render READ-ONLY rows
                const renderRow = (t) => grp.columns.map(col => {
                    if(col==='Task') return `<span onclick="actions.renameTask('${t.id}', '${t.name}')" class="font-medium ${txtCol()} cursor-pointer hover:underline">${t.name}</span>`;
                    if(col==='Priority') {
                        const colors = {'High':'bg-orange-100 text-orange-700','Medium':'bg-yellow-100 text-yellow-700','Critical':'bg-red-100 text-red-700','Low':'bg-blue-100 text-blue-700'};
                        return `<span class="px-2 py-1 rounded text-xs ${colors[t.priority] || 'bg-gray-100'}">${t.priority}</span>`;
                    }
                    if(col==='Status') return `<span class="px-2 py-1 rounded text-xs bg-blue-500 text-white">${t.status}</span>`;
                    if(col==='Due Date') return `<span class="text-sm text-gray-500">${t.dueDate || '-'}</span>`;
                    if(col==='Assignee') return `<span class="text-sm text-gray-500">${t.assignee ? t.assignee.name : 'Unassigned'}</span>`;
                    // Custom Field Logic
                    return `<span class="text-sm text-gray-500">${t.customFields[col] || '-'}</span>`;
                }).join('');

                return `
                    <div class="mb-8">
                                                <div class="flex justify-between items-center mb-2 p-2 rounded ${hoverBg()} group">
                            <div class="flex items-center gap-2">
                                <button onclick="actions.toggleGroup(${grp.id})"><i data-lucide="${grp.collapsed?'chevron-right':'chevron-down'}" class="w-4 ${txtCol()}"></i></button>
                                <span onclick="actions.renameGroup(${grp.id})" class="font-bold text-lg ${txtCol()} cursor-pointer hover:underline">${grp.name}</span>
                                <span class="bg-gray-200 text-gray-600 px-2 rounded-full text-xs ml-2">${tasks.length}</span>
                            </div>
                            
                            <div class="flex gap-3 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="actions.setEditingColumns(${grp.id})" class="text-purple-600 text-sm flex gap-1 items-center ${hoverBg()} p-1 rounded"><i data-lucide="settings" class="w-4"></i> Columns</button>
                                <button onclick="actions.setShowNewTask(${grp.id})" class="text-blue-600 text-sm flex gap-1 items-center ${hoverBg()} p-1 rounded"><i data-lucide="plus" class="w-4"></i> Add Task</button>
                                <button onclick="actions.deleteGroup(${grp.id})" class="text-red-500 ${hoverBg()} p-1 rounded"><i data-lucide="trash-2" class="w-4"></i></button>
                            </div>
                        </div>

                        ${state.ui.editingColumns === grp.id ? `
                            <div class="p-4 border rounded mb-2 ${cardBg()}">
                                <h4 class="font-bold text-sm mb-2 ${txtCol()}">Edit Columns:</h4>
                                <div class="flex gap-2 mb-4">
                                    <input id="col-input-${grp.id}" class="border p-2 flex-1 rounded ${inputBg()} ${txtCol()}" placeholder="New Custom Column Name">
                                    <button onclick="actions.addColumn(${grp.id})" class="bg-blue-600 text-white px-3 rounded">Add</button>
                                </div>
                                <div class="flex gap-2 flex-wrap">${grp.columns.map(c=>`<div class="bg-gray-200 dark:bg-gray-700 dark:text-gray-200 px-2 py-1 rounded flex gap-2 items-center text-sm">${c} <button onclick="actions.deleteColumn(${grp.id}, '${c}')" class="text-red-500 hover:text-red-700">×</button></div>`).join('')}</div>
                            </div>
                        ` : ''}

                        ${!grp.collapsed ? `
                            <div class="${cardBg()} border ${border()} rounded-lg shadow-sm">
                                                                <div class="grid gap-4 p-3 border-b ${border()} bg-gray-50 dark:bg-gray-700 font-semibold text-sm text-gray-500 dark:text-gray-300" style="grid-template-columns: ${gridCols}">
                                    ${grp.columns.map(c => `<div class="text-left">${c}</div>`).join('')} <div></div>
                                </div>
                                
                                                                ${state.ui.showNewTask === grp.id ? `
                                    <div class="grid gap-4 p-3 border-b ${border()} bg-blue-50 dark:bg-gray-900 items-center" style="grid-template-columns: ${gridCols}">
                                        ${renderNewInputs()}
                                        <div class="flex gap-2">
                                            <button onclick="actions.addTask(${grp.id})" class="text-green-600 hover:text-green-800"><i data-lucide="check" class="w-4"></i></button>
                                            <button onclick="actions.setShowNewTask(null)" class="text-red-500 hover:text-red-700"><i data-lucide="x" class="w-4"></i></button>
                                        </div>
                                    </div>
                                ` : ''}

                                                                ${tasks.map(t => `
                                    <div class="grid gap-4 p-3 border-b ${border()} ${hoverBg()} items-center transition" style="grid-template-columns: ${gridCols}">
                                        ${renderRow(t)}
                                        <button onclick="actions.deleteTask('${t.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4"></i></button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            return `<div class="p-8 h-full overflow-auto">${header}${groupHtml}</div>`;
        }

        function renderApp() {
            const app = document.getElementById('app');
            if(state.showLogin) {
                app.innerHTML = `<div class="flex h-screen justify-center items-center bg-gray-100 text-gray-500 text-xl">Please access via Zoho Cliq Widget</div>`;
            } else {
                const { darkMode } = state;
                const bg = darkMode ? 'bg-gray-900' : 'bg-gray-50';
                document.body.className = `bg-gray-50 text-gray-800 transition-colors duration-200 ${darkMode ? 'dark' : ''}`;
                app.innerHTML = `<div class="flex h-screen ${bg}">${renderSidebar()}<div class="flex-1 overflow-hidden">${state.currentView === 'list' ? renderListView() : renderKanbanView()}</div></div>`;
            }
            lucide.createIcons();
        }
        
        // Kanban View
        function renderKanbanView() {
             const { tasks, groups, darkMode } = state;
             const proj = state.projects.find(p=>p.id === state.selectedProject);

             if (!proj) return `<div class="p-8 h-full flex justify-center items-center ${txtCol()}">Select or Create a Project</div>`;

             const header = `<div class="flex justify-between p-6 border-b ${border()}"><h1 class="text-2xl font-bold ${txtCol()}">Kanban Board: ${proj.name}</h1><button onclick="actions.setView('list')" class="bg-gray-600 text-white px-4 py-2 rounded flex gap-2 items-center"><i data-lucide="layout-list" class="w-4"></i> List View</button></div>`;
             
             const cols = groups.filter(g=>g.projectId === state.selectedProject).map(g => {
                 const gTasks = tasks.filter(t=>t.groupId === g.id);
                 return `<div class="p-4 rounded ${cardBg()} flex-1 h-full overflow-y-auto min-w-[280px] max-w-[350px]"><h3 class="font-bold mb-4 ${txtCol()}">${g.name} (${gTasks.length})</h3><div class="space-y-3">${gTasks.map(t=>`<div class="p-3 border rounded ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-white hover:bg-gray-100'} ${txtCol()}">${t.name}</div>`).join('')}</div></div>`;
             }).join('');
             
             return `<div class="h-full flex flex-col">${header}<div class="flex gap-4 p-6 flex-1 overflow-x-auto">${cols}</div></div>`;
        }

        // INIT
        if(state.currentUser) api.fetchTasks();
        // If running in mock mode, do not attempt the repeated fetch, as it's purely frontend
        if(!IS_MOCK_MODE) {
          setInterval(() => { if(state.currentUser) api.fetchTasks(); }, 3000);
        }
        renderApp();

    </script>
</body>
</html>
