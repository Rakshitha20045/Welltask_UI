<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WellTask - Vanilla JS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748', // Custom for dark mode inputs
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar for cleaner UI */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        
        /* Hide scrollbar for specific elements but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-200">

    <div id="app"></div>

    <script>
        // --- 1. INITIAL STATE (Copied from React) ---
        const initialState = {
            darkMode: false,
            currentView: 'list',
            currentUser: null,
            showLogin: true,
            
            workspaces: [{ 
                id: 1, name: 'My Workspace', ownerId: 1, 
                members: [{ id: 1, name: 'You', email: 'you@example.com', role: 'owner' }], 
                collapsed: false 
            }],
            selectedWorkspace: 1,
            
            projects: [
                { id: 1, name: 'Marketing Campaign', color: 'bg-purple-500', workspaceId: 1, collapsed: false },
                { id: 2, name: 'Product Development', color: 'bg-blue-500', workspaceId: 1, collapsed: false }
            ],
            selectedProject: 1,
            
            groups: [
                { id: 1, name: 'To Do', projectId: 1, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] },
                { id: 2, name: 'In Progress', projectId: 1, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] },
                { id: 3, name: 'Planning', projectId: 2, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] }
            ],
            
            tasks: [
                { id: 1, groupId: 1, projectId: 1, name: 'Design social media graphics', assignee: null, priority: 'High', status: 'Not Started', dueDate: '2025-11-25', customFields: {} },
                { id: 2, groupId: 1, projectId: 1, name: 'Write blog post', assignee: null, priority: 'Medium', status: 'In Progress', dueDate: '2025-11-22', customFields: {} },
                { id: 3, groupId: 2, projectId: 1, name: 'Email campaign setup', assignee: null, priority: 'Critical', status: 'In Progress', dueDate: '2025-11-20', customFields: {} }
            ],

            // UI Temporary State
            ui: {
                showNewWorkspace: false,
                showWorkspaceMenu: false,
                editingWorkspace: null,
                showNewProject: false,
                editingProject: null,
                showNewGroup: false,
                editingGroup: null,
                editingColumns: null, // groupId
                showNewTask: null, // groupId
                showInviteModal: false,
                showMembersModal: false,
                
                // Input buffers
                loginEmail: '',
                loginRole: 'member',
                newWorkspaceName: '',
                newProjectName: '',
                newGroupName: '',
                newColumnName: '',
                inviteEmail: '',
                inviteRole: 'member',
                
                newTask: {
                    name: '', assignee: null, priority: 'Medium', status: 'Not Started', 
                    dueDate: new Date().toISOString().split('T')[0], customFields: {}
                }
            }
        };

        // Global State Object (Reactive-ish)
        let state = { ...initialState };

        // --- 2. HELPERS & UTILS ---
        const priorityColors = (priority, dark) => {
            const map = {
                'Low': dark ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700',
                'Medium': dark ? 'bg-yellow-900 text-yellow-300' : 'bg-yellow-100 text-yellow-700',
                'High': dark ? 'bg-orange-900 text-orange-300' : 'bg-orange-100 text-orange-700',
                'Critical': dark ? 'bg-red-900 text-red-300' : 'bg-red-100 text-red-700'
            };
            return map[priority] || '';
        };

        const statusColors = (status, dark) => {
            const map = {
                'Not Started': dark ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-700',
                'In Progress': dark ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white',
                'Done': dark ? 'bg-green-900 text-green-300' : 'bg-green-500 text-white',
                'Blocked': dark ? 'bg-red-900 text-red-300' : 'bg-red-500 text-white'
            };
            return map[status] || '';
        };

        // --- 3. ACTIONS (Business Logic) ---
        // We attach these to window so HTML strings can call them
        const actions = {
            render: () => renderApp(),
            
            // Login
            setLoginEmail: (v) => { state.ui.loginEmail = v; }, // No re-render needed usually, keeping input live
            setLoginRole: (v) => { state.ui.loginRole = v; actions.render(); },
            login: () => {
                if(state.ui.loginEmail.trim()) {
                    const user = { id: Date.now(), name: state.ui.loginEmail.split('@')[0], email: state.ui.loginEmail, role: state.ui.loginRole };
                    state.currentUser = user;
                    state.showLogin = false;
                    // Add to workspace members if not there
                    const ws = state.workspaces.find(w => w.id === state.selectedWorkspace);
                    if (ws && !ws.members.find(m => m.email === user.email)) {
                        ws.members.push(user);
                    }
                    actions.render();
                }
            },

            // View & Theme
            toggleTheme: () => { 
                state.darkMode = !state.darkMode; 
                document.documentElement.classList.toggle('dark', state.darkMode);
                actions.render(); 
            },
            setView: (view) => { state.currentView = view; actions.render(); },

            // Workspace
            toggleWorkspaceMenu: () => { state.ui.showWorkspaceMenu = !state.ui.showWorkspaceMenu; actions.render(); },
            toggleWorkspaceCollapse: (id) => { 
                const w = state.workspaces.find(x => x.id === id);
                if(w) w.collapsed = !w.collapsed;
                actions.render();
            },
            setEditingWorkspace: (id) => { state.ui.editingWorkspace = id; actions.render(); },
            renameWorkspace: (id, name) => {
                if(name.trim()) {
                    const w = state.workspaces.find(x => x.id === id);
                    if(w) w.name = name;
                    state.ui.editingWorkspace = null;
                    actions.render();
                }
            },
            setShowNewWorkspace: (val) => { state.ui.showNewWorkspace = val; state.ui.newWorkspaceName = ''; actions.render(); },
            addWorkspace: () => {
                const name = document.getElementById('input-new-ws').value;
                if(name.trim()) {
                    const newWs = { id: Date.now(), name, ownerId: state.currentUser.id, members: [state.currentUser], collapsed: false };
                    state.workspaces.push(newWs);
                    state.selectedWorkspace = newWs.id;
                    state.ui.showNewWorkspace = false;
                    actions.render();
                }
            },
            selectWorkspace: (id) => { state.selectedWorkspace = id; actions.render(); },

            // Projects
            setShowNewProject: (val) => { state.ui.showNewProject = val; state.ui.newProjectName = ''; actions.render(); },
            addProject: () => {
                const name = document.getElementById('input-new-proj').value;
                if(name.trim()) {
                    const colors = ['bg-purple-500', 'bg-blue-500', 'bg-green-500', 'bg-orange-500', 'bg-pink-500', 'bg-indigo-500', 'bg-red-500'];
                    const newProj = { id: Date.now(), name, color: colors[Math.floor(Math.random() * colors.length)], workspaceId: state.selectedWorkspace, collapsed: false };
                    state.projects.push(newProj);
                    state.selectedProject = newProj.id;
                    state.ui.showNewProject = false;
                    actions.render();
                }
            },
            selectProject: (id) => { state.selectedProject = id; actions.render(); },
            toggleProjectCollapse: (id) => { 
                const p = state.projects.find(x => x.id === id); 
                if(p) p.collapsed = !p.collapsed; 
                actions.render(); 
            },
            setEditingProject: (id) => { state.ui.editingProject = id; actions.render(); },
            renameProject: (id, name) => {
                if(name.trim()) {
                    const p = state.projects.find(x => x.id === id);
                    if(p) p.name = name;
                    state.ui.editingProject = null;
                    actions.render();
                }
            },
            deleteProject: (id) => {
                const wsProjects = state.projects.filter(p => p.workspaceId === state.selectedWorkspace);
                if(wsProjects.length > 1) {
                    state.projects = state.projects.filter(p => p.id !== id);
                    state.groups = state.groups.filter(g => g.projectId !== id);
                    state.tasks = state.tasks.filter(t => t.projectId !== id);
                    if(state.selectedProject === id) state.selectedProject = wsProjects.find(p => p.id !== id).id;
                    actions.render();
                }
            },

            // Groups
            setShowNewGroup: (val) => { state.ui.showNewGroup = val; state.ui.newGroupName = ''; actions.render(); },
            addGroup: () => {
                const name = document.getElementById('input-new-group').value;
                if(name.trim()) {
                    state.groups.push({ id: Date.now(), name, projectId: state.selectedProject, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] });
                    state.ui.showNewGroup = false;
                    actions.render();
                }
            },
            toggleGroupCollapse: (id) => { const g = state.groups.find(x => x.id === id); if(g) g.collapsed = !g.collapsed; actions.render(); },
            setEditingGroup: (id) => { state.ui.editingGroup = id; actions.render(); },
            renameGroup: (id, name) => { 
                if(name.trim()) { 
                    const g = state.groups.find(x => x.id === id); 
                    if(g) g.name = name; 
                    state.ui.editingGroup = null; 
                    actions.render(); 
                } 
            },
            deleteGroup: (id) => {
                state.groups = state.groups.filter(g => g.id !== id);
                state.tasks = state.tasks.filter(t => t.groupId !== id);
                actions.render();
            },

            // Columns
            setEditingColumns: (groupId) => { state.ui.editingColumns = state.ui.editingColumns === groupId ? null : groupId; actions.render(); },
            addCustomColumn: (groupId) => {
                const name = document.getElementById(`input-new-col-${groupId}`).value;
                if(name.trim()) {
                    const g = state.groups.find(x => x.id === groupId);
                    g.columns.push(name);
                    actions.render();
                }
            },
            renameColumn: (groupId, oldName, newName) => {
                if(newName.trim() && newName !== oldName) {
                    const g = state.groups.find(x => x.id === groupId);
                    g.columns = g.columns.map(c => c === oldName ? newName : c);
                    // Update custom fields in tasks
                    if (!['Task', 'Assignee', 'Priority', 'Status', 'Due Date'].includes(oldName)) {
                        state.tasks.forEach(t => {
                            if(t.groupId === groupId && t.customFields[oldName]) {
                                t.customFields[newName] = t.customFields[oldName];
                                delete t.customFields[oldName];
                            }
                        });
                    }
                    actions.render();
                }
            },
            deleteColumn: (groupId, colName) => {
                const g = state.groups.find(x => x.id === groupId);
                g.columns = g.columns.filter(c => c !== colName);
                // Cleanup tasks
                if (!['Task', 'Assignee', 'Priority', 'Status', 'Due Date'].includes(colName)) {
                    state.tasks.forEach(t => {
                        if(t.groupId === groupId) delete t.customFields[colName];
                    });
                }
                actions.render();
            },

            // Tasks
            setShowNewTask: (groupId) => { 
                state.ui.showNewTask = groupId; 
                // Reset new task buffer
                state.ui.newTask = { name: '', assignee: null, priority: 'Medium', status: 'Not Started', dueDate: new Date().toISOString().split('T')[0], customFields: {} };
                actions.render(); 
            },
            updateNewTaskField: (field, value) => {
                if(field.startsWith('custom_')) {
                    state.ui.newTask.customFields[field.replace('custom_', '')] = value;
                } else if (field === 'assignee') {
                     const ws = state.workspaces.find(w => w.id === state.selectedWorkspace);
                     const member = ws.members.find(m => m.id === parseInt(value));
                     state.ui.newTask.assignee = member || null;
                } else {
                    state.ui.newTask[field] = value;
                }
                // Don't re-render entire app on input change to prevent focus loss, 
                // but simpler for this vanilla implementation to rely on DOM values at submit time for text inputs, 
                // and only update state for selects if needed. 
                // We will gather values on "Add" click to be safe.
            },
            addTask: (groupId) => {
                // Gather values from DOM to ensure latest state
                const nameInput = document.getElementById(`new-task-name-${groupId}`);
                if(nameInput && nameInput.value.trim()) {
                    state.ui.newTask.name = nameInput.value;
                    // (Other fields are updated via onchange handlers usually, or we grab them here)
                    const task = { id: Date.now(), groupId, projectId: state.selectedProject, ...state.ui.newTask };
                    state.tasks.push(task);
                    state.ui.showNewTask = null;
                    actions.render();
                }
            },
            updateTask: (id, field, value) => {
                const t = state.tasks.find(x => x.id === id);
                if(t) {
                    if(field === 'assignee') {
                        const ws = state.workspaces.find(w => w.id === state.selectedWorkspace);
                        const member = ws.members.find(m => m.id === parseInt(value));
                        t.assignee = member || null;
                    } else if (field.startsWith('custom_')) {
                        t.customFields[field.replace('custom_', '')] = value;
                    } else {
                        t[field] = value;
                    }
                    actions.render();
                }
            },
            deleteTask: (id) => { state.tasks = state.tasks.filter(t => t.id !== id); actions.render(); },

            // Invites & Modals
            setShowInviteModal: (val) => { state.ui.showInviteModal = val; actions.render(); },
            setShowMembersModal: (val) => { state.ui.showMembersModal = val; actions.render(); },
            sendInvite: () => {
                const email = document.getElementById('invite-email').value;
                const role = document.getElementById('invite-role').value;
                if(email.trim()) {
                    const ws = state.workspaces.find(w => w.id === state.selectedWorkspace);
                    ws.members.push({ id: Date.now(), name: email.split('@')[0], email, role, invited: true });
                    alert(`Invitation sent to ${email}`);
                    state.ui.showInviteModal = false;
                    actions.render();
                }
            }
        };

        window.actions = actions; // Expose to global scope

        // --- 4. RENDERERS (HTML String Builders) ---

        function renderLogin() {
            const { darkMode } = state;
            const bgColor = darkMode ? 'bg-gray-900' : 'bg-gray-50';
            const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
            const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
            const inputBg = darkMode ? 'bg-gray-700' : 'bg-white';
            const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';

            return `
                <div class="min-h-screen flex items-center justify-center ${bgColor}">
                    <div class="${cardBg} rounded-lg shadow-xl p-8 w-96 border ${borderColor}">
                        <h1 class="text-3xl font-bold mb-6 text-center ${textColor}">WellTask</h1>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 ${textColor}">Email</label>
                                <input type="email" value="${state.ui.loginEmail}" 
                                    oninput="actions.setLoginEmail(this.value)"
                                    onkeypress="if(event.key === 'Enter') actions.login()"
                                    class="w-full px-4 py-2 border ${borderColor} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${inputBg} ${textColor}" 
                                    placeholder="your@email.com" autofocus />
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 ${textColor}">Role</label>
                                <select onchange="actions.setLoginRole(this.value)" class="w-full px-4 py-2 border ${borderColor} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${inputBg} ${textColor}">
                                    <option value="member" ${state.ui.loginRole === 'member' ? 'selected' : ''}>Member</option>
                                    <option value="owner" ${state.ui.loginRole === 'owner' ? 'selected' : ''}>Owner</option>
                                </select>
                            </div>
                            <button onclick="actions.login()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium">Sign In</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSidebar() {
            const { darkMode, selectedWorkspace, workspaces, projects, selectedProject } = state;
            const { showWorkspaceMenu, showNewWorkspace, editingWorkspace, showNewProject } = state.ui;
            
            const currentWs = workspaces.find(w => w.id === selectedWorkspace);
            const isOwner = state.currentUser && (state.currentUser.role === 'owner' || currentWs.ownerId === state.currentUser.id);
            const wsProjects = projects.filter(p => p.workspaceId === selectedWorkspace);

            const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
            const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
            const textSecondary = darkMode ? 'text-gray-400' : 'text-gray-600';
            const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';
            const hoverBg = darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100';
            const inputBg = darkMode ? 'bg-gray-700' : 'bg-white';

            // Workspace List HTML
            let otherWorkspacesHtml = !currentWs.collapsed ? workspaces.filter(w => w.id !== selectedWorkspace).map(w => `
                <div onclick="actions.selectWorkspace(${w.id})" class="flex items-center justify-between px-3 py-2 rounded-lg mb-1 cursor-pointer ${hoverBg} ${textColor}">
                    <span class="text-sm">${w.name}</span>
                </div>
            `).join('') : '';

            // Projects HTML
            let projectsHtml = wsProjects.map(p => `
                <div class="flex items-center justify-between px-3 py-2 rounded-lg mb-1 cursor-pointer transition ${selectedProject === p.id ? 'bg-blue-600 text-white' : `${textColor} ${hoverBg}`}"
                     onclick="actions.selectProject(${p.id})">
                    <div class="flex items-center gap-2 flex-1">
                        <div class="w-3 h-3 rounded-full ${p.color}"></div>
                        <span class="text-sm">${p.name}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="event.stopPropagation(); actions.toggleProjectCollapse(${p.id})" class="opacity-70 hover:opacity-100">
                            <i data-lucide="${p.collapsed ? 'chevron-right' : 'chevron-down'}" class="w-3.5 h-3.5"></i>
                        </button>
                        ${wsProjects.length > 1 ? `
                        <button onclick="event.stopPropagation(); actions.deleteProject(${p.id})" class="opacity-0 hover:opacity-100 group-hover:opacity-100">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>` : ''}
                    </div>
                </div>
            `).join('');

            return `
                <div class="w-64 ${cardBg} border-r ${borderColor} flex flex-col h-full">
                    <div class="p-6 border-b ${borderColor}"><h1 class="text-2xl font-bold ${textColor}">WellTask</h1></div>
                    <nav class="flex-1 p-4 overflow-y-auto">
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-semibold ${textSecondary} uppercase">Workspace</span>
                                <button onclick="actions.toggleWorkspaceMenu()" class="text-blue-600 hover:text-blue-700"><i data-lucide="settings" class="w-4 h-4"></i></button>
                            </div>

                            ${editingWorkspace === selectedWorkspace ? `
                                <input type="text" value="${currentWs.name}" 
                                    onblur="actions.renameWorkspace(${selectedWorkspace}, this.value)"
                                    onkeypress="if(event.key==='Enter') actions.renameWorkspace(${selectedWorkspace}, this.value)"
                                    class="w-full px-3 py-2 border ${borderColor} rounded-lg text-sm mb-2 ${inputBg} ${textColor}" autofocus />
                            ` : `
                                <div class="mb-2">
                                    <div class="flex items-center justify-between flex-1 px-3 py-2 rounded-lg cursor-pointer ${hoverBg} ${textColor} font-medium"
                                         onclick="${isOwner ? `actions.setEditingWorkspace(${selectedWorkspace})` : ''}">
                                        <span>${currentWs.name}</span>
                                        <button onclick="event.stopPropagation(); actions.toggleWorkspaceCollapse(${selectedWorkspace})" class="${textSecondary}">
                                            <i data-lucide="${currentWs.collapsed ? 'chevron-right' : 'chevron-down'}" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `}

                            ${showWorkspaceMenu ? `
                                <div class="${cardBg} border ${borderColor} rounded-lg p-2 mb-3 shadow-lg">
                                    <button onclick="actions.setShowInviteModal(true)" class="w-full text-left px-3 py-2 rounded ${hoverBg} ${textColor} text-sm flex items-center gap-2"><i data-lucide="mail" class="w-4 h-4"></i> Invite Members</button>
                                    <button onclick="actions.setShowMembersModal(true)" class="w-full text-left px-3 py-2 rounded ${hoverBg} ${textColor} text-sm flex items-center gap-2"><i data-lucide="user" class="w-4 h-4"></i> View Members</button>
                                    <button onclick="actions.setShowNewWorkspace(true)" class="w-full text-left px-3 py-2 rounded ${hoverBg} ${textColor} text-sm flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> New Workspace</button>
                                </div>
                            ` : ''}

                            ${showNewWorkspace ? `
                                <div class="mb-3">
                                    <input id="input-new-ws" type="text" placeholder="Workspace name..." class="w-full px-3 py-2 border ${borderColor} rounded-lg text-sm mb-2 ${inputBg} ${textColor}" onkeypress="if(event.key==='Enter') actions.addWorkspace()" autofocus />
                                    <div class="flex gap-2">
                                        <button onclick="actions.addWorkspace()" class="flex-1 bg-green-600 text-white py-1 rounded text-sm">Add</button>
                                        <button onclick="actions.setShowNewWorkspace(false)" class="flex-1 bg-gray-500 text-white py-1 rounded text-sm">Cancel</button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${otherWorkspacesHtml}
                        </div>

                        <div class="mt-8">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-semibold ${textSecondary} uppercase">Projects</span>
                                <button onclick="actions.setShowNewProject(true)" class="text-blue-600 hover:text-blue-700"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                            ${showNewProject ? `
                                <div class="mb-3">
                                    <input id="input-new-proj" type="text" placeholder="Project name..." class="w-full px-3 py-2 border ${borderColor} rounded-lg text-sm mb-2 ${inputBg} ${textColor}" onkeypress="if(event.key==='Enter') actions.addProject()" autofocus />
                                    <div class="flex gap-2">
                                        <button onclick="actions.addProject()" class="flex-1 bg-green-600 text-white py-1 rounded text-sm">Add</button>
                                        <button onclick="actions.setShowNewProject(false)" class="flex-1 bg-gray-500 text-white py-1 rounded text-sm">Cancel</button>
                                    </div>
                                </div>
                            ` : ''}
                            ${projectsHtml}
                        </div>
                    </nav>
                    <div class="p-4 border-t ${borderColor}">
                        <button onclick="actions.toggleTheme()" class="w-full flex items-center justify-between px-4 py-3 rounded-lg ${hoverBg} ${textColor}">
                            <span>Theme</span>
                            <i data-lucide="${darkMode ? 'sun' : 'moon'}" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderKanbanView() {
            const { tasks, selectedProject, projects, darkMode, ui } = state;
            const currentProject = projects.find(p => p.id === selectedProject);
            const statusColumns = ['Not Started', 'In Progress', 'Done', 'Blocked'];
            
            const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
            const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';
            const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
            const textSecondary = darkMode ? 'text-gray-400' : 'text-gray-600';
            const inputBg = darkMode ? 'bg-gray-700' : 'bg-white';

            // Header
            const headerHtml = `
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-lg ${currentProject?.color || 'bg-gray-500'} flex items-center justify-center text-white font-bold text-xl">
                            ${currentProject?.name.charAt(0) || '?'}
                        </div>
                        ${ui.editingProject === currentProject?.id ? `
                            <input type="text" value="${currentProject.name}" 
                                onblur="actions.renameProject(${currentProject.id}, this.value)"
                                onkeypress="if(event.key === 'Enter') actions.renameProject(${currentProject.id}, this.value)"
                                class="text-3xl font-bold ${inputBg} ${textColor} border ${borderColor} rounded px-2 py-1" autofocus />
                        ` : `
                            <h1 class="text-3xl font-bold ${textColor} cursor-pointer hover:text-blue-600" onclick="actions.setEditingProject(${currentProject?.id})">
                                ${currentProject?.name || 'No Project'}
                            </h1>
                        `}
                    </div>
                    <button onclick="actions.setView('list')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition flex items-center gap-2">
                        <i data-lucide="layout-list" class="w-5 h-5"></i> List View
                    </button>
                </div>
            `;

            // Columns
            const columnsHtml = statusColumns.map(status => {
                const statusTasks = tasks.filter(t => t.projectId === selectedProject && t.status === status);
                return `
                    <div class="${cardBg} rounded-lg border ${borderColor} p-4 min-h-[200px]">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold ${textColor}">${status}</h3>
                            <span class="${darkMode ? 'bg-gray-700' : 'bg-gray-200'} px-2 py-1 rounded-full text-sm ${textSecondary}">${statusTasks.length}</span>
                        </div>
                        <div class="space-y-3">
                            ${statusTasks.map(task => `
                                <div class="${darkMode ? 'bg-gray-700' : 'bg-white'} border ${borderColor} rounded-lg p-3 shadow-sm hover:shadow-md transition">
                                    <div class="font-medium mb-2 ${textColor}">${task.name}</div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs px-2 py-1 rounded ${priorityColors(task.priority, darkMode)}">${task.priority}</span>
                                        ${task.assignee ? `
                                            <div class="flex items-center gap-1">
                                                <i data-lucide="user" class="w-3.5 h-3.5 ${textSecondary}"></i>
                                                <span class="text-xs ${textSecondary}">${task.assignee.name}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="p-6 h-full overflow-auto">${headerHtml}<div class="grid grid-cols-4 gap-4">${columnsHtml}</div></div>`;
        }

        function renderListView() {
            const { tasks, selectedProject, projects, groups, darkMode, ui, workspaces, selectedWorkspace } = state;
            const currentProject = projects.find(p => p.id === selectedProject);
            const projectGroups = groups.filter(g => g.projectId === selectedProject);
            const ws = workspaces.find(w => w.id === selectedWorkspace);
            const members = ws ? ws.members : [];

            const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
            const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';
            const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
            const textSecondary = darkMode ? 'text-gray-400' : 'text-gray-600';
            const inputBg = darkMode ? 'bg-gray-700' : 'bg-white';
            const hoverBg = darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100';

            // Helpers for inputs in table
            const renderCellInput = (task, col) => {
                if (col === 'Task') return `<input type="text" value="${task.name}" onchange="actions.updateTask(${task.id}, 'name', this.value)" class="px-3 py-2 border ${borderColor} rounded-lg font-medium ${inputBg} ${textColor} w-full" />`;
                if (col === 'Assignee') return `
                    <select onchange="actions.updateTask(${task.id}, 'assignee', this.value)" class="px-3 py-2 border ${borderColor} rounded-lg text-sm ${inputBg} ${textColor} w-full">
                        <option value="">Unassigned</option>
                        ${members.map(m => `<option value="${m.id}" ${task.assignee?.id === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                    </select>
                `;
                if (col === 'Priority') return `
                    <select onchange="actions.updateTask(${task.id}, 'priority', this.value)" class="px-3 py-2 rounded-lg font-medium text-sm w-full ${priorityColors(task.priority, darkMode)}">
                        ${['Low', 'Medium', 'High', 'Critical'].map(p => `<option ${task.priority === p ? 'selected' : ''}>${p}</option>`).join('')}
                    </select>
                `;
                if (col === 'Status') return `
                    <select onchange="actions.updateTask(${task.id}, 'status', this.value)" class="px-3 py-2 rounded-lg font-medium text-sm w-full ${statusColors(task.status, darkMode)}">
                        ${['Not Started', 'In Progress', 'Done', 'Blocked'].map(s => `<option ${task.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                `;
                if (col === 'Due Date') return `<input type="date" value="${task.dueDate}" onchange="actions.updateTask(${task.id}, 'dueDate', this.value)" class="px-3 py-2 border ${borderColor} rounded-lg text-sm ${inputBg} ${textColor} w-full" />`;
                
                // Custom Field
                return `<input type="text" value="${task.customFields[col] || ''}" onchange="actions.updateTask(${task.id}, 'custom_${col}', this.value)" placeholder="${col}" class="px-3 py-2 border ${borderColor} rounded-lg text-sm ${inputBg} ${textColor} w-full" />`;
            };

            // Helper for New Task Row
            const renderNewTaskInput = (group, col) => {
                if (col === 'Task') return `<input id="new-task-name-${group.id}" type="text" placeholder="Task name..." onkeypress="if(event.key==='Enter') actions.addTask(${group.id})" class="px-3 py-2 border ${borderColor} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${inputBg} ${textColor} w-full" autofocus />`;
                if (col === 'Assignee') return `
                    <select onchange="actions.updateNewTaskField('assignee', this.value)" class="px-3 py-2 border ${borderColor} rounded-lg text-sm ${inputBg} ${textColor} w-full">
                        <option value="">Unassigned</option>
                        ${members.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                    </select>
                `;
                if (col === 'Priority') return `
                    <select onchange="actions.updateNewTaskField('priority', this.value)" class="px-3 py-2 rounded-lg font-medium text-sm w-full ${priorityColors(ui.newTask.priority, darkMode)}">
                        ${['Low', 'Medium', 'High', 'Critical'].map(p => `<option ${ui.newTask.priority === p ? 'selected' : ''}>${p}</option>`).join('')}
                    </select>
                `;
                if (col === 'Status') return `
                    <select onchange="actions.updateNewTaskField('status', this.value)" class="px-3 py-2 rounded-lg font-medium text-sm w-full ${statusColors(ui.newTask.status, darkMode)}">
                        ${['Not Started', 'In Progress', 'Done', 'Blocked'].map(s => `<option ${ui.newTask.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                `;
                if (col === 'Due Date') return `<input type="date" value="${ui.newTask.dueDate}" onchange="actions.updateNewTaskField('dueDate', this.value)" class="px-3 py-2 border ${borderColor} rounded-lg text-sm ${inputBg} ${textColor} w-full" />`;
                
                return `<input type="text" onchange="actions.updateNewTaskField('custom_${col}', this.value)" placeholder="${col}" class="px-3 py-2 border ${borderColor} rounded-lg text-sm ${inputBg} ${textColor} w-full" />`;
            }

            // Header
            const headerHtml = `
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-lg ${currentProject?.color || 'bg-gray-500'} flex items-center justify-center text-white font-bold text-xl">
                            ${currentProject?.name.charAt(0) || '?'}
                        </div>
                        ${ui.editingProject === currentProject?.id ? `
                            <input type="text" value="${currentProject.name}" 
                                onblur="actions.renameProject(${currentProject.id}, this.value)"
                                onkeypress="if(event.key === 'Enter') actions.renameProject(${currentProject.id}, this.value)"
                                class="text-3xl font-bold ${inputBg} ${textColor} border ${borderColor} rounded px-2 py-1" autofocus />
                        ` : `
                            <h1 class="text-3xl font-bold ${textColor} cursor-pointer hover:text-blue-600" onclick="actions.setEditingProject(${currentProject?.id})">
                                ${currentProject?.name || 'No Project'}
                            </h1>
                        `}
                    </div>
                    <div class="flex gap-3">
                        <button onclick="actions.setView('kanban')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition flex items-center gap-2">
                            <i data-lucide="grid-3x3" class="w-5 h-5"></i> Kanban View
                        </button>
                        <button onclick="actions.setShowNewGroup(true)" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                            <i data-lucide="plus" class="w-5 h-5"></i> New Group
                        </button>
                    </div>
                </div>
            `;

            // New Group Input
            const newGroupHtml = ui.showNewGroup ? `
                <div class="${cardBg} rounded-lg shadow-lg p-4 mb-4 border ${borderColor}">
                    <div class="flex gap-3">
                        <input id="input-new-group" type="text" placeholder="Group name..." onkeypress="if(event.key==='Enter') actions.addGroup()" class="flex-1 px-4 py-2 border ${borderColor} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${inputBg} ${textColor}" autofocus />
                        <button onclick="actions.addGroup()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"><i data-lucide="check" class="w-5 h-5"></i></button>
                        <button onclick="actions.setShowNewGroup(false)" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                </div>
            ` : '';

            // Groups
            const groupsHtml = projectGroups.map(group => {
                const groupTasks = tasks.filter(t => t.groupId === group.id);
                const gridCols = `repeat(${group.columns.length}, 1fr) 0.5fr`;

                return `
                    <div class="mb-6">
                        <div class="${cardBg} rounded-t-lg shadow-sm border ${borderColor} p-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <button onclick="actions.toggleGroupCollapse(${group.id})" class="${textColor}">
                                    <i data-lucide="${group.collapsed ? 'chevron-right' : 'chevron-down'}" class="w-5 h-5"></i>
                                </button>
                                ${ui.editingGroup === group.id ? `
                                    <input type="text" value="${group.name}" onblur="actions.renameGroup(${group.id}, this.value)" onkeypress="if(event.key==='Enter') actions.renameGroup(${group.id}, this.value)" class="font-bold text-lg ${inputBg} ${textColor} border ${borderColor} rounded px-2 py-1" autofocus />
                                ` : `
                                    <span class="font-bold text-lg ${textColor} cursor-pointer hover:text-blue-600" onclick="actions.setEditingGroup(${group.id})">${group.name}</span>
                                `}
                                <span class="${darkMode ? 'bg-gray-700' : 'bg-gray-200'} px-3 py-1 rounded-full text-sm ${textSecondary}">${groupTasks.length}</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="actions.setEditingColumns(${group.id})" class="text-purple-600 hover:text-purple-700 flex items-center gap-1 text-sm font-medium">
                                    <i data-lucide="settings" class="w-4 h-4"></i> Columns
                                </button>
                                <button onclick="actions.setShowNewTask(${group.id})" class="text-blue-600 hover:text-blue-700 flex items-center gap-1 text-sm font-medium">
                                    <i data-lucide="plus" class="w-4 h-4"></i> Add Task
                                </button>
                                <button onclick="actions.deleteGroup(${group.id})" class="text-red-500 hover:text-red-600">
                                    <i data-lucide="trash-2" class="w-[18px] h-[18px]"></i>
                                </button>
                            </div>
                        </div>

                        ${ui.editingColumns === group.id ? `
                            <div class="${cardBg} border-x ${borderColor} p-4">
                                <div class="flex gap-2 mb-3">
                                    <input id="input-new-col-${group.id}" type="text" placeholder="New column name..." class="flex-1 px-3 py-2 border ${borderColor} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${inputBg} ${textColor}" onkeypress="if(event.key==='Enter') actions.addCustomColumn(${group.id})" />
                                    <button onclick="actions.addCustomColumn(${group.id})" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Column</button>
                                </div>
                                <div class="space-y-2">
                                    ${group.columns.map(col => `
                                        <div class="flex items-center gap-2">
                                            <input type="text" value="${col}" onblur="actions.renameColumn(${group.id}, '${col}', this.value)" class="flex-1 px-3 py-2 border ${borderColor} rounded-lg ${inputBg} ${textColor}" />
                                            <button onclick="actions.deleteColumn(${group.id}, '${col}')" class="text-red-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${!group.collapsed ? `
                            <div class="${cardBg} rounded-b-lg shadow-sm border-x border-b ${borderColor}">
                                <div class="grid gap-4 p-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} border-b ${borderColor} font-semibold text-sm ${textSecondary}" style="grid-template-columns: ${gridCols}">
                                    ${group.columns.map(col => `<div>${col}</div>`).join('')}
                                    <div>Actions</div>
                                </div>
                                
                                ${ui.showNewTask === group.id ? `
                                    <div class="grid gap-4 p-4 border-b ${borderColor} ${darkMode ? 'bg-gray-750' : 'bg-blue-50'}" style="grid-template-columns: ${gridCols}">
                                        ${group.columns.map(col => `<div>${renderNewTaskInput(group, col)}</div>`).join('')}
                                        <div class="flex gap-2 items-center">
                                            <button onclick="actions.addTask(${group.id})" class="text-green-600 hover:text-green-700"><i data-lucide="check" class="w-5 h-5"></i></button>
                                            <button onclick="actions.setShowNewTask(null)" class="text-red-500 hover:text-red-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                                        </div>
                                    </div>
                                ` : ''}

                                ${groupTasks.map(task => `
                                    <div class="grid gap-4 p-4 border-b ${borderColor} ${hoverBg} transition items-center" style="grid-template-columns: ${gridCols}">
                                        ${group.columns.map(col => `<div>${renderCellInput(task, col)}</div>`).join('')}
                                        <div>
                                            <button onclick="actions.deleteTask(${task.id})" class="text-red-500 hover:text-red-600"><i data-lucide="trash-2" class="w-[18px] h-[18px]"></i></button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            return `<div class="p-6 h-full overflow-auto">${headerHtml}${newGroupHtml}${groupsHtml}</div>`;
        }

        function renderModals() {
            const { cardBg, borderColor, textColor, inputBg } = { 
                cardBg: state.darkMode ? 'bg-gray-800' : 'bg-white',
                borderColor: state.darkMode ? 'border-gray-700' : 'border-gray-200',
                textColor: state.darkMode ? 'text-gray-100' : 'text-gray-800',
                inputBg: state.darkMode ? 'bg-gray-700' : 'bg-white'
            };

            let html = '';

            if (state.ui.showInviteModal) {
                html += `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="${cardBg} rounded-lg p-6 w-96 border ${borderColor}">
                            <h2 class="text-xl font-bold mb-4 ${textColor}">Invite Member</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 ${textColor}">Email</label>
                                    <input id="invite-email" type="email" placeholder="member@example.com" class="w-full px-4 py-2 border ${borderColor} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${inputBg} ${textColor}" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 ${textColor}">Role</label>
                                    <select id="invite-role" class="w-full px-4 py-2 border ${borderColor} rounded-lg focus:outline-none ${inputBg} ${textColor}">
                                        <option value="owner">Owner</option>
                                        <option value="member">Member</option>
                                    </select>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="actions.sendInvite()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Send Invite</button>
                                    <button onclick="actions.setShowInviteModal(false)" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (state.ui.showMembersModal) {
                const ws = state.workspaces.find(w => w.id === state.selectedWorkspace);
                const members = ws ? ws.members : [];
                const textSecondary = state.darkMode ? 'text-gray-400' : 'text-gray-600';

                html += `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="${cardBg} rounded-lg p-6 w-96 border ${borderColor}">
                            <h2 class="text-xl font-bold mb-4 ${textColor}">Workspace Members</h2>
                            <div class="space-y-2 mb-4">
                                ${members.map(m => `
                                    <div class="flex items-center justify-between p-3 border ${borderColor} rounded-lg">
                                        <div>
                                            <div class="font-medium ${textColor}">${m.name}</div>
                                            <div class="text-sm ${textSecondary}">${m.email}</div>
                                        </div>
                                        <span class="text-xs px-2 py-1 rounded ${m.role === 'owner' ? 'bg-purple-100 text-purple-700' : 'bg-gray-200 text-gray-700'}">${m.role}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="actions.setShowMembersModal(false)" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">Close</button>
                        </div>
                    </div>
                `;
            }
            return html;
        }

        // --- 5. CORE RENDER FUNCTION ---
        function renderApp() {
            const app = document.getElementById('app');
            
            if (state.showLogin) {
                app.innerHTML = renderLogin();
            } else {
                const { darkMode } = state;
                const bgColor = darkMode ? 'bg-gray-900' : 'bg-gray-50';
                
                app.innerHTML = `
                    <div class="flex h-screen ${bgColor}">
                        ${renderSidebar()}
                        <div class="flex-1 overflow-hidden">
                            ${state.currentView === 'kanban' ? renderKanbanView() : renderListView()}
                        </div>
                        ${renderModals()}
                    </div>
                `;
            }
            
            // Re-initialize Icons after DOM update
            lucide.createIcons();
        }

        // Initial Render
        renderApp();

    </script>
</body>
</html>