<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WellTask Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 750: '#2d3748' }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-200">

    <div id="app"></div>

    <script>
        // ========================================================================
        // ⚠️ PASTE YOUR ZOHO WEBHOOK URL BELOW (Inside the quotes) ⚠️
        // ========================================================================
        const ZOHO_API_URL = "https://cliq.zoho.com/api/v2/functions/apischema/invoke?zapikey=1001.3d8aae64bab5fe65c5682907e19fcb45.41d161bac1cea527694b74dbdc843360"; 


        // --- 1. SECURITY & AUTH (Base64 Decoder) ---
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        let currentUser = null;

        if (token) {
            try {
                const decoded = atob(token);
                const parts = decoded.split("::");
                if (parts.length === 2) {
                    currentUser = { 
                        id: parts[1], 
                        name: parts[0].split('@')[0], 
                        email: parts[0], 
                        role: 'owner' 
                    };
                }
            } catch (e) { console.error("Auth Failed", e); }
        }

        // --- 2. INITIAL STATE ---
        const initialState = {
            darkMode: false,
            currentView: 'list',
            currentUser: currentUser,
            showLogin: !currentUser,
            
            workspaces: [{ 
                id: 1, name: 'My Workspace', ownerId: 1, 
                members: currentUser ? [currentUser] : [], 
                collapsed: false 
            }],
            selectedWorkspace: 1,
            
            projects: [
                { id: 1, name: 'Marketing Campaign', color: 'bg-purple-500', workspaceId: 1, collapsed: false },
                { id: 2, name: 'Product Development', color: 'bg-blue-500', workspaceId: 1, collapsed: false }
            ],
            selectedProject: 1,
            
            // We map Zoho Status to these Group IDs
            // ID 1: Not Started | ID 2: In Progress | ID 3: Done (Planning mapped to Done for demo)
            groups: [
                { id: 1, name: 'To Do', projectId: 1, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] },
                { id: 2, name: 'In Progress', projectId: 1, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] },
                { id: 3, name: 'Done', projectId: 1, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] }
            ],
            
            tasks: [], // Will be filled by Real-Time API

            ui: {
                showNewWorkspace: false, showWorkspaceMenu: false, editingWorkspace: null,
                showNewProject: false, editingProject: null, showNewGroup: false,
                editingGroup: null, editingColumns: null, showNewTask: null,
                showInviteModal: false, showMembersModal: false,
                loginEmail: '', loginRole: 'member',
                newWorkspaceName: '', newProjectName: '', newGroupName: '', newColumnName: '',
                inviteEmail: '', inviteRole: 'member',
                
                newTask: {
                    name: '', assignee: null, priority: 'Medium', status: 'Not Started', 
                    dueDate: new Date().toISOString().split('T')[0], customFields: {}
                }
            }
        };

        let state = { ...initialState };

        // --- 3. API ENGINE (The Bridge) ---
        const api = {
            // Fetch from Zoho
            fetchTasks: async () => {
                if (!state.currentUser || ZOHO_API_URL.includes("PASTE_YOUR")) return;
                
                try {
                    const res = await fetch(`${ZOHO_API_URL}&request_method=GET&user_email=${state.currentUser.email}`);
                    const json = await res.json();
                    
                    if(json.status === 'success' && json.data) {
                        state.tasks = json.data.map(t => {
                            // Unpack "Backpack"
                            let extras = { duedate: "", custom: {} };
                            try {
                                if(t.attributes) extras = JSON.parse(t.attributes);
                            } catch(e) {}

                            return {
                                id: t.id,
                                name: t.taskname,
                                status: t.status,
                                priority: t.priority,
                                assignee: t.assignee === 'Unassigned' ? null : { name: t.assignee, id: 0 }, // Mock ID for UI
                                dueDate: extras.duedate || "",
                                customFields: extras.custom || {},
                                projectId: 1, // Default to first project
                                groupId: getGroupId(t.status) // Map to UI Column
                            };
                        });
                        actions.render();
                    }
                } catch (e) { console.error("Sync Error", e); }
            },

            // Create in Zoho
            createTask: async (groupId) => {
                const taskData = state.ui.newTask;
                if(!taskData.name.trim()) return;

                // Optimistic UI Update
                const tempId = Date.now();
                state.tasks.push({ id: tempId, groupId, projectId: 1, ...taskData });
                state.ui.showNewTask = null;
                actions.render();

                // Pack Data
                const packed = JSON.stringify({ 
                    duedate: taskData.dueDate, 
                    custom: taskData.customFields 
                });

                try {
                    await fetch(`${ZOHO_API_URL}&request_method=POST&action=create` +
                        `&name=${encodeURIComponent(taskData.name)}` +
                        `&user_email=${state.currentUser.email}` +
                        `&attributes=${encodeURIComponent(packed)}`);
                    
                    api.fetchTasks(); // Sync real ID
                } catch (e) { console.error("Create Error", e); }
            },

            // Delete in Zoho
            deleteTask: async (id) => {
                state.tasks = state.tasks.filter(t => t.id !== id);
                actions.render();
                await fetch(`${ZOHO_API_URL}&request_method=POST&action=delete&id=${id}`);
            }
        };

        function getGroupId(status) {
            if(status === 'In Progress') return 2;
            if(status === 'Done' || status === 'Planning') return 3;
            return 1; // Default 'To Do'
        }

        // --- 4. HELPERS & UTILS ---
        const priorityColors = (priority, dark) => {
            const map = {
                'Low': dark ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700',
                'Medium': dark ? 'bg-yellow-900 text-yellow-300' : 'bg-yellow-100 text-yellow-700',
                'High': dark ? 'bg-orange-900 text-orange-300' : 'bg-orange-100 text-orange-700',
                'Critical': dark ? 'bg-red-900 text-red-300' : 'bg-red-100 text-red-700'
            };
            return map[priority] || '';
        };

        const statusColors = (status, dark) => {
            const map = {
                'Not Started': dark ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-700',
                'In Progress': dark ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white',
                'Done': dark ? 'bg-green-900 text-green-300' : 'bg-green-500 text-white',
                'Blocked': dark ? 'bg-red-900 text-red-300' : 'bg-red-500 text-white'
            };
            return map[status] || '';
        };

        // --- 5. ACTIONS (Business Logic) ---
        const actions = {
            render: () => renderApp(),
            
            // Login (Only used if not accessed via Widget)
            setLoginEmail: (v) => { state.ui.loginEmail = v; },
            setLoginRole: (v) => { state.ui.loginRole = v; actions.render(); },
            login: () => {
                if(state.ui.loginEmail.trim()) {
                    state.currentUser = { id: Date.now(), name: state.ui.loginEmail.split('@')[0], email: state.ui.loginEmail, role: state.ui.loginRole };
                    state.showLogin = false;
                    api.fetchTasks(); // Fetch data on manual login
                    actions.render();
                }
            },

            toggleTheme: () => { 
                state.darkMode = !state.darkMode; 
                document.documentElement.classList.toggle('dark', state.darkMode);
                actions.render(); 
            },
            setView: (view) => { state.currentView = view; actions.render(); },

            // Workspace/Project (Visuals kept for UI consistency)
            toggleWorkspaceMenu: () => { state.ui.showWorkspaceMenu = !state.ui.showWorkspaceMenu; actions.render(); },
            toggleWorkspaceCollapse: (id) => { const w = state.workspaces.find(x => x.id === id); if(w) w.collapsed = !w.collapsed; actions.render(); },
            setEditingWorkspace: (id) => { state.ui.editingWorkspace = id; actions.render(); },
            renameWorkspace: (id, name) => { if(name.trim()) { state.workspaces.find(x => x.id === id).name = name; state.ui.editingWorkspace = null; actions.render(); } },
            setShowNewWorkspace: (val) => { state.ui.showNewWorkspace = val; state.ui.newWorkspaceName = ''; actions.render(); },
            addWorkspace: () => { /* Visual only */ actions.render(); },
            selectWorkspace: (id) => { state.selectedWorkspace = id; actions.render(); },
            setShowNewProject: (val) => { state.ui.showNewProject = val; state.ui.newProjectName = ''; actions.render(); },
            addProject: () => { /* Visual only */ actions.render(); },
            selectProject: (id) => { state.selectedProject = id; actions.render(); },
            toggleProjectCollapse: (id) => { const p = state.projects.find(x => x.id === id); if(p) p.collapsed = !p.collapsed; actions.render(); },
            
            // Groups
            toggleGroupCollapse: (id) => { const g = state.groups.find(x => x.id === id); if(g) g.collapsed = !g.collapsed; actions.render(); },
            
            // Columns (Visual Only for now)
            setEditingColumns: (groupId) => { state.ui.editingColumns = state.ui.editingColumns === groupId ? null : groupId; actions.render(); },
            addCustomColumn: (groupId) => {
                const name = document.getElementById(`input-new-col-${groupId}`).value;
                if(name.trim()) {
                    state.groups.find(x => x.id === groupId).columns.push(name);
                    actions.render();
                }
            },
            
            // TASKS (Connected to API)
            setShowNewTask: (groupId) => { 
                state.ui.showNewTask = groupId; 
                state.ui.newTask = { name: '', assignee: null, priority: 'Medium', status: 'Not Started', dueDate: new Date().toISOString().split('T')[0], customFields: {} };
                actions.render(); 
            },
            updateNewTaskField: (field, value) => {
                if(field.startsWith('custom_')) {
                    state.ui.newTask.customFields[field.replace('custom_', '')] = value;
                } else if (field === 'assignee') {
                      // Mock assignee logic for UI
                      state.ui.newTask.assignee = { name: 'You', id: 0 };
                } else {
                    state.ui.newTask[field] = value;
                }
            },
            addTask: (groupId) => {
                const nameInput = document.getElementById(`new-task-name-${groupId}`);
                if(nameInput && nameInput.value.trim()) {
                    state.ui.newTask.name = nameInput.value;
                    api.createTask(groupId); // Call API
                }
            },
            updateTask: (id, field, value) => {
                // Visual update only (Editing logic would require another API endpoint)
                const t = state.tasks.find(x => x.id === id);
                if(t) { t[field] = value; actions.render(); }
            },
            deleteTask: (id) => {
                api.deleteTask(id); // Call API
            }
        };

        window.actions = actions;

        // --- 6. RENDERERS (Preserved from your request) ---

        function renderLogin() {
            return `<div class="h-screen flex items-center justify-center bg-gray-100 text-gray-600 text-xl font-semibold">Please access via Zoho Cliq Widget</div>`;
        }

        function renderSidebar() {
            const { darkMode, selectedWorkspace, workspaces, projects, selectedProject } = state;
            const { showWorkspaceMenu, showNewWorkspace, editingWorkspace, showNewProject } = state.ui;
            const currentWs = workspaces.find(w => w.id === selectedWorkspace);
            const wsProjects = projects.filter(p => p.workspaceId === selectedWorkspace);
            const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
            const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
            const textSecondary = darkMode ? 'text-gray-400' : 'text-gray-600';
            const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';
            const hoverBg = darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100';
            const inputBg = darkMode ? 'bg-gray-700' : 'bg-white';

            let projectsHtml = wsProjects.map(p => `
                <div class="flex items-center justify-between px-3 py-2 rounded-lg mb-1 cursor-pointer transition ${selectedProject === p.id ? 'bg-blue-600 text-white' : `${textColor} ${hoverBg}`}" onclick="actions.selectProject(${p.id})">
                    <div class="flex items-center gap-2 flex-1"><div class="w-3 h-3 rounded-full ${p.color}"></div><span class="text-sm">${p.name}</span></div>
                </div>
            `).join('');

            return `
                <div class="w-64 ${cardBg} border-r ${borderColor} flex flex-col h-full">
                    <div class="p-6 border-b ${borderColor}"><h1 class="text-2xl font-bold ${textColor}">WellTask</h1></div>
                    <nav class="flex-1 p-4 overflow-y-auto">
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3"><span class="text-sm font-semibold ${textSecondary} uppercase">Workspace</span></div>
                            <div class="mb-2"><div class="flex items-center justify-between flex-1 px-3 py-2 rounded-lg bg-blue-50 text-blue-700 font-medium"><span>${currentWs.name}</span></div></div>
                        </div>
                        <div class="mt-8">
                            <div class="flex items-center justify-between mb-3"><span class="text-sm font-semibold ${textSecondary} uppercase">Projects</span></div>
                            ${projectsHtml}
                        </div>
                    </nav>
                    <div class="p-4 border-t ${borderColor}">
                        <button onclick="actions.toggleTheme()" class="w-full flex items-center justify-between px-4 py-3 rounded-lg ${hoverBg} ${textColor}"><span>Theme</span><i data-lucide="${darkMode ? 'sun' : 'moon'}" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `;
        }

        function renderKanbanView() {
            const { tasks, selectedProject, projects, darkMode, ui, groups } = state;
            const currentProject = projects.find(p => p.id === selectedProject);
            const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
            const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';
            const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
            const textSecondary = darkMode ? 'text-gray-400' : 'text-gray-600';
            const inputBg = darkMode ? 'bg-gray-700' : 'bg-white';

            const headerHtml = `
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-lg ${currentProject?.color || 'bg-gray-500'} flex items-center justify-center text-white font-bold text-xl">${currentProject?.name.charAt(0) || '?'}</div>
                        <h1 class="text-3xl font-bold ${textColor}">${currentProject?.name || 'No Project'}</h1>
                    </div>
                    <button onclick="actions.setView('list')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition flex items-center gap-2"><i data-lucide="layout-list" class="w-5 h-5"></i> List View</button>
                </div>
            `;

            const columnsHtml = groups.map(group => {
                const groupTasks = tasks.filter(t => t.groupId === group.id);
                return `
                    <div class="${cardBg} rounded-lg border ${borderColor} p-4 min-h-[200px]">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold ${textColor}">${group.name}</h3>
                            <span class="${darkMode ? 'bg-gray-700' : 'bg-gray-200'} px-2 py-1 rounded-full text-sm ${textSecondary}">${groupTasks.length}</span>
                        </div>
                        <div class="space-y-3">
                            ${groupTasks.map(task => `
                                <div class="${darkMode ? 'bg-gray-700' : 'bg-white'} border ${borderColor} rounded-lg p-3 shadow-sm hover:shadow-md transition">
                                    <div class="font-medium mb-2 ${textColor}">${task.name}</div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs px-2 py-1 rounded ${priorityColors(task.priority, darkMode)}">${task.priority}</span>
                                        ${task.assignee ? `<div class="flex items-center gap-1"><i data-lucide="user" class="w-3.5 h-3.5 ${textSecondary}"></i><span class="text-xs ${textSecondary}">${task.assignee.name}</span></div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="p-6 h-full overflow-auto">${headerHtml}<div class="grid grid-cols-3 gap-4 min-w-[800px]">${columnsHtml}</div></div>`;
        }

        function renderListView() {
            const { tasks, selectedProject, groups, darkMode, ui } = state;
            const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
            const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';
            const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
            const textSecondary = darkMode ? 'text-gray-400' : 'text-gray-600';
            const inputBg = darkMode ? 'bg-gray-700' : 'bg-white';
            const hoverBg = darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100';

            const headerHtml = `
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4"><h1 class="text-3xl font-bold ${textColor}">List View</h1></div>
                    <div class="flex gap-3">
                        <button onclick="actions.setView('kanban')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition flex items-center gap-2"><i data-lucide="grid-3x3" class="w-5 h-5"></i> Kanban View</button>
                    </div>
                </div>
            `;

            const renderNewTaskInput = (group, col) => {
                if (col === 'Task') return `<input id="new-task-name-${group.id}" type="text" placeholder="Task name..." onkeypress="if(event.key==='Enter') actions.addTask(${group.id})" class="px-3 py-2 border ${borderColor} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${inputBg} ${textColor} w-full" autofocus />`;
                if (col === 'Priority') return `<select onchange="actions.updateNewTaskField('priority', this.value)" class="px-3 py-2 rounded-lg font-medium text-sm w-full ${priorityColors(ui.newTask.priority, darkMode)}">${['Low', 'Medium', 'High', 'Critical'].map(p => `<option ${ui.newTask.priority === p ? 'selected' : ''}>${p}</option>`).join('')}</select>`;
                return `<input type="text" disabled placeholder="-" class="px-3 py-2 border ${borderColor} rounded-lg text-sm ${inputBg} ${textColor} w-full" />`;
            }

            const groupsHtml = groups.map(group => {
                const groupTasks = tasks.filter(t => t.groupId === group.id);
                const gridCols = `repeat(${group.columns.length}, 1fr) 0.5fr`;

                return `
                    <div class="mb-6">
                        <div class="${cardBg} rounded-t-lg shadow-sm border ${borderColor} p-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <button onclick="actions.toggleGroupCollapse(${group.id})" class="${textColor}"><i data-lucide="${group.collapsed ? 'chevron-right' : 'chevron-down'}" class="w-5 h-5"></i></button>
                                <span class="font-bold text-lg ${textColor}">${group.name}</span>
                                <span class="${darkMode ? 'bg-gray-700' : 'bg-gray-200'} px-3 py-1 rounded-full text-sm ${textSecondary}">${groupTasks.length}</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="actions.setEditingColumns(${group.id})" class="text-purple-600 hover:text-purple-700 flex items-center gap-1 text-sm font-medium"><i data-lucide="settings" class="w-4 h-4"></i> Columns</button>
                                <button onclick="actions.setShowNewTask(${group.id})" class="text-blue-600 hover:text-blue-700 flex items-center gap-1 text-sm font-medium"><i data-lucide="plus" class="w-4 h-4"></i> Add Task</button>
                            </div>
                        </div>

                        ${ui.editingColumns === group.id ? `<div class="${cardBg} border-x ${borderColor} p-4"><div class="flex gap-2 mb-3"><input id="input-new-col-${group.id}" type="text" placeholder="New column name..." class="flex-1 px-3 py-2 border ${borderColor} rounded-lg ${inputBg} ${textColor}" /><button onclick="actions.addCustomColumn(${group.id})" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Add</button></div></div>` : ''}

                        ${!group.collapsed ? `
                            <div class="${cardBg} rounded-b-lg shadow-sm border-x border-b ${borderColor}">
                                <div class="grid gap-4 p-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} border-b ${borderColor} font-semibold text-sm ${textSecondary}" style="grid-template-columns: ${gridCols}">${group.columns.map(col => `<div>${col}</div>`).join('')}<div>Actions</div></div>
                                
                                ${ui.showNewTask === group.id ? `<div class="grid gap-4 p-4 border-b ${borderColor} ${darkMode ? 'bg-gray-750' : 'bg-blue-50'}" style="grid-template-columns: ${gridCols}">${group.columns.map(col => `<div>${renderNewTaskInput(group, col)}</div>`).join('')}<div class="flex gap-2 items-center"><button onclick="actions.addTask(${group.id})" class="text-green-600"><i data-lucide="check" class="w-5 h-5"></i></button><button onclick="actions.setShowNewTask(null)" class="text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button></div></div>` : ''}

                                ${groupTasks.map(task => `
                                    <div class="grid gap-4 p-4 border-b ${borderColor} ${hoverBg} transition items-center" style="grid-template-columns: ${gridCols}">
                                        <div>${task.name}</div>
                                        <div>${task.assignee ? task.assignee.name : 'Unassigned'}</div>
                                        <div><span class="text-xs px-2 py-1 rounded ${priorityColors(task.priority, darkMode)}">${task.priority}</span></div>
                                        <div><span class="text-xs px-2 py-1 rounded ${statusColors(task.status, darkMode)}">${task.status}</span></div>
                                        <div>${task.dueDate || '-'}</div>
                                        <div><button onclick="actions.deleteTask('${task.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-[18px] h-[18px]"></i></button></div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            return `<div class="p-6 h-full overflow-auto">${headerHtml}${groupsHtml}</div>`;
        }

        function renderApp() {
            const app = document.getElementById('app');
            if (state.showLogin) app.innerHTML = renderLogin();
            else {
                const { darkMode } = state;
                const bgColor = darkMode ? 'bg-gray-900' : 'bg-gray-50';
                app.innerHTML = `<div class="flex h-screen ${bgColor}">${renderSidebar()}<div class="flex-1 overflow-hidden">${state.currentView === 'kanban' ? renderKanbanView() : renderListView()}</div></div>`;
            }
            lucide.createIcons();
        }

        // --- AUTO SYNC ---
        setInterval(() => { if(state.currentUser) api.fetchTasks(); }, 3000);

        // --- INITIALIZE ---
        if(state.currentUser) api.fetchTasks();
        renderApp();

    </script>
</body>
</html>