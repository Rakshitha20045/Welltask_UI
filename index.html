<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WellTask - Zoho Integrated</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 750: '#2d3748' }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-200 min-h-screen overflow-hidden">

    <div id="app" class="h-screen w-full"></div>

    <script>
        // ==========================================
        // --- 1. CONFIGURATION & API LOGIC ---
        // ==========================================

        // [ACTION REQUIRED] PASTE YOUR ZOHO URL BELOW
        const ZOHO_API_URL = "https://cliq.zoho.com/api/v2/functions/apischema/invoke?zapikey=1001.3d8aae64bab5fe65c5682907e19fcb45.41d161bac1cea527694b74dbdc843360"; 

        // --- Security & API Helpers ---

        // 1. Base64 Security Decoder (Reads ?token=XYZ from URL)
        const getAuthToken = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedToken = urlParams.get('token');
            if (!encodedToken) {
                console.warn("No token found in URL");
                return null;
            }
            try {
                // Decodes Base64 string
                return atob(encodedToken);
            } catch (e) {
                console.error("Token decode failed", e);
                return encodedToken; // Fallback
            }
        };

        // 2. Unpacking Logic (Handles "Large Text" or wrapped JSON responses)
        const unpackResponse = (response) => {
            try {
                // If Zoho returns data wrapped in a string field (e.g., "response": "{...}")
                if (typeof response === 'string') return JSON.parse(response);
                if (response.data && typeof response.data === 'string') return JSON.parse(response.data);
                // If it's already clean JSON
                return response;
            } catch (e) {
                console.error("Error unpacking data:", e);
                return [];
            }
        };

        // 3. Main API Handler
        const api = async (action, payload = {}) => {
            const token = getAuthToken();
            // Add token to payload if your API expects it in the body, 
            // or use headers if your endpoint supports it.
            const requestBody = {
                action: action,
                auth_token: token, 
                ...payload
            };

            try {
                const res = await fetch(ZOHO_API_URL, {
                    method: 'POST', // Zoho Webhooks usually use POST
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const json = await res.json();
                return unpackResponse(json);
            } catch (err) {
                console.error("API Error:", err);
                return null;
            }
        };

        // ==========================================
        // --- 2. STATE MANAGEMENT ---
        // ==========================================

        const initialState = {
            darkMode: false,
            isLoading: false, // Start false, set true when fetching
            
            // Hardcoded Structure (Workspaces/Projects) for UI shell
            // In a real app, these might also come from the API
            workspaces: [{ id: 1, name: 'My Workspace', collapsed: false }],
            projects: [
                { id: 1, name: 'Marketing Campaign', color: 'bg-purple-500', icon: 'M' },
                { id: 2, name: 'Product Development', color: 'bg-blue-500', icon: 'P' }
            ],
            selectedProject: 1,

            // Dynamic Data (Synced with Zoho)
            groups: [
                { id: 'todo', name: 'To Do', collapsed: false },
                { id: 'progress', name: 'In Progress', collapsed: false }
            ],
            
            tasks: [
                // Initial dummy data to show UI before API load
                { id: 1, groupId: 'todo', name: 'Design social media graphics', assignee: 'Unassigned', priority: 'High', status: 'Not Started', dueDate: '2025-11-25' },
                { id: 2, groupId: 'todo', name: 'Write blog post', assignee: 'Unassigned', priority: 'Medium', status: 'In Progress', dueDate: '2025-11-22' },
                { id: 3, groupId: 'progress', name: 'Email campaign setup', assignee: 'Unassigned', priority: 'Critical', status: 'In Progress', dueDate: '2025-11-20' }
            ],

            // UI State
            ui: {
                sidebarOpen: true,
                showNewGroupModal: false
            }
        };

        let state = { ...initialState };

        // ==========================================
        // --- 3. HELPERS & STYLES ---
        // ==========================================

        const priorityStyles = (priority) => {
            const map = {
                'Low': 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200',
                'Medium': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-200',
                'High': 'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-200',
                'Critical': 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200'
            };
            return map[priority] || 'bg-gray-100 text-gray-700';
        };

        const statusStyles = (status) => {
            const map = {
                'Not Started': 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
                'In Progress': 'bg-blue-500 text-white',
                'Done': 'bg-green-500 text-white',
                'Blocked': 'bg-red-500 text-white'
            };
            return map[status] || 'bg-gray-200 text-gray-700';
        };

        // ==========================================
        // --- 4. ACTIONS (Controller) ---
        // ==========================================

        const actions = {
            render: () => {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="flex h-full ${state.darkMode ? 'dark' : ''}">
                        ${renderSidebar()}
                        <main class="flex-1 flex flex-col h-full overflow-hidden bg-white dark:bg-gray-900 text-gray-900 dark:text-white">
                            ${renderHeader()}
                            ${renderContent()}
                        </main>
                    </div>
                `;
                lucide.createIcons();
            },

            // --- Initialization ---
            init: async () => {
                state.isLoading = true;
                actions.render();
                
                // Fetch data from Zoho
                const data = await api('FETCH_ALL_TASKS');
                if (data && Array.isArray(data.tasks)) {
                    state.tasks = data.tasks;
                }
                
                state.isLoading = false;
                actions.render();
            },

            // --- UI Actions ---
            toggleTheme: () => {
                state.darkMode = !state.darkMode;
                document.documentElement.classList.toggle('dark');
                actions.render();
            },
            toggleGroup: (groupId) => {
                const g = state.groups.find(x => x.id === groupId);
                if(g) g.collapsed = !g.collapsed;
                actions.render();
            },
            selectProject: (id) => {
                state.selectedProject = id;
                actions.render();
            },

            // --- CRUD Actions (Synced to Zoho) ---
            addTask: async (groupId) => {
                const newTask = {
                    id: Date.now(), // Temp ID
                    groupId: groupId,
                    name: 'New Task',
                    assignee: 'Unassigned',
                    priority: 'Medium',
                    status: 'Not Started',
                    dueDate: new Date().toISOString().split('T')[0]
                };

                // Optimistic Update
                state.tasks.push(newTask);
                actions.render();

                // Sync
                const response = await api('CREATE_TASK', { task: newTask });
                if(response && response.newId) {
                    // Update temp ID with real ID from Zoho
                    const task = state.tasks.find(t => t.id === newTask.id);
                    if(task) task.id = response.newId;
                }
            },

            updateTaskField: async (id, field, value) => {
                const task = state.tasks.find(t => t.id === id);
                if (task) {
                    task[field] = value;
                    actions.render(); // Optimistic Render

                    // Sync
                    await api('UPDATE_TASK', { taskId: id, field: field, value: value });
                }
            },

            deleteTask: async (id) => {
                if(confirm('Are you sure you want to delete this task?')) {
                    state.tasks = state.tasks.filter(t => t.id !== id);
                    actions.render(); // Optimistic

                    // Sync
                    await api('DELETE_TASK', { taskId: id });
                }
            },

            createNewGroup: () => {
               // Logic to add new group locally and sync
               const name = prompt("Enter Group Name:");
               if(name) {
                   state.groups.push({ id: name.toLowerCase().replace(/\s/g, ''), name: name, collapsed: false });
                   actions.render();
               }
            }
        };

        window.actions = actions;

        // ==========================================
        // --- 5. RENDERERS (View) ---
        // ==========================================

        function renderSidebar() {
            const { workspaces, projects, selectedProject } = state;
            
            return `
                <div class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col transition-colors duration-200">
                    <div class="p-6">
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                            WellTask
                        </h1>
                    </div>

                    <nav class="flex-1 overflow-y-auto px-4 space-y-6">
                        
                        <div>
                            <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-2">Workspace</div>
                            <div class="flex items-center justify-between px-3 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg cursor-pointer">
                                <span class="font-medium">My Workspace</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2 px-2">
                                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Projects</div>
                                <button class="text-blue-500 hover:text-blue-600"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                            <div class="space-y-1">
                                ${projects.map(p => `
                                    <div onclick="actions.selectProject(${p.id})" 
                                         class="flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer transition-colors ${selectedProject === p.id ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'}">
                                        <div class="w-2.5 h-2.5 rounded-full ${p.color}"></div>
                                        <span class="text-sm font-medium">${p.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </nav>

                    <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                        <button onclick="actions.toggleTheme()" class="flex items-center justify-between w-full px-3 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            <span class="text-sm font-medium">Theme</span>
                            <i data-lucide="${state.darkMode ? 'moon' : 'sun'}" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            const project = state.projects.find(p => p.id === state.selectedProject);
            return `
                <header class="h-16 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex items-center justify-between px-8 shadow-sm z-10">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg ${project.color} flex items-center justify-center text-white font-bold shadow-sm">
                            ${project.icon}
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white tracking-tight">${project.name}</h2>
                    </div>
                    <div class="flex items-center gap-3">
                        <button class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg shadow-sm flex items-center gap-2 transition">
                            <i data-lucide="layout-kanban" class="w-4 h-4"></i> Kanban View
                        </button>
                        <button onclick="actions.createNewGroup()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg shadow-sm flex items-center gap-2 transition">
                            <i data-lucide="plus" class="w-4 h-4"></i> New Group
                        </button>
                    </div>
                </header>
            `;
        }

        function renderContent() {
            if (state.isLoading) {
                return `<div class="flex-1 flex items-center justify-center text-gray-400">Loading Data...</div>`;
            }

            const { groups, tasks } = state;

            return `
                <div class="flex-1 overflow-y-auto p-8 bg-gray-50 dark:bg-gray-900">
                    <div class="space-y-8 max-w-7xl mx-auto">
                        ${groups.map(group => {
                            const groupTasks = tasks.filter(t => t.groupId === group.id);
                            return `
                                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                                    
                                    <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between bg-white dark:bg-gray-800 sticky top-0 z-0">
                                        <div class="flex items-center gap-3 cursor-pointer" onclick="actions.toggleGroup('${group.id}')">
                                            <i data-lucide="${group.collapsed ? 'chevron-right' : 'chevron-down'}" class="w-5 h-5 text-gray-400"></i>
                                            <h3 class="text-lg font-bold text-gray-800 dark:text-white">${group.name}</h3>
                                            <span class="bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 px-2.5 py-0.5 rounded-full text-xs font-semibold">${groupTasks.length}</span>
                                        </div>
                                        <div class="flex items-center gap-4 text-sm">
                                            <button class="text-purple-600 hover:text-purple-700 font-medium flex items-center gap-1">
                                                <i data-lucide="settings" class="w-4 h-4"></i> Columns
                                            </button>
                                            <button onclick="actions.addTask('${group.id}')" class="text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1">
                                                <i data-lucide="plus" class="w-4 h-4"></i> Add Task
                                            </button>
                                            <button class="text-red-400 hover:text-red-600 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>

                                    ${!group.collapsed ? `
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-left border-collapse">
                                                <thead>
                                                    <tr class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-800/50 border-b border-gray-100 dark:border-gray-700">
                                                        <th class="px-6 py-3 w-1/4">Task</th>
                                                        <th class="px-6 py-3 w-48">Assignee</th>
                                                        <th class="px-6 py-3 w-40">Priority</th>
                                                        <th class="px-6 py-3 w-48">Status</th>
                                                        <th class="px-6 py-3 w-40">Due Date</th>
                                                        <th class="px-6 py-3 w-20 text-center">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                                                    ${groupTasks.map(task => `
                                                        <tr class="group hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                                            <td class="px-6 py-4">
                                                                <input type="text" value="${task.name}" 
                                                                    onchange="actions.updateTaskField(${task.id}, 'name', this.value)"
                                                                    class="w-full bg-transparent border border-gray-200 dark:border-gray-600 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white text-sm transition-all shadow-sm" />
                                                            </td>

                                                            <td class="px-6 py-4">
                                                                <div class="relative">
                                                                    <select onchange="actions.updateTaskField(${task.id}, 'assignee', this.value)" 
                                                                        class="w-full appearance-none bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 py-2 px-3 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500 text-sm shadow-sm">
                                                                        <option ${task.assignee === 'Unassigned' ? 'selected' : ''}>Unassigned</option>
                                                                        <option ${task.assignee === 'You' ? 'selected' : ''}>You</option>
                                                                    </select>
                                                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                                                        <i data-lucide="chevron-down" class="w-3 h-3"></i>
                                                                    </div>
                                                                </div>
                                                            </td>

                                                            <td class="px-6 py-4">
                                                                <div class="relative">
                                                                    <select onchange="actions.updateTaskField(${task.id}, 'priority', this.value)" 
                                                                        class="w-full appearance-none py-2 px-3 pr-8 rounded text-sm font-medium focus:outline-none shadow-sm cursor-pointer ${priorityStyles(task.priority)}">
                                                                        <option class="bg-white text-gray-800" ${task.priority === 'Low' ? 'selected' : ''}>Low</option>
                                                                        <option class="bg-white text-gray-800" ${task.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                                                        <option class="bg-white text-gray-800" ${task.priority === 'High' ? 'selected' : ''}>High</option>
                                                                        <option class="bg-white text-gray-800" ${task.priority === 'Critical' ? 'selected' : ''}>Critical</option>
                                                                    </select>
                                                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 opacity-50">
                                                                        <i data-lucide="chevron-down" class="w-3 h-3"></i>
                                                                    </div>
                                                                </div>
                                                            </td>

                                                            <td class="px-6 py-4">
                                                                <div class="relative">
                                                                    <select onchange="actions.updateTaskField(${task.id}, 'status', this.value)" 
                                                                        class="w-full appearance-none py-2 px-3 pr-8 rounded text-sm font-medium focus:outline-none shadow-sm cursor-pointer ${statusStyles(task.status)}">
                                                                        <option class="bg-white text-gray-800" ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                                                        <option class="bg-white text-gray-800" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                                                        <option class="bg-white text-gray-800" ${task.status === 'Done' ? 'selected' : ''}>Done</option>
                                                                        <option class="bg-white text-gray-800" ${task.status === 'Blocked' ? 'selected' : ''}>Blocked</option>
                                                                    </select>
                                                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 opacity-50">
                                                                        <i data-lucide="chevron-down" class="w-3 h-3"></i>
                                                                    </div>
                                                                </div>
                                                            </td>

                                                            <td class="px-6 py-4">
                                                                <input type="date" value="${task.dueDate}" 
                                                                    onchange="actions.updateTaskField(${task.id}, 'dueDate', this.value)"
                                                                    class="w-full bg-transparent border border-gray-200 dark:border-gray-600 rounded px-3 py-2 text-sm text-gray-600 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm" />
                                                            </td>

                                                            <td class="px-6 py-4 text-center">
                                                                <button onclick="actions.deleteTask(${task.id})" class="text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/30 transition">
                                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                            ${groupTasks.length === 0 ? `
                                                <div class="p-8 text-center text-gray-400 text-sm border-t border-gray-100 dark:border-gray-700">
                                                    No tasks in this group. <button onclick="actions.addTask('${group.id}')" class="text-blue-600 hover:underline">Add one?</button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // --- Boot ---
        document.addEventListener('DOMContentLoaded', () => {
            actions.init();
        });

    </script>
</body>
</html>