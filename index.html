<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WellTask Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 750: '#2d3748' }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-200">

<div id="app"></div>

<script>
    // ========================================================================
    // ⚠️ PASTE YOUR ZOHO WEBHOOK URL HERE ⚠️
    // ========================================================================
    const ZOHO_API_URL = "https://cliq.zoho.com/api/v2/functions/apischema/invoke?zapikey=1001.3d8aae64bab5fe65c5682907e19fcb45.41d161bac1cea527694b74dbdc843360";

    // --- 1. SECURITY & AUTH (Base64 Decoder) ---
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    let currentUser = null;
    if (token) {
        try {
            const decoded = atob(token);
            const parts = decoded.split("::");
            if (parts.length === 2) {
                currentUser = {
                    id: parts[1],
                    name: parts[0].split('@')[0],
                    email: parts[0],
                    role: 'owner'
                };
            }
        } catch (e) {
            console.error("Auth Failed", e);
        }
    }

    // --- Helpers for IDs ---
    const uid = () => Date.now() + Math.floor(Math.random() * 1000);

    // --- 2. APP STATE ---
    const initialState = {
        darkMode: false,
        currentView: 'list', // 'kanban' or 'list'
        currentUser: currentUser,
        showLogin: !currentUser,

        workspaces: [
            { id: 1, name: 'My Workspace', collapsed: false }
        ],
        selectedWorkspace: 1,

        projects: [
            { id: 1, name: 'Marketing Campaign', color: 'bg-purple-500', workspaceId: 1, collapsed: false },
            { id: 2, name: 'Product Development', color: 'bg-blue-500', workspaceId: 1, collapsed: false }
        ],
        selectedProject: 1,

        groups: [
            {
                id: 1,
                name: 'To Do',
                projectId: 1,
                collapsed: false,
                columns: [
                    { id: 'task', name: 'Task', isDefault: true },
                    { id: 'assignee', name: 'Assignee', isDefault: true },
                    { id: 'priority', name: 'Priority', isDefault: true },
                    { id: 'status', name: 'Status', isDefault: true },
                    { id: 'duedate', name: 'Due Date', isDefault: true }
                ]
            },
            {
                id: 2,
                name: 'In Progress',
                projectId: 1,
                collapsed: false,
                columns: [
                    { id: 'task', name: 'Task', isDefault: true },
                    { id: 'assignee', name: 'Assignee', isDefault: true },
                    { id: 'priority', name: 'Priority', isDefault: true },
                    { id: 'status', name: 'Status', isDefault: true },
                    { id: 'duedate', name: 'Due Date', isDefault: true }
                ]
            },
            {
                id: 3,
                name: 'Done',
                projectId: 1,
                collapsed: false,
                columns: [
                    { id: 'task', name: 'Task', isDefault: true },
                    { id: 'assignee', name: 'Assignee', isDefault: true },
                    { id: 'priority', name: 'Priority', isDefault: true },
                    { id: 'status', name: 'Status', isDefault: true },
                    { id: 'duedate', name: 'Due Date', isDefault: true }
                ]
            }
        ],

        tasks: [],

        ui: {
            showNewTask: null,
            newTask: {
                name: '',
                assignee: null,
                priority: 'Medium',
                status: 'Not Started',
                dueDate: '',
                customFields: {}
            },
            // editing states
            editingTaskId: null,
            editingTaskName: '',
            editingGroupId: null,
            editingGroupName: '',
            columnsGroupId: null,
            editingWorkspaceId: null,
            editingWorkspaceName: '',
            editingProjectId: null,
            editingProjectName: ''
        }
    };

    let state = { ...initialState };

    // --- 3. API BRIDGE (The Sync Engine) ---
    const api = {
        fetchTasks: async () => {
            if (!state.currentUser || ZOHO_API_URL.includes("PASTE_YOUR")) return;

            try {
                const res = await fetch(`${ZOHO_API_URL}&request_method=GET&user_email=${state.currentUser.email}`);
                const json = await res.json();

                if (json.status === 'success' && json.data) {
                    state.tasks = json.data.map(t => {
                        let extras = { duedate: "", custom: {} };
                        try {
                            if (t.attributes) extras = JSON.parse(t.attributes);
                        } catch (e) {}

                        return {
                            id: t.id,
                            name: t.taskname,
                            status: t.status || 'Not Started',
                            priority: t.priority || 'Medium',
                            assignee: t.assignee === 'Unassigned' ? null : { name: t.assignee },
                            dueDate: extras.duedate || "",
                            customFields: extras.custom || {},
                            projectId: 1,
                            groupId: getGroupIdFromStatus(t.status)
                        };
                    });
                    renderApp();
                }
            } catch (e) {
                console.error("Sync Error", e);
            }
        },

        createTask: async (groupId) => {
            const taskData = state.ui.newTask;
            if (!taskData.name.trim()) return;

            const tempId = uid();
            state.tasks.push({
                id: tempId,
                groupId,
                projectId: state.selectedProject,
                ...taskData
            });
            state.ui.showNewTask = null;
            renderApp();

            const packed = JSON.stringify({
                duedate: taskData.dueDate,
                custom: taskData.customFields
            });

            try {
                await fetch(
                    `${ZOHO_API_URL}&request_method=POST&action=create` +
                    `&name=${encodeURIComponent(taskData.name)}` +
                    `&user_email=${state.currentUser.email}` +
                    `&status=${encodeURIComponent(taskData.status)}` +
                    `&priority=${encodeURIComponent(taskData.priority)}` +
                    `&attributes=${encodeURIComponent(packed)}`
                );
                api.fetchTasks();
            } catch (e) {
                console.error("Create Error", e);
            }
        },

        updateTask: async (task) => {
            if (!state.currentUser || ZOHO_API_URL.includes("PASTE_YOUR")) return;
            try {
                const packed = JSON.stringify({
                    duedate: task.dueDate || "",
                    custom: task.customFields || {}
                });

                await fetch(
                    `${ZOHO_API_URL}&request_method=POST&action=update` +
                    `&id=${encodeURIComponent(task.id)}` +
                    `&name=${encodeURIComponent(task.name)}` +
                    `&user_email=${state.currentUser.email}` +
                    `&status=${encodeURIComponent(task.status)}` +
                    `&priority=${encodeURIComponent(task.priority)}` +
                    `&assignee=${encodeURIComponent(task.assignee ? task.assignee.name : 'Unassigned')}` +
                    `&attributes=${encodeURIComponent(packed)}`
                );
            } catch (e) {
                console.error("Update Error", e);
            }
        },

        deleteTask: async (id) => {
            state.tasks = state.tasks.filter(t => t.id !== id);
            renderApp();
            try {
                await fetch(`${ZOHO_API_URL}&request_method=POST&action=delete&id=${id}`);
            } catch (e) {
                console.error("Delete Error", e);
            }
        }
    };

    function getGroupIdFromStatus(status) {
        if (status === 'In Progress') return 2;
        if (status === 'Done') return 3;
        return 1;
    }

    // --- 4. UI ACTIONS ---
    const actions = {
        render: () => renderApp(),

        // Theme
        toggleTheme: () => {
            state.darkMode = !state.darkMode;
            renderApp();
        },

        // Views
        setView: (view) => {
            state.currentView = view;
            renderApp();
        },

        // Workspaces
        selectWorkspace: (id) => {
            state.selectedWorkspace = id;
            // auto-select first project in that workspace
            const proj = state.projects.find(p => p.workspaceId === id);
            if (proj) state.selectedProject = proj.id;
            renderApp();
        },

        addWorkspace: () => {
            const id = uid();
            state.workspaces.push({ id, name: 'New Workspace', collapsed: false });
            state.selectedWorkspace = id;
            renderApp();
        },

        startEditWorkspace: (id) => {
            const ws = state.workspaces.find(w => w.id === id);
            if (!ws) return;
            state.ui.editingWorkspaceId = id;
            state.ui.editingWorkspaceName = ws.name;
            renderApp();
        },

        saveWorkspaceName: (id) => {
            const input = document.getElementById(`ws-name-input-${id}`);
            if (!input) return;
            const ws = state.workspaces.find(w => w.id === id);
            if (ws) ws.name = input.value.trim() || ws.name;
            state.ui.editingWorkspaceId = null;
            state.ui.editingWorkspaceName = '';
            renderApp();
        },

        deleteWorkspace: (id) => {
            if (state.workspaces.length === 1) {
                alert("You must have at least one workspace.");
                return;
            }
            if (!confirm("Delete this workspace and its projects?")) return;
            // delete projects under workspace
            const projIds = state.projects.filter(p => p.workspaceId === id).map(p => p.id);
            state.projects = state.projects.filter(p => p.workspaceId !== id);
            // delete groups & tasks of those projects
            state.groups = state.groups.filter(g => !projIds.includes(g.projectId));
            state.tasks = state.tasks.filter(t => !projIds.includes(t.projectId));
            state.workspaces = state.workspaces.filter(w => w.id !== id);
            if (state.selectedWorkspace === id) {
                state.selectedWorkspace = state.workspaces[0].id;
                const proj = state.projects.find(p => p.workspaceId === state.selectedWorkspace);
                if (proj) state.selectedProject = proj.id;
            }
            renderApp();
        },

        // Projects
        addProject: () => {
            const id = uid();
            state.projects.push({
                id,
                name: 'New Project',
                color: 'bg-green-500',
                workspaceId: state.selectedWorkspace,
                collapsed: false
            });
            state.selectedProject = id;
            renderApp();
        },

        selectProject: (id) => {
            state.selectedProject = id;
            renderApp();
        },

        startEditProject: (id) => {
            const p = state.projects.find(pr => pr.id === id);
            if (!p) return;
            state.ui.editingProjectId = id;
            state.ui.editingProjectName = p.name;
            renderApp();
        },

        saveProjectName: (id) => {
            const input = document.getElementById(`proj-name-input-${id}`);
            if (!input) return;
            const p = state.projects.find(pr => pr.id === id);
            if (p) p.name = input.value.trim() || p.name;
            state.ui.editingProjectId = null;
            state.ui.editingProjectName = '';
            renderApp();
        },

        deleteProject: (id) => {
            if (!confirm("Delete this project and its tasks?")) return;
            // remove groups & tasks
            state.groups = state.groups.filter(g => g.projectId !== id);
            state.tasks = state.tasks.filter(t => t.projectId !== id);
            state.projects = state.projects.filter(p => p.id !== id);
            // select another project in same workspace
            const another = state.projects.find(p => p.workspaceId === state.selectedWorkspace);
            state.selectedProject = another ? another.id : (state.projects[0] ? state.projects[0].id : null);
            renderApp();
        },

        // Groups
        toggleGroupCollapse: (groupId) => {
            const g = state.groups.find(gr => gr.id === groupId);
            if (g) g.collapsed = !g.collapsed;
            renderApp();
        },

        addGroup: () => {
            const baseGroup = state.groups.find(g => g.projectId === state.selectedProject) || state.groups[0];
            const newId = uid();
            state.groups.push({
                id: newId,
                name: 'New Group',
                projectId: state.selectedProject,
                collapsed: false,
                columns: baseGroup ? JSON.parse(JSON.stringify(baseGroup.columns)) : []
            });
            renderApp();
        },

        startEditGroup: (id) => {
            const g = state.groups.find(gr => gr.id === id);
            if (!g) return;
            state.ui.editingGroupId = id;
            state.ui.editingGroupName = g.name;
            renderApp();
        },

        saveGroupName: (id) => {
            const input = document.getElementById(`group-name-input-${id}`);
            if (!input) return;
            const g = state.groups.find(gr => gr.id === id);
            if (g) g.name = input.value.trim() || g.name;
            state.ui.editingGroupId = null;
            state.ui.editingGroupName = '';
            renderApp();
        },

        deleteGroup: (id) => {
            if (!confirm("Delete this group and its tasks?")) return;
            state.groups = state.groups.filter(g => g.id !== id);
            state.tasks = state.tasks.filter(t => t.groupId !== id);
            renderApp();
        },

        // Columns panel
        toggleColumnsPanel: (groupId) => {
            state.ui.columnsGroupId = (state.ui.columnsGroupId === groupId) ? null : groupId;
            renderApp();
        },

        addColumn: (groupId) => {
            const g = state.groups.find(gr => gr.id === groupId);
            if (!g) return;
            g.columns.push({
                id: 'col_' + uid(),
                name: 'New Column',
                isDefault: false
            });
            renderApp();
        },

        renameColumn: (groupId, colId) => {
            const input = document.getElementById(`col-name-${groupId}-${colId}`);
            if (!input) return;
            const g = state.groups.find(gr => gr.id === groupId);
            if (!g) return;
            const col = g.columns.find(c => c.id === colId);
            if (col) col.name = input.value.trim() || col.name;
            renderApp();
        },

        deleteColumn: (groupId, colId) => {
            const g = state.groups.find(gr => gr.id === groupId);
            if (!g) return;
            g.columns = g.columns.filter(c => c.id !== colId);
            state.tasks.forEach(t => {
                if (t.customFields && t.customFields[colId] !== undefined) {
                    delete t.customFields[colId];
                }
            });
            renderApp();
        },

        // Tasks
        setShowNewTask: (groupId) => {
            state.ui.showNewTask = groupId;
            state.ui.newTask = {
                name: '',
                assignee: null,
                priority: 'Medium',
                status: (groupId === 2 ? 'In Progress' : (groupId === 3 ? 'Done' : 'Not Started')),
                dueDate: '',
                customFields: {}
            };
            renderApp();
        },

        submitTask: (groupId) => {
            const input = document.getElementById(`new-task-name-${groupId}`);
            if (input) state.ui.newTask.name = input.value;
            api.createTask(groupId);
        },

        deleteTask: (id) => api.deleteTask(id),

        startEditTaskName: (id) => {
            const t = state.tasks.find(task => task.id === id);
            if (!t) return;
            state.ui.editingTaskId = id;
            state.ui.editingTaskName = t.name;
            renderApp();
        },

        saveTaskName: (id) => {
            const input = document.getElementById(`task-name-input-${id}`);
            const t = state.tasks.find(task => task.id === id);
            if (t && input) {
                t.name = input.value.trim() || t.name;
                state.ui.editingTaskId = null;
                state.ui.editingTaskName = '';
                renderApp();
                api.updateTask(t);
            }
        },

        updateTaskField: (id, field, value, extra) => {
            const t = state.tasks.find(task => task.id === id);
            if (!t) return;

            if (field === 'assignee') {
                t.assignee = value ? { name: value } : null;
            } else if (field === 'custom') {
                const colId = extra;
                if (!t.customFields) t.customFields = {};
                t.customFields[colId] = value;
            } else {
                t[field] = value;
            }
            renderApp();
            api.updateTask(t);
        },

        moveTaskToGroup: (id, groupId) => {
            const t = state.tasks.find(task => task.id === id);
            if (!t) return;
            t.groupId = groupId;
            if (groupId === 1) t.status = 'Not Started';
            if (groupId === 2) t.status = 'In Progress';
            if (groupId === 3) t.status = 'Done';
            renderApp();
            api.updateTask(t);
        }
    };
    window.actions = actions;

    // --- 5. RENDERERS ---

    function renderSidebar() {
        const { darkMode, workspaces, selectedWorkspace, projects, selectedProject } = state;
        const cardBg = darkMode ? 'bg-gray-900' : 'bg-white';
        const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
        const borderColor = darkMode ? 'border-gray-800' : 'border-gray-200';
        const hoverBg = darkMode ? 'hover:bg-gray-800' : 'hover:bg-gray-100';

        // Workspaces
        const wsHtml = workspaces.map(ws => {
            const isActive = ws.id === selectedWorkspace;
            const rowClasses = `${hoverBg} ${isActive ? 'bg-blue-600 text-white hover:bg-blue-600' : textColor}`;
            return `
                <div class="flex items-center justify-between px-3 py-2 rounded-lg cursor-pointer mb-1 ${rowClasses}"
                     onclick="actions.selectWorkspace(${ws.id})">
                    <div class="flex-1">
                        ${
                            state.ui.editingWorkspaceId === ws.id
                                ? `<input id="ws-name-input-${ws.id}" value="${ws.name}"
                                          class="w-full bg-transparent text-sm outline-none border-b border-blue-300"
                                          onblur="actions.saveWorkspaceName(${ws.id})"
                                          onkeypress="if(event.key==='Enter'){actions.saveWorkspaceName(${ws.id})}" />`
                                : `<span class="text-sm font-medium">${ws.name}</span>`
                        }
                    </div>
                    <div class="flex items-center gap-1 text-xs">
                        <button onclick="event.stopPropagation(); actions.startEditWorkspace(${ws.id})"
                                class="opacity-80 hover:opacity-100">
                            <i data-lucide="edit-2" class="w-3 h-3"></i>
                        </button>
                        <button onclick="event.stopPropagation(); actions.deleteWorkspace(${ws.id})"
                                class="opacity-80 hover:opacity-100">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        // Projects
        const projHtml = projects
            .filter(p => p.workspaceId === selectedWorkspace)
            .map(p => {
                const isActive = p.id === selectedProject;
                const rowClasses = isActive
                    ? 'bg-blue-100 text-blue-800'
                    : `${hoverBg} ${textColor}`;
                return `
                    <div class="flex items-center justify-between px-3 py-2 rounded-lg mb-1 cursor-pointer ${rowClasses}">
                        <div class="flex items-center gap-2 flex-1"
                             onclick="actions.selectProject(${p.id})">
                            <span class="w-2 h-2 rounded-full ${p.color}"></span>
                            ${
                                state.ui.editingProjectId === p.id
                                    ? `<input id="proj-name-input-${p.id}" value="${p.name}"
                                              class="w-full bg-transparent text-sm outline-none border-b border-blue-300"
                                              onblur="actions.saveProjectName(${p.id})"
                                              onkeypress="if(event.key==='Enter'){actions.saveProjectName(${p.id})}" />`
                                    : `<span class="text-sm">${p.name}</span>`
                            }
                        </div>
                        <div class="flex items-center gap-1 text-xs">
                            <button onclick="event.stopPropagation(); actions.startEditProject(${p.id})"
                                    class="opacity-80 hover:opacity-100">
                                <i data-lucide="edit-2" class="w-3 h-3"></i>
                            </button>
                            <button onclick="event.stopPropagation(); actions.deleteProject(${p.id})"
                                    class="opacity-80 hover:opacity-100">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('') || `
                <div class="text-xs text-gray-400 mt-1">No projects in this workspace.</div>
            `;

        return `
            <div class="w-72 ${cardBg} border-r ${borderColor} flex flex-col h-full">
                <div class="p-6 border-b ${borderColor}">
                    <h1 class="text-2xl font-bold ${textColor}">WellTask</h1>
                </div>

                <nav class="flex-1 p-4 space-y-6 overflow-y-auto">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Workspace</span>
                            <button onclick="actions.addWorkspace()"
                                    class="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">
                                <i data-lucide="plus" class="w-3 h-3"></i> New
                            </button>
                        </div>
                        ${wsHtml}
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Projects</span>
                            <button onclick="actions.addProject()"
                                    class="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">
                                <i data-lucide="plus" class="w-3 h-3"></i> New
                            </button>
                        </div>
                        ${projHtml}
                    </div>
                </nav>

                <div class="p-4 border-t ${borderColor}">
                    <button onclick="actions.toggleTheme()"
                            class="w-full flex items-center justify-between px-4 py-3 rounded-lg ${hoverBg} ${textColor}">
                        <span>Theme</span>
                        <i data-lucide="${darkMode ? 'sun' : 'moon'}" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        `;
    }

    // ---- Kanban View ----
    function renderKanbanView() {
        const { tasks, groups, darkMode, ui, projects, selectedProject } = state;
        const pageBg = darkMode ? 'bg-gray-900' : 'bg-gray-50';
        const panelBg = darkMode ? 'bg-gray-800' : 'bg-white';
        const textColor = darkMode ? 'text-gray-100' : 'text-gray-900';
        const subtleText = darkMode ? 'text-gray-400' : 'text-gray-500';
        const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';

        const project = projects.find(p => p.id === selectedProject);

        const header = `
            <div class="flex items-center justify-between mb-6">
                <div>
                    <p class="text-xs uppercase tracking-wide ${subtleText} mb-1">Project</p>
                    <h1 class="text-3xl font-bold ${textColor}">${project ? project.name : 'Project'}</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="actions.setView('list')"
                            class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 flex items-center gap-2 text-sm">
                        <i data-lucide="layout-list" class="w-4 h-4"></i> List View
                    </button>
                    <button onclick="actions.addGroup()"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 text-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> New Group
                    </button>
                </div>
            </div>
        `;

        const kanbanColumns = groups
            .filter(g => g.projectId === selectedProject)
            .map(grp => {
                const grpTasks = tasks.filter(t => t.groupId === grp.id);
                return `
                    <div class="${panelBg} border ${borderColor} rounded-2xl p-4 flex flex-col h-full max-h-[80vh] shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <button onclick="actions.toggleGroupCollapse(${grp.id})"
                                        class="${subtleText} hover:text-gray-600">
                                    <i data-lucide="${grp.collapsed ? 'chevron-right' : 'chevron-down'}" class="w-4 h-4"></i>
                                </button>
                                <div class="flex items-center gap-2">
                                    ${
                                        ui.editingGroupId === grp.id
                                            ? `<input id="group-name-input-${grp.id}" value="${grp.name}"
                                                      class="text-sm font-semibold bg-transparent outline-none border-b border-blue-300 ${textColor}"
                                                      onblur="actions.saveGroupName(${grp.id})"
                                                      onkeypress="if(event.key==='Enter'){actions.saveGroupName(${grp.id})}" />`
                                            : `<h2 class="text-sm font-semibold ${textColor}">${grp.name}</h2>`
                                    }
                                    <span class="bg-gray-100 dark:bg-gray-900 ${subtleText} text-xs px-2 py-1 rounded-full">${grpTasks.length}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 ${subtleText}">
                                <button onclick="actions.toggleColumnsPanel(${grp.id})"
                                        class="hover:text-gray-700 text-xs flex items-center gap-1">
                                    <i data-lucide="columns-3" class="w-3 h-3"></i> Columns
                                </button>
                                <button onclick="actions.startEditGroup(${grp.id})" class="hover:text-gray-700">
                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                </button>
                                <button onclick="actions.deleteGroup(${grp.id})" class="hover:text-red-600 text-red-500">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        ${ui.columnsGroupId === grp.id ? renderColumnsPanel(grp, borderColor, darkMode) : ''}

                        <div class="flex-1 overflow-y-auto space-y-3 pr-1 ${grp.collapsed ? 'hidden' : ''}">
                            ${grpTasks.map(t => `
                                <div class="bg-white dark:bg-gray-700 p-3 rounded-lg border ${borderColor} shadow-sm hover:shadow-md transition">
                                    <div class="flex items-start justify-between gap-2 mb-2">
                                        <div class="flex-1">
                                            ${
                                                ui.editingTaskId === t.id
                                                    ? `<input id="task-name-input-${t.id}" value="${t.name}"
                                                              class="w-full text-sm font-medium bg-transparent outline-none border-b border-blue-300 text-gray-900 dark:text-gray-50"
                                                              onblur="actions.saveTaskName('${t.id}')"
                                                              onkeypress="if(event.key==='Enter'){actions.saveTaskName('${t.id}')}" />`
                                                    : `<div class="font-medium text-gray-900 dark:text-gray-50">
                                                            ${t.name}
                                                       </div>`
                                            }
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button onclick="actions.startEditTaskName('${t.id}')"
                                                    class="${subtleText} hover:text-gray-200">
                                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="actions.deleteTask('${t.id}')"
                                                    class="text-red-500 hover:text-red-700">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center text-xs ${subtleText}">
                                        <div class="flex items-center gap-2">
                                            <select onchange="actions.moveTaskToGroup('${t.id}', parseInt(this.value))"
                                                    class="bg-gray-100 dark:bg-gray-800 rounded px-2 py-1">
                                                ${groups.filter(g => g.projectId === selectedProject).map(g => `
                                                    <option value="${g.id}" ${g.id === t.groupId ? 'selected' : ''}>${g.name}</option>
                                                `).join('')}
                                            </select>
                                            <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded">${t.priority}</span>
                                        </div>
                                        <span>${t.dueDate || ''}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="mt-3 pt-3 border-t ${borderColor} ${grp.collapsed ? 'hidden' : ''}">
                            ${
                                ui.showNewTask === grp.id
                                    ? `
                                        <div class="space-y-2">
                                            <input id="new-task-name-${grp.id}" type="text" placeholder="Task name..."
                                                   class="w-full p-2 text-sm border rounded dark:bg-gray-700 dark:text-gray-50"
                                                   autofocus
                                                   onkeypress="if(event.key==='Enter') actions.submitTask(${grp.id})">
                                            <button onclick="actions.submitTask(${grp.id})"
                                                    class="w-full bg-green-600 text-white px-3 py-1 rounded text-sm">
                                                Add Task
                                            </button>
                                        </div>
                                      `
                                    : `
                                        <button onclick="actions.setShowNewTask(${grp.id})"
                                                class="w-full py-2 text-sm text-blue-500 border border-dashed border-blue-300 rounded hover:bg-blue-50 dark:hover:bg-gray-900">
                                            + Add Task
                                        </button>
                                      `
                            }
                        </div>
                    </div>
                `;
            }).join('');

        return `
            <div class="p-6 h-full overflow-auto ${pageBg}">
                ${header}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 min-w-[900px]">
                    ${kanbanColumns}
                </div>
            </div>
        `;
    }

    function renderColumnsPanel(grp, borderColor, darkMode) {
        return `
            <div class="mb-3 rounded-xl border ${borderColor} ${darkMode ? 'bg-gray-900' : 'bg-gray-50'} p-3 text-xs">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold text-gray-600 dark:text-gray-200">Columns for "${grp.name}"</span>
                    <button onclick="actions.addColumn(${grp.id})"
                            class="flex items-center gap-1 text-blue-500 hover:text-blue-700">
                        <i data-lucide="plus" class="w-3 h-3"></i> Add Column
                    </button>
                </div>
                <div class="space-y-2 max-h-40 overflow-y-auto pr-1">
                    ${grp.columns.map(col => `
                        <div class="flex items-center gap-2">
                            <input id="col-name-${grp.id}-${col.id}" value="${col.name}"
                                   class="flex-1 px-2 py-1 rounded border ${borderColor} bg-white dark:bg-gray-800 dark:text-gray-100"
                                   onblur="actions.renameColumn(${grp.id}, '${col.id}')"
                                   onkeypress="if(event.key==='Enter'){actions.renameColumn(${grp.id}, '${col.id}')}" />
                            <span class="text-[10px] px-2 py-1 rounded-full ${col.isDefault ? 'bg-gray-200 text-gray-700' : 'bg-purple-100 text-purple-700'}">
                                ${col.isDefault ? 'Default' : 'Custom'}
                            </span>
                            <button onclick="actions.deleteColumn(${grp.id}, '${col.id}')"
                                    class="text-red-500 hover:text-red-700">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // ---- List View ----
    function renderListView() {
        const { tasks, groups, darkMode, ui, projects, selectedProject } = state;
        const pageBg = darkMode ? 'bg-gray-900' : 'bg-gray-50';
        const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
        const textColor = darkMode ? 'text-gray-100' : 'text-gray-900';
        const subtleText = darkMode ? 'text-gray-400' : 'text-gray-500';
        const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';

        const project = projects.find(p => p.id === selectedProject);

        const header = `
            <div class="flex items-center justify-between mb-6">
                <div>
                    <p class="text-xs uppercase tracking-wide ${subtleText} mb-1">Project</p>
                    <h1 class="text-3xl font-bold ${textColor}">${project ? project.name : 'Project'}</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="actions.setView('kanban')"
                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2 text-sm">
                        <i data-lucide="grid-3x3" class="w-4 h-4"></i> Kanban View
                    </button>
                    <button onclick="actions.addGroup()"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 text-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> New Group
                    </button>
                </div>
            </div>
        `;

        const groupBlocks = groups
            .filter(grp => grp.projectId === selectedProject)
            .map(grp => {
                const grpTasks = tasks.filter(t => t.groupId === grp.id);
                const cols = grp.columns;

                const headerCols = cols.map(col => `
                    <div class="flex-1 text-xs font-semibold ${subtleText}">${col.name}</div>
                `).join('') + `<div class="w-16 text-xs font-semibold ${subtleText} text-right">Actions</div>`;

                const rows = grpTasks.map(t => `
                    <div class="grid grid-cols-[minmax(0,1.8fr)_minmax(0,1.2fr)_repeat(${cols.length-2},minmax(0,1fr))_80px] items-center border-t ${borderColor} px-4 py-3 text-sm hover:bg-gray-50 dark:hover:bg-gray-700">
                        ${cols.map(col => renderCellForColumn(col, t, borderColor, darkMode)).join('')}
                        <div class="flex justify-end">
                            <button onclick="actions.deleteTask('${t.id}')" class="text-red-500 hover:text-red-700">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('') || `
                    <div class="border-t ${borderColor} px-4 py-4 text-sm ${subtleText}">
                        No tasks yet. Click "Add Task" to create one.
                    </div>
                `;

                return `
                    <div class="mb-6 rounded-2xl overflow-hidden border ${borderColor} shadow-sm ${cardBg}">
                        <div class="flex items-center justify-between px-4 py-3 border-b ${borderColor}">
                            <div class="flex items-center gap-2">
                                <button onclick="actions.toggleGroupCollapse(${grp.id})"
                                        class="${subtleText} hover:text-gray-600">
                                    <i data-lucide="${grp.collapsed ? 'chevron-right' : 'chevron-down'}" class="w-4 h-4"></i>
                                </button>
                                <div class="flex items-center gap-2">
                                    ${
                                        ui.editingGroupId === grp.id
                                            ? `<input id="group-name-input-${grp.id}" value="${grp.name}"
                                                      class="text-sm font-semibold bg-transparent outline-none border-b border-blue-300 ${textColor}"
                                                      onblur="actions.saveGroupName(${grp.id})"
                                                      onkeypress="if(event.key==='Enter'){actions.saveGroupName(${grp.id})}" />`
                                            : `<h2 class="text-sm font-semibold ${textColor}">${grp.name}</h2>`
                                    }
                                    <span class="bg-gray-100 dark:bg-gray-900 ${subtleText} text-xs px-2 py-1 rounded-full">${grpTasks.length}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 text-xs ${subtleText}">
                                <button onclick="actions.toggleColumnsPanel(${grp.id})"
                                        class="flex items-center gap-1 hover:text-gray-700">
                                    <i data-lucide="columns-3" class="w-3 h-3"></i> Columns
                                </button>
                                <button onclick="actions.startEditGroup(${grp.id})"
                                        class="hover:text-gray-700 flex items-center gap-1">
                                    <i data-lucide="edit-2" class="w-3 h-3"></i> Rename
                                </button>
                                <button onclick="actions.deleteGroup(${grp.id})"
                                        class="hover:text-red-600 text-red-500 flex items-center gap-1">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i> Delete
                                </button>
                            </div>
                        </div>

                        ${ui.columnsGroupId === grp.id ? renderColumnsPanel(grp, borderColor, darkMode) : ''}

                        <div class="${grp.collapsed ? 'hidden' : 'block'}">
                            <div class="grid grid-cols-[minmax(0,1.8fr)_minmax(0,1.2fr)_repeat(${cols.length-2},minmax(0,1fr))_80px] gap-2 px-4 py-3 text-xs bg-gray-50 dark:bg-gray-900 border-y ${borderColor}">
                                ${headerCols}
                            </div>
                            ${rows}
                            <div class="border-t ${borderColor} px-4 py-3 bg-gray-50 dark:bg-gray-900">
                                ${
                                    ui.showNewTask === grp.id
                                        ? `
                                            <div class="flex gap-2">
                                                <input id="new-task-name-${grp.id}" type="text" placeholder="Task name..."
                                                       class="flex-1 px-3 py-2 text-sm border rounded-lg dark:bg-gray-700 dark:text-gray-50"
                                                       autofocus
                                                       onkeypress="if(event.key==='Enter'){actions.submitTask(${grp.id})}">
                                                <button onclick="actions.submitTask(${grp.id})"
                                                        class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                                                    Add
                                                </button>
                                            </div>
                                          `
                                        : `
                                            <button onclick="actions.setShowNewTask(${grp.id})"
                                                    class="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">
                                                <i data-lucide="plus" class="w-3 h-3"></i> Add Task
                                            </button>
                                          `
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

        return `
            <div class="p-6 h-full overflow-auto ${pageBg}">
                ${header}
                ${groupBlocks}
            </div>
        `;
    }

    function renderCellForColumn(col, t, borderColor, darkMode) {
        const baseInput =
            `class="w-full px-2 py-1 text-sm border ${borderColor} rounded bg-white dark:bg-gray-800 dark:text-gray-100 focus:outline-none focus:ring-1 focus:ring-blue-400"`;

        if (col.id === 'task') {
            if (state.ui.editingTaskId === t.id) {
                return `
                    <div class="flex-1 mr-2 flex items-center gap-2">
                        <input id="task-name-input-${t.id}" value="${t.name}"
                               ${baseInput}
                               onblur="actions.saveTaskName('${t.id}')"
                               onkeypress="if(event.key==='Enter'){actions.saveTaskName('${t.id}')}" />
                    </div>
                `;
            }
            return `
                <div class="flex-1 mr-2 flex items-center gap-2">
                    <span class="text-gray-900 dark:text-gray-50">${t.name || 'Untitled task'}</span>
                    <button onclick="actions.startEditTaskName('${t.id}')"
                            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <i data-lucide="edit-2" class="w-3 h-3"></i>
                    </button>
                </div>
            `;
        }

        if (col.id === 'assignee') {
            const assigneeName = t.assignee ? t.assignee.name : '';
            return `
                <div class="flex-1 mr-2">
                    <select ${baseInput}
                            onchange="actions.updateTaskField('${t.id}', 'assignee', this.value || null)">
                        <option value="">Unassigned</option>
                        <option value="You" ${assigneeName === 'You' ? 'selected' : ''}>You</option>
                        <option value="${state.currentUser ? state.currentUser.name : 'Owner'}"
                            ${assigneeName === (state.currentUser ? state.currentUser.name : 'Owner') ? 'selected' : ''}>
                            ${state.currentUser ? state.currentUser.name : 'Owner'}
                        </option>
                        <option value="Team" ${assigneeName === 'Team' ? 'selected' : ''}>Team</option>
                    </select>
                </div>
            `;
        }

        if (col.id === 'priority') {
            const priorities = ['Low', 'Medium', 'High', 'Critical'];
            return `
                <div class="flex-1 mr-2">
                    <select ${baseInput}
                            onchange="actions.updateTaskField('${t.id}', 'priority', this.value)">
                        ${priorities.map(p => `
                            <option value="${p}" ${t.priority === p ? 'selected' : ''}>${p}</option>
                        `).join('')}
                    </select>
                </div>
            `;
        }

        if (col.id === 'status') {
            const statuses = ['Not Started', 'In Progress', 'Done'];
            return `
                <div class="flex-1 mr-2">
                    <select ${baseInput}
                            onchange="actions.updateTaskField('${t.id}', 'status', this.value)">
                        ${statuses.map(s => `
                            <option value="${s}" ${t.status === s ? 'selected' : ''}>${s}</option>
                        `).join('')}
                    </select>
                </div>
            `;
        }

        if (col.id === 'duedate') {
            return `
                <div class="flex-1 mr-2">
                    <input type="date" value="${t.dueDate || ''}"
                           ${baseInput}
                           onchange="actions.updateTaskField('${t.id}', 'dueDate', this.value)" />
                </div>
            `;
        }

        const val = (t.customFields && t.customFields[col.id]) || '';
        return `
            <div class="flex-1 mr-2">
                <input type="text" value="${val}"
                       ${baseInput}
                       onchange="actions.updateTaskField('${t.id}', 'custom', this.value, '${col.id}')" />
            </div>
        `;
    }

    function renderLogin() {
        return `
            <div class="h-screen flex items-center justify-center bg-gray-100 text-xl text-gray-600">
                Please access this dashboard via the Zoho Cliq Widget.
            </div>
        `;
    }

    function renderApp() {
        const app = document.getElementById('app');

        if (state.showLogin) {
            app.innerHTML = renderLogin();
        } else {
            const { darkMode } = state;
            const bgColor = darkMode ? 'bg-gray-900' : 'bg-gray-50';
            document.documentElement.classList.toggle('dark', darkMode);

            app.innerHTML = `
                <div class="flex h-screen ${bgColor}">
                    ${renderSidebar()}
                    <div class="flex-1 overflow-hidden">
                        ${state.currentView === 'kanban' ? renderKanbanView() : renderListView()}
                    </div>
                </div>
            `;
        }

        lucide.createIcons();
    }

    // AUTO SYNC (Every 3s)
    setInterval(() => {
        if (state.currentUser) api.fetchTasks();
    }, 3000);

    if (state.currentUser) api.fetchTasks();
    renderApp();
</script>

</body>
</html>
