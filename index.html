<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WellTask</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            gray: { 750: "#2d3748" }
          }
        }
      }
    };
  </script>
  <style>
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 4px;
    }

    .dark ::-webkit-scrollbar-thumb {
      background: #4a5568;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCaVEmWvh0_hcxFJQG00QAXNxRsIMpgy94",
      authDomain: "welltask-8bbcf.firebaseapp.com",
      projectId: "welltask-8bbcf",
      storageBucket: "welltask-8bbcf.firebasestorage.app",
      messagingSenderId: "533119656804",
      appId: "1:533119656804:web:ec296e70c7b7e5746c1071",
      measurementId: "G-3HD74YPC52"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    console.log("ðŸ”¥ Firebase initialized with project:", firebaseConfig.projectId);
  </script>
</head>

<body class="bg-gray-50 text-gray-800 transition-colors duration-200">
  <div id="app"></div>
  <script>
    // --- 1. CONFIGURATION ---
    console.log("ðŸ’¾ Firestore db available?", !!db);
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");

    // Logic: If channelId exists, use it as boardid. Otherwise, fallback to URL boardid.
    const mode = urlParams.get("mode") || "personal";
    const channelId = urlParams.get("channelId");
    let urlBoardId = urlParams.get("boardid");

    // If in team mode, the Channel ID IS the Board ID lookup key
    if (mode === "team" && channelId) {
      urlBoardId = channelId;
    }

    let currentUser = null;
    let boardid = null;
    let savedSession = null;

    // --- 2. AUTHENTICATION & TOKEN PARSING ---

    // A. Check Local Storage First (The "Refresh" Fix)
    try {
        const stored = localStorage.getItem("welltask_session");
        if (stored) {
            const parsed = JSON.parse(stored);
            // Allow session to last for 24 hours (86400000 ms)
            if (Date.now() - parsed.timestamp < 86400000) { 
                savedSession = parsed.user;
            }
        }
    } catch (e) { }

    // B. Check URL Token (The "Security" Fix)
    if (token) {
      try {
        const decoded = atob(token);
        const parts = decoded.split("::");
        
        // parts structure: [0]=email, [1]=id, [2]=timestamp, [3]=salt
        if (parts.length >= 4) {
          const tokenTime = parseInt(parts[2]);
          const receivedSalt = parts[3];
          const EXPECTED_SALT = "ZohoCliqtrixWinner2025"; 

          // ðŸ›¡ï¸ SECURITY CHECK 1: SALT VERIFICATION
          if (receivedSalt !== EXPECTED_SALT) {
             alert("â›”ï¸ Security Violation: Invalid Token Signature.\nAccess Denied.");
             throw new Error("Invalid Security Salt");
          }

          // ðŸ•’ SECURITY CHECK 2: EXPIRATION (10 Minutes)
          const currentTime = Date.now();
          const timeDiff = currentTime - tokenTime;

          if (timeDiff > 600000) { 
             alert("ðŸ”’ Security Alert: This session link has expired.\nPlease re-open the board from Zoho Cliq.");
             throw new Error("Token Expired");
          } else {
             console.log("âœ… Token Valid. Age:", Math.round(timeDiff/1000), "seconds");
          }

          currentUser = { 
            id: parts[1], 
            name: parts[0].split("@")[0], 
            email: parts[0].trim() 
          };
        } else {
           // Support for old tokens
           if(parts.length >= 2) {
             currentUser = { id: parts[1], name: parts[0].split("@")[0], email: parts[0].trim() };
           }
        }

        // âœ¨ NEW: SAVE SESSION TO BROWSER
        if (currentUser) {
            localStorage.setItem("welltask_session", JSON.stringify({
                user: currentUser,
                timestamp: Date.now() // Save when we logged in
            }));
        }
        
      } catch (e) { 
        console.error("Auth Failed", e); 
      }
    } else if (savedSession) {
        currentUser = savedSession;
        console.log("ðŸ”„ Restored Session for:", currentUser.email);
    }

    // C. Determine Initial Board ID
    if (currentUser) {
        if (mode === "team") {
            boardid = urlBoardId; // This is 'CT_...' initially
        } else {
            boardid = currentUser.id;
        }
        console.log("ðŸ” Auth Success:", currentUser.email, "Mode:", mode, "LookupID:", boardid);
    }

    const uid = () => Date.now().toString() + Math.floor(Math.random() * 1000);

    function getStorageKey() {
      return boardid ? `welltask_state_${boardid}` : null;
    }

    // Helper for colors
    function priorityClass(priority) {
      switch (priority) {
        case "Critical":
          return "bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300";
        case "High":
          return "bg-orange-100 text-orange-800 dark:bg-orange-500/20 dark:text-orange-300";
        case "Medium":
          return "bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-200";
        case "Low":
          return "bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300";
        default:
          return "bg-gray-100 text-gray-800 dark:bg-gray-500/20 dark:text-gray-200";
      }
    }

    // --- 3. FIREBASE LOGIC (UPDATED QUERY) ---
    async function firebaseLoadBoard(lookupId) {
      try {
        if (!lookupId) return null;

        // 1. Try Loading Directly by Document ID (Personal Boards or if we know the ID)
        let ref = db.collection("boards").doc(lookupId);
        let snap = await ref.get();

        if (snap.exists) {
            console.log("âœ… Found board by Document ID");
            return snap.data();
        }

        // 2. If Direct ID fails, and we are in Team Mode, try Querying by channel_id
        // The URL gives us 'CT_...'. We need to find the document that *contains* that ID.
        if (mode === "team") {
            console.log("âš ï¸ Doc ID not found, querying by channel_id:", lookupId);
            
            // Query: Find document where field 'channel_id' == 'CT_...'
            const q = db.collection("boards").where("channel_id", "==", lookupId);
            const querySnap = await q.get();

            if (!querySnap.empty) {
                const doc = querySnap.docs[0];
                const realData = doc.data();
                
                // IMPORTANT: Update the global 'boardid' to the REAL numeric Document ID (1765...)
                // This ensures future Saves go to the correct document, not a new 'CT_...' doc.
                boardid = doc.id; 
                console.log("âœ… Board found via Query! Real Document ID is:", boardid);
                
                return realData;
            } else {
                console.log("âŒ No board found for this Channel ID.");
            }
        }

        return null;
      } catch (e) {
        console.error("ðŸ’¥ [Firebase] Load error:", e);
        return null;
      }
    }

    async function firebaseSaveBoard(docId, payload) {
      try {
        if (!docId) return;
        const ref = db.collection("boards").doc(docId);
        await ref.set({
          ...payload,
          boardid: docId,
          updatedAt: Date.now()
        });
      } catch (e) {
        console.error("ðŸ’¥ [Firebase] Save error:", e);
      }
    }

    // --- 4. STATE MANAGEMENT ---
    const initialState = {
      darkMode: false,
      currentUser,
      showLogin: !currentUser,
      showAuthWindow: !!currentUser,
      isAuthenticated: false,
      isLoading: false,
      saveStatus: "saved",
      currentView: "list",
      workspaces: [],
      projects: [],
      groups: [],
      tasks: [],
      ui: {
        showNewTask: null,
        newTask: {},
        editingWorkspaceId: null,
        editingWorkspaceName: "",
        editingProjectId: null,
        editingProjectName: "",
        editingTaskId: null,
        editingGroupId: null,
        editingGroupName: "",
        editingColumnGroupId: null,
        editingColumnId: null
      }
    };

    let state = {
      ...initialState
    };

    // --- 5. PERMISSION CHECKER (FIXED) ---
    function checkBoardPermission(board) {
      if (!board) return true; // New board (allow access so it can be created)
      if (!currentUser) return false;

      // 1. OWNER OVERRIDE: If I am the owner, always let me in.
      // This prevents "Access Denied" on your own Personal boards.
      if (board.ownerId && board.ownerId === currentUser.id) {
          console.log("ðŸ”“ Access Granted: User is the Owner");
          return true;
      }

      const userEmail = currentUser.email.toLowerCase().trim();
      const allowed = (board.allowed_users || []).map(e => e.toLowerCase().trim());

      console.log(`ðŸ•µï¸ Checking Access. User: ${userEmail}`);

      // 2. Check the Allowed List
      return allowed.includes(userEmail);
    }


    // --- 6. CORE API ---
    const api = {
      saveTimer: null,
      load: async () => {
        if (!state.isAuthenticated) {
          if (state.currentUser) {
            state.showAuthWindow = true;
          } else {
            state.showLogin = true;
          }
          renderApp();
          return;
        }

        state.isLoading = true;
        renderApp();

        try {
          const key = getStorageKey();
          let loaded = false;
          let fbData = null;

          // 1. Try Loading from Firebase
          if (boardid) {
            // Note: boardid might be 'CT_...' initially. 
            // firebaseLoadBoard will update it to '1765...' if found via query.
            fbData = await firebaseLoadBoard(boardid);

            if (fbData) {
              // â›”ï¸ SECURITY CHECK POINT
              const hasAccess = checkBoardPermission(fbData);
              if (!hasAccess) {
                alert("ðŸš« ACCESS DENIED.\nYou are not listed in the 'allowed_users' for this board.");
                state.showLogin = true;
                state.isLoading = false;
                renderApp();
                return; // STOP EXECUTION
              }
              applyLoadedState(fbData);
              loaded = true;
            } else {
              // Board doesn't exist yet (Fresh Personal or Team Board)
              console.log("âœ¨ Creating New Board");
            }
          }

          if (!loaded) api.initDefaults();

        } catch (e) {
          console.error(e);
          api.initDefaults();
        } finally {
          state.isLoading = false;
          renderApp();
        }
      },

      initDefaults: () => {
        const wsId = uid();
        const pId = uid();
        const g1 = uid(),
          g2 = uid(),
          g3 = uid();
        const defaultColumns = [{
          id: "task",
          name: "Task",
          isDefault: true
        }, {
          id: "assignee",
          name: "Assignee",
          isDefault: true
        }, {
          id: "priority",
          name: "Priority",
          isDefault: true
        }, {
          id: "status",
          name: "Status",
          isDefault: true
        }, {
          id: "duedate",
          name: "Due Date",
          isDefault: true
        }];

        state.workspaces = [{
          id: wsId,
          name: "My Workspace",
          isFavorite: false,
          collapsed: false
        }];
        state.projects = [{
          id: pId,
          name: "My Project",
          color: "bg-purple-500",
          workspaceId: wsId,
          isFavorite: false
        }];
        state.groups = [{
          id: g1,
          name: "To Do",
          projectId: pId,
          collapsed: false,
          columns: JSON.parse(JSON.stringify(defaultColumns))
        }];
        state.tasks = [];
        state.selectedWorkspace = wsId;
        state.selectedProject = pId;

        // SAVE IMMEDIATELY TO LOCK PERMISSIONS
        api.triggerSave();
      },

      triggerSave: () => {
        if (api.saveTimer) clearTimeout(api.saveTimer);
        state.saveStatus = "pending";
        renderStatusIndicator();
        api.saveTimer = setTimeout(api.performSave, 1500);
      },

      performSave: async () => {
        if (!boardid || !state.currentUser) return;
        try {
          state.saveStatus = "saving";
          renderStatusIndicator();

          // --- ðŸ”’ PERMISSION LOGIC ---
          let allowedUsers = [];

          // A. TEAM MODE: Preserve existing teammates
          if (mode === "team") {
            // Try to load existing permissions so we don't wipe teammates
            const existing = await firebaseLoadBoard(boardid);
            if (existing && existing.allowed_users) {
              allowedUsers = existing.allowed_users;
            }
            // Add myself if I'm not in there
            if (!allowedUsers.includes(state.currentUser.email)) {
              allowedUsers.push(state.currentUser.email);
            }
          }

          // B. PERSONAL MODE: STRICTLY LIMIT TO OWNER ONLY
          // This wipes any other users to ensure privacy.
          if (mode === "personal") {
            allowedUsers = [state.currentUser.email];
          }

          const payload = {
            darkMode: state.darkMode,
            currentView: state.currentView,
            workspaces: state.workspaces,
            projects: state.projects,
            groups: state.groups,
            tasks: state.tasks,
            type: mode, 
            ownerId: state.currentUser.id,
            allowed_users: allowedUsers, // ðŸ‘ˆ This applies the security rule
            channel_id: (mode === "team") ? (channelId || null) : null,
            updatedAt: Date.now()
          };

          await firebaseSaveBoard(boardid, payload);
          state.saveStatus = "saved";
        } catch (e) {
          console.error(e);
          state.saveStatus = "error";
        } finally {
          renderStatusIndicator();
        }
      }
    };

    function applyLoadedState(parsed) {
      state.workspaces = parsed.workspaces || [];
      state.projects = parsed.projects || [];
      state.groups = parsed.groups || [];
      state.tasks = parsed.tasks || [];
      state.currentView = parsed.currentView || "list";
      state.darkMode = !!parsed.darkMode;

      // Fix: Ensure selectedWorkspace exists
      if (state.workspaces.length > 0 && !state.workspaces.find(w => w.id === state.selectedWorkspace)) {
        state.selectedWorkspace = state.workspaces[0].id;
      }
      if (state.projects.length > 0) {
        const proj = state.projects.find(p => p.workspaceId === state.selectedWorkspace);
        state.selectedProject = (proj && proj.id) || state.projects[0].id;
      }
    }

    const actions = {
      toggleFavoriteWorkspace(id) {
        const ws = state.workspaces.find(w => w.id === id);
        if (!ws) return;
        ws.isFavorite = !ws.isFavorite;
        api.triggerSave();
        renderApp();
      },
      toggleFavoriteProject(id) {
        const p = state.projects.find(pr => pr.id === id);
        if (!p) return;
        p.isFavorite = !p.isFavorite;
        api.triggerSave();
        renderApp();
      },
      toggleWorkspaceCollapse: (id) => {
        const ws = state.workspaces.find(w => w.id === id);
        if (!ws) return;
        ws.collapsed = !ws.collapsed;
        renderApp();
        api.triggerSave();
      },
      addProjectToWorkspace: (wsId) => {
        const id = uid();
        state.projects.push({
          id,
          name: "New Project",
          color: "bg-green-500",
          workspaceId: wsId
        });
        state.selectedProject = id;
        const g1 = uid();
        state.groups.push({
          id: g1,
          name: "To Do",
          projectId: id,
          collapsed: false,
          columns: [{
              id: "task",
              name: "Task",
              isDefault: true
            },
            {
              id: "assignee",
              name: "Assignee",
              isDefault: true
            },
            {
              id: "priority",
              name: "Priority",
              isDefault: true
            },
            {
              id: "status",
              name: "Status",
              isDefault: true
            },
            {
              id: "duedate",
              name: "Due Date",
              isDefault: true
            }
          ]
        });
        renderApp();
        api.triggerSave();
      },
      toggleTheme: () => {
        state.darkMode = !state.darkMode;
        renderApp();
        api.triggerSave();
      },
      setView: (view) => {
        state.currentView = view;
        renderApp();
        api.triggerSave();
      },
      selectWorkspace: (id) => {
        state.selectedWorkspace = id;
        const proj = state.projects.find(p => p.workspaceId === id);
        state.selectedProject = proj ? proj.id : null;
        renderApp();
      },
      addWorkspace: () => {
        const name = prompt("Enter workspace name:");
        if (!name || !name.trim()) return;
        const id = uid();
        state.workspaces.push({
          id,
          name: name.trim(),
          collapsed: false,
          isFavorite: false
        });
        state.selectedWorkspace = id;
        renderApp();
        api.triggerSave();
      },
      addProject: () => {
        if (!state.selectedWorkspace) return;
        const name = prompt("Enter project name:");
        if (!name || !name.trim()) return;
        const id = uid();
        state.projects.push({
          id,
          name: name.trim(),
          color: "bg-green-500",
          workspaceId: state.selectedWorkspace,
          isFavorite: false
        });
        state.selectedProject = id;
        const g1 = uid();
        state.groups.push({
          id: g1,
          name: "To Do",
          projectId: id,
          collapsed: false,
          columns: [{
              id: "task",
              name: "Task",
              isDefault: true
            },
            {
              id: "assignee",
              name: "Assignee",
              isDefault: true
            },
            {
              id: "priority",
              name: "Priority",
              isDefault: true
            },
            {
              id: "status",
              name: "Status",
              isDefault: true
            },
            {
              id: "duedate",
              name: "Due Date",
              isDefault: true
            }
          ]
        });
        renderApp();
        api.triggerSave();
      },
      startEditWorkspace: (id) => {
        const ws = state.workspaces.find(w => w.id === id);
        if (ws) {
          state.ui.editingWorkspaceId = id;
          state.ui.editingWorkspaceName = ws.name;
          renderApp();
          // FIX: Add focus logic
          setTimeout(() => {
            const el = document.getElementById(`ws-name-input-${id}`);
            if (el) {
              el.focus();
              el.select();
            }
          }, 60);
        }
      },
      saveWorkspaceName: (id) => {
        const input = document.getElementById(`ws-name-input-${id}`);
        const ws = state.workspaces.find(w => w.id === id);
        if (ws && input && input.value.trim()) {
          ws.name = input.value.trim();
          api.triggerSave();
        }
        state.ui.editingWorkspaceId = null;
        renderApp();
      },
      deleteWorkspace: (id) => {
        if (state.workspaces.length <= 1) return alert("Keep at least one workspace.");
        state.workspaces = state.workspaces.filter(w => w.id !== id);
        if (state.selectedWorkspace === id) state.selectedWorkspace = state.workspaces[0].id;
        state.projects = state.projects.filter(p => p.workspaceId !== id);
        renderApp();
        api.triggerSave();
      },
      selectProject: (id) => {
        state.selectedProject = id;
        renderApp();
      },
      startEditProject: (id) => {
        const p = state.projects.find(pr => pr.id === id);
        if (p) {
          state.ui.editingProjectId = id;
          state.ui.editingProjectName = p.name;
          renderApp();
          // FIX: Add focus logic
          setTimeout(() => {
            const el = document.getElementById(`proj-name-input-${id}`);
            if (el) {
              el.focus();
              el.select();
            }
          }, 60);
        }
      },
      saveProjectName: (id) => {
        const input = document.getElementById(`proj-name-input-${id}`);
        const p = state.projects.find(pr => pr.id === id);
        if (p && input && input.value.trim()) {
          p.name = input.value.trim();
          api.triggerSave();
        }
        state.ui.editingProjectId = null;
        renderApp();
      },
      deleteProject: (id) => {
        if (!confirm("Delete Project?")) return;
        state.projects = state.projects.filter(p => p.id !== id);
        state.groups = state.groups.filter(g => g.projectId !== id);
        state.tasks = state.tasks.filter(t => t.projectId !== id);
        state.selectedProject = state.projects[0]?.id || null;
        renderApp();
        api.triggerSave();
      },
      toggleGroupCollapse: (id) => {
        const g = state.groups.find(gr => gr.id === id);
        if (g) {
          g.collapsed = !g.collapsed;
          renderApp();
          api.triggerSave();
        }
      },
      addGroup: () => {
        if (!state.selectedProject) return;
        const base = state.groups.find(g => g.projectId === state.selectedProject);
        state.groups.push({
          id: uid(),
          name: "New Group",
          projectId: state.selectedProject,
          collapsed: false,
          columns: base ? JSON.parse(JSON.stringify(base.columns)) : []
        });
        renderApp();
        api.triggerSave();
      },
      startEditGroup: (id) => {
        const g = state.groups.find(gr => gr.id === id);
        if (g) {
          state.ui.editingGroupId = id;
          state.ui.editingGroupName = g.name;
          renderApp();
        }
      },
      saveGroupName: (id) => {
        const input = document.getElementById(`group-name-input-${id}`);
        const g = state.groups.find(gr => gr.id === id);
        if (g && input && input.value.trim()) {
          g.name = input.value.trim();
          api.triggerSave();
        }
        state.ui.editingGroupId = null;
        renderApp();
      },
      deleteGroup: (id) => {
        if (!confirm("Delete group?")) return;
        state.groups = state.groups.filter(g => g.id !== id);
        renderApp();
        api.triggerSave();
      },
      toggleColumnsPanel: (gid) => {
        state.ui.columnsGroupId = state.ui.columnsGroupId === gid ? null : gid;
        renderApp();
      },
      addColumn: (gid) => {
        const g = state.groups.find(gr => gr.id === gid);
        if (g) {
          g.columns.push({
            id: "col_" + uid(),
            name: "New Column",
            isDefault: false
          });
          renderApp();
          api.triggerSave();
        }
      },
      deleteColumn: (gid, colId) => {
        const g = state.groups.find(gr => gr.id === gid);
        if (g) {
          g.columns = g.columns.filter(c => c.id !== colId);
          renderApp();
          api.triggerSave();
        }
      },
      startEditColumn: (gid, colId) => {
        state.ui.editingColumnGroupId = gid;
        state.ui.editingColumnId = colId;
        renderApp();
        setTimeout(() => {
          const el = document.getElementById(`col-name-input-${gid}-${colId}`);
          if (el) el.focus();
        }, 50);
      },
      saveColumnName: (gid, colId) => {
        const input = document.getElementById(`col-name-input-${gid}-${colId}`);
        const g = state.groups.find(gr => gr.id === gid);
        if (g && input) {
          const col = g.columns.find(c => c.id === colId);
          if (col && input.value.trim()) {
            col.name = input.value.trim();
            api.triggerSave();
          }
        }
        state.ui.editingColumnGroupId = null;
        state.ui.editingColumnId = null;
        renderApp();
      },
      setShowNewTask: (gid) => {
        state.ui.showNewTask = gid;
        const favProject = state.projects.find(p => p.isFavorite);
        if (favProject) state.selectedProject = favProject.id;
        const favWorkspace = state.workspaces.find(w => w.isFavorite);
        if (favWorkspace) state.selectedWorkspace = favWorkspace.id;
        state.ui.newTask = {
          name: "",
          assignee: null,
          priority: "Medium",
          status: "Not Started",
          dueDate: "",
          customFields: {}
        };
        renderApp();
      },
      submitTask: (gid) => {
        const input = document.getElementById(`new-task-name-${gid}`);
        if (!input || !input.value.trim()) return;
        state.tasks.push({
          id: uid(),
          name: input.value.trim(),
          groupId: gid,
          projectId: state.selectedProject,
          priority: "Medium",
          status: "Not Started",
          assignee: null,
          dueDate: "",
          customFields: {}
        });
        state.ui.showNewTask = null;
        renderApp();
        api.triggerSave();
      },
      startEditTaskName: (id) => {
        state.ui.editingTaskId = id;
        renderApp();
        setTimeout(() => document.getElementById(`task-name-input-${id}`)?.focus(), 10);
      },
      saveTaskName: (id) => {
        const input = document.getElementById(`task-name-input-${id}`);
        const t = state.tasks.find(task => task.id === id);
        if (t && input && input.value.trim()) {
          t.name = input.value.trim();
          api.triggerSave();
        }
        state.ui.editingTaskId = null;
        renderApp();
      },
      updateTaskField: (id, field, val, extra) => {
        const t = state.tasks.find(task => task.id === id);
        if (!t) return;
        if (field === "assignee") t.assignee = val ? {
          name: val
        } : null;
        else if (field === "custom") {
          if (!t.customFields) t.customFields = {};
          t.customFields[extra] = val;
        } else t[field] = val;
        renderApp();
        api.triggerSave();
      },
      deleteTask: (id) => {
        state.tasks = state.tasks.filter(t => t.id !== id);
        renderApp();
        api.triggerSave();
      }
    };
    window.actions = actions;

    function renderStatusIndicator() {
      const el = document.getElementById("save-status");
      if (!el) return;
      let html = "";
      if (state.saveStatus === "saving") html = '<span class="text-blue-500 flex items-center gap-1"><i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Saving...</span>';
      else if (state.saveStatus === "error") html = '<span class="text-red-500 flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> Failed</span>';
      else if (state.saveStatus === "pending") html = '<span class="text-yellow-500">...</span>';
      else html = '<span class="text-green-500 flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> Saved</span>';
      el.innerHTML = html;
      lucide.createIcons();
    }

    function renderSidebar() {
      const activeWs = state.workspaces.find(w => w.id === state.selectedWorkspace);
      return `
        <div class="w-64 border-r dark:border-gray-700 bg-white dark:bg-gray-800 flex flex-col h-full flex-shrink-0">
          <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
            <div class="flex items-center gap-2 font-bold text-gray-700 dark:text-gray-100">
              <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white"><i data-lucide="check-square" class="w-5 h-5"></i></div>
              WellTask
            </div>
            <div id="save-status" class="text-xs"></div>
          </div>
          <div class="flex-1 overflow-y-auto p-3 space-y-2">
            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Workspaces</div>
            ${[...state.workspaces].sort((a, b) => (b.isFavorite ? 1 : 0) - (a.isFavorite ? 1 : 0)).map(w => {
        const wsProjects = state.projects.filter(p => p.workspaceId === w.id).sort((a, b) => (b.isFavorite ? 1 : 0) - (a.isFavorite ? 1 : 0));
        const isActive = w.id === state.selectedWorkspace;
        const collapsed = w.collapsed ?? false;
        return `
                <div class="group">
                  <div onclick="actions.selectWorkspace('${w.id}')" class="flex items-center justify-between px-2 py-1 rounded cursor-pointer ${isActive ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600' : 'text-gray-700 dark:text-gray-300'} hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="flex items-center gap-2">
                      <button onclick="event.stopPropagation(); actions.toggleWorkspaceCollapse('${w.id}')" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i data-lucide="${collapsed ? 'chevron-right' : 'chevron-down'}" class="w-4 h-4"></i></button>
                      ${state.ui.editingWorkspaceId === w.id ? `<input id="ws-name-input-${w.id}" class="text-sm bg-white dark:bg-gray-700 border border-blue-500 rounded px-1 py-0.5 w-32" value="${state.ui.editingWorkspaceName}" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()" onblur="actions.saveWorkspaceName('${w.id}')" onkeydown="if(event.key==='Enter') actions.saveWorkspaceName('${w.id}')" />` : `<span class="font-medium truncate text-sm cursor-text" ondblclick="event.stopPropagation(); actions.startEditWorkspace('${w.id}')">${w.name}</span>`}
                    </div>
                    <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition" onclick="event.stopPropagation()">
                      <i data-lucide="${w.isFavorite ? 'star' : 'star-off'}" class="w-4 h-4 cursor-pointer text-yellow-400 hover:text-yellow-500" onclick="event.stopPropagation(); actions.toggleFavoriteWorkspace('${w.id}')"></i>
                      <i data-lucide="pencil" class="w-3 h-3 text-gray-400 hover:text-blue-500 cursor-pointer" onclick="actions.startEditWorkspace('${w.id}'); event.stopPropagation();"></i>
                      <i data-lucide="trash-2" class="w-3 h-3 text-red-400 hover:text-red-600 cursor-pointer" onclick="actions.deleteWorkspace('${w.id}'); event.stopPropagation();"></i>
                    </div>
                  </div>
                  ${!collapsed ? `<div class="ml-6 mt-1 space-y-1">
                    ${wsProjects.length === 0 ? `<div class="text-xs text-gray-400 italic pl-2">No projects</div>` : wsProjects.map(p => `
                      <div class="group flex items-center justify-between px-2 py-1.5 rounded cursor-pointer ${p.id === state.selectedProject ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600' : 'text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700'}" onclick="actions.selectProject('${p.id}')">
                        <div class="flex items-center gap-2 truncate">
                          <span class="w-2 h-2 rounded-full ${p.color || 'bg-gray-400'}"></span>
                          ${state.ui.editingProjectId === p.id ? `<input id="proj-name-input-${p.id}" class="text-xs bg-white dark:bg-gray-700 border border-blue-500 rounded px-1 py-0.5 w-32" value="${state.ui.editingProjectName}" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()" onblur="actions.saveProjectName('${p.id}')" onkeydown="if(event.key==='Enter') actions.saveProjectName('${p.id}')" />` : `<span class="text-xs cursor-text" ondblclick="event.stopPropagation(); actions.startEditProject('${p.id}')">${p.name}</span>`}
                        </div>
                        <div class="hidden group-hover:flex items-center gap-1" onclick="event.stopPropagation()">
                          <i data-lucide="${p.isFavorite ? 'star' : 'star-off'}" class="w-4 h-4 cursor-pointer text-yellow-400 hover:text-yellow-500" onclick="event.stopPropagation(); actions.toggleFavoriteProject('${p.id}')"></i>
                          <i data-lucide="edit-2" class="w-3 h-3 text-gray-400 hover:text-blue-500 cursor-pointer" onclick="actions.startEditProject('${p.id}'); event.stopPropagation();"></i>
                          <i data-lucide="trash" class="w-3 h-3 text-gray-400 hover:text-red-500 cursor-pointer" onclick="actions.deleteProject('${p.id}'); event.stopPropagation();"></i>
                        </div>
                      </div>
                    `).join('')}
                    <button onclick="event.stopPropagation(); actions.addProjectToWorkspace('${w.id}')" class="text-xs text-blue-500 hover:underline pl-2">+ Add Project</button>
                  </div>` : ''}
                </div>
              `;
      }).join('')}
            <button onclick="actions.addWorkspace()" class="w-full text-left text-xs text-blue-500 hover:underline mt-2 px-2">+ Add Workspace</button>
          </div>
          <div class="p-4 border-t dark:border-gray-700 text-xs text-gray-500">
            <button onclick="actions.toggleTheme()" class="flex items-center gap-2 hover:text-gray-900 dark:hover:text-gray-200"><i data-lucide="${state.darkMode ? 'sun' : 'moon'}" class="w-4 h-4"></i> ${state.darkMode ? 'Light Mode' : 'Dark Mode'}</button>
            ${state.currentUser ? `<div class="mt-2 truncate">ðŸ‘¤ ${state.currentUser.name}</div>` : ''}
          </div>
        </div>
      `;
    }

    function renderCellForColumn(task, col) {
      if (col.id === 'task') {
        return state.ui.editingTaskId === task.id ?
          `<input id="task-name-input-${task.id}" class="w-full bg-white dark:bg-gray-700 border border-blue-400 rounded px-2 py-1" value="${task.name}" onblur="actions.saveTaskName('${task.id}')" onkeydown="if(event.key==='Enter') actions.saveTaskName('${task.id}')" autofocus />` :
          `<div class="flex items-center justify-between group"><span class="cursor-text hover:text-blue-600 dark:hover:text-blue-400" onclick="actions.startEditTaskName('${task.id}')">${task.name}</span><i data-lucide="pencil" class="w-3 h-3 text-gray-400 hover:text-blue-500 opacity-0 group-hover:opacity-100 cursor-pointer transition" onclick="event.stopPropagation(); actions.startEditTaskName('${task.id}')"></i></div>`;
      }
      if (col.id === 'priority') {
        const p = task.priority || 'Medium';
        return `<select onchange="actions.updateTaskField('${task.id}', 'priority', this.value)" class="text-xs border-0 bg-transparent rounded px-1.5 py-0.5 cursor-pointer ${priorityClass(p)}"><option value="Low" ${p === 'Low' ? 'selected' : ''}>Low</option><option value="Medium" ${p === 'Medium' ? 'selected' : ''}>Medium</option><option value="High" ${p === 'High' ? 'selected' : ''}>High</option><option value="Critical" ${p === 'Critical' ? 'selected' : ''}>Critical</option></select>`;
      }
      if (col.id === 'status') {
        return `<select onchange="actions.updateTaskField('${task.id}', 'status', this.value)" class="bg-transparent text-xs border border-gray-200 dark:border-gray-600 rounded px-1"><option value="Not Started" ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option><option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option><option value="Done" ${task.status === 'Done' ? 'selected' : ''}>Done</option><option value="Stuck" ${task.status === 'Stuck' ? 'selected' : ''}>Stuck</option></select>`;
      }
      if (col.id === 'assignee') {
        return `<input type="text" placeholder="Unassigned" class="bg-transparent w-full text-xs focus:outline-none" value="${task.assignee?.name || ''}" onchange="actions.updateTaskField('${task.id}', 'assignee', this.value)" />`;
      }
      if (col.id === 'duedate') {
        return `<input type="date" class="bg-transparent text-xs text-gray-500 dark:text-gray-400 focus:outline-none" value="${task.dueDate || ''}" onchange="actions.updateTaskField('${task.id}', 'dueDate', this.value)" />`;
      }
      const val = (task.customFields && task.customFields[col.id]) || "";
      return `<input type="text" class="bg-transparent w-full text-xs focus:outline-none text-gray-600 dark:text-gray-300" value="${val}" onchange="actions.updateTaskField('${task.id}', 'custom', this.value, '${col.id}')" />`;
    }

    function renderListView() {
      const projectGroups = state.groups.filter(g => g.projectId === state.selectedProject);
      const activeProject = state.projects.find(p => p.id === state.selectedProject);
      if (!activeProject) return `<div class="p-10 text-gray-400">Select a project</div>`;

      return `
      <div class="h-full flex flex-col bg-white dark:bg-gray-900">
         <div class="px-6 py-4 border-b dark:border-gray-700 flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2"><span class="w-3 h-3 rounded-full ${activeProject.color}"></span>${activeProject.name}</h1>
              <p class="text-sm text-gray-500">List View</p>
            </div>
            <div class="flex gap-2 bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
               <button class="px-3 py-1 rounded shadow bg-white dark:bg-gray-700 text-xs font-medium">List</button>
               <button onclick="actions.setView('kanban')" class="px-3 py-1 rounded text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-600 text-xs font-medium">Kanban</button>
            </div>
         </div>
         <div class="flex-1 overflow-y-auto p-6 space-y-8">
            ${projectGroups.map(group => {
        const groupTasks = state.tasks.filter(t => t.groupId === group.id);
        return `
                 <div class="mb-8">
                    <div class="flex items-center gap-2 mb-2 group">
                       <button onclick="actions.toggleGroupCollapse('${group.id}')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-500 transition-transform ${group.collapsed ? '-rotate-90' : ''}"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>
                       ${state.ui.editingGroupId === group.id ? `<input id="group-name-input-${group.id}" value="${state.ui.editingGroupName}" class="border rounded px-2 py-1 text-lg font-medium dark:bg-gray-800 dark:text-white" onblur="actions.saveGroupName('${group.id}')" onkeydown="if(event.key==='Enter') actions.saveGroupName('${group.id}')" />` : `<h2 class="text-lg font-medium text-${activeProject.color.split('-')[1] || 'blue'}-600 dark:text-${activeProject.color.split('-')[1] || 'blue'}-400 cursor-pointer" ondblclick="actions.startEditGroup('${group.id}')">${group.name}</h2>`}
                       <span class="text-xs text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded-full">${groupTasks.length} tasks</span>
                       <div class="relative ml-auto">
                          <button onclick="actions.toggleColumnsPanel('${group.id}')" class="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-blue-500"><i data-lucide="plus-circle" class="w-4 h-4"></i></button>
                          ${state.ui.columnsGroupId === group.id ? renderColumnsPanel(group) : ''}
                       </div>
                       <button onclick="actions.deleteGroup('${group.id}')" class="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    ${!group.collapsed ? `
                      <div class="overflow-x-auto rounded-lg border dark:border-gray-700">
                        <table class="w-full text-left border-collapse">
                          <thead>
                            <tr class="bg-gray-50 dark:bg-gray-800 text-xs text-gray-500 dark:text-gray-400 border-b dark:border-gray-700">
                              <th class="w-8 p-2 text-center"></th>
                              ${group.columns.map(col => `
                                <th class="font-normal p-2 border-r dark:border-gray-700 min-w-[150px] group/col">
                                  <div class="flex items-center justify-between">
                                    ${state.ui.editingColumnGroupId === group.id && state.ui.editingColumnId === col.id ? `<input id="col-name-input-${group.id}-${col.id}" class="w-full bg-white dark:bg-gray-700 border border-blue-500 rounded px-1 py-0.5 text-xs font-normal" value="${col.name}" onblur="actions.saveColumnName('${group.id}', '${col.id}')" onkeydown="if(event.key==='Enter') actions.saveColumnName('${group.id}', '${col.id}')" />` : `<span class="cursor-pointer hover:text-blue-600 dark:hover:text-blue-400" ondblclick="actions.startEditColumn('${group.id}', '${col.id}')" title="Double-click to rename">${col.name}</span>`}
                                    <i data-lucide="x" class="w-3 h-3 cursor-pointer hover:text-red-500 opacity-0 group-hover/col:opacity-100" onclick="event.stopPropagation(); actions.deleteColumn('${group.id}', '${col.id}')"></i>
                                  </div>
                                </th>
                              `).join('')}
                              <th class="w-10"></th>
                            </tr>
                          </thead>
                          <tbody class="text-sm divide-y dark:divide-gray-700 bg-white dark:bg-gray-900">
                             ${groupTasks.map(task => `
                               <tr class="group/row hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                 <td class="p-2 text-center text-gray-300"><i data-lucide="grip-vertical" class="w-4 h-4"></i></td>
                                 ${group.columns.map(col => `<td class="p-2 border-r dark:border-gray-700 text-gray-700 dark:text-gray-200">${renderCellForColumn(task, col)}</td>`).join('')}
                                 <td class="p-2 text-center"><button onclick="actions.deleteTask('${task.id}')" class="opacity-0 group-hover/row:opacity-100 text-gray-400 hover:text-red-500"><i data-lucide="trash" class="w-4 h-4"></i></button></td>
                               </tr>
                             `).join('')}
                             ${state.ui.showNewTask === group.id
              ? `<tr class="bg-blue-50 dark:bg-blue-900/10"><td class="p-2"></td><td class="p-2 border-r dark:border-gray-700"><input id="new-task-name-${group.id}" class="w-full bg-transparent border-b border-blue-500 focus:outline-none" placeholder="Task name..." autofocus onkeydown="if(event.key==='Enter') actions.submitTask('${group.id}')" /></td><td colspan="${group.columns.length}" class="p-2"><button onclick="actions.submitTask('${group.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs">Add</button><button onclick="actions.setShowNewTask(null)" class="ml-2 text-gray-500 text-xs">Cancel</button></td></tr>`
              : `<tr><td class="p-2"></td><td class="p-2" colspan="${group.columns.length + 1}"><button onclick="actions.setShowNewTask('${group.id}')" class="flex items-center gap-1 text-gray-400 hover:text-blue-500 text-sm"><i data-lucide="plus" class="w-4 h-4"></i> Add Task</button></td></tr>`}
                          </tbody>
                        </table>
                      </div>
                    ` : ''}
                 </div>
               `;
      }).join('')}
            <button onclick="actions.addGroup()" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-500 hover:text-blue-500 flex items-center justify-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i> Add New Group</button>
         </div>
      </div>`;
    }

    function renderColumnsPanel(group) {
      return `<div class="absolute right-0 top-6 w-48 bg-white dark:bg-gray-800 shadow-xl rounded-lg border dark:border-gray-700 z-10 p-2"><div class="text-xs font-bold text-gray-500 mb-2">ADD COLUMNS</div><button onclick="actions.addColumn('${group.id}')" class="w-full text-left px-2 py-1 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-blue-500">+ Custom Text</button></div>`;
    }

    function renderKanbanView() {
      const projectGroups = state.groups.filter(g => g.projectId === state.selectedProject);
      const activeProject = state.projects.find(p => p.id === state.selectedProject);
      if (!activeProject) return `<div class="p-10 text-gray-400">Select a project</div>`;

      return `
      <div class="h-full flex flex-col bg-gray-50 dark:bg-gray-900">
        <div class="px-6 py-4 border-b dark:border-gray-700 flex items-center justify-between bg-white dark:bg-gray-900">
          <h1 class="text-xl font-bold text-gray-800 dark:text-white">${activeProject.name}<span class="text-sm font-normal text-gray-500">Kanban</span></h1>
          <div class="flex gap-2 bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
            <button onclick="actions.setView('list')" class="px-3 py-1 rounded text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-600 text-xs font-medium">List</button>
            <button class="px-3 py-1 rounded shadow bg-white dark:bg-gray-700 text-xs font-medium">Kanban</button>
          </div>
        </div>
        <div class="flex-1 overflow-x-auto overflow-y-hidden p-6">
          <div class="flex h-full gap-6">
            ${projectGroups.map(group => {
        const tasks = state.tasks.filter(t => t.groupId === group.id);
        return `
                <div class="w-80 flex flex-col h-full bg-gray-100 dark:bg-gray-800/50 rounded-xl border dark:border-gray-700">
                  <div class="p-3 font-semibold text-gray-700 dark:text-gray-200 flex justify-between items-center">
                    <span>${group.name}</span>
                    <div class="flex items-center gap-2">
                      <span class="bg-gray-200 dark:bg-gray-700 text-xs px-2 py-0.5 rounded-full">${tasks.length}</span>
                      <button onclick="actions.deleteGroup('${group.id}')" class="p-1 rounded hover:bg-red-100 dark:hover:bg-red-900/30"><i data-lucide="trash" class="w-4 h-4 text-red-500"></i></button>
                    </div>
                  </div>
                  <div id="kanban-group-${group.id}" class="kanban-column flex-1 overflow-y-auto p-2 space-y-2 min-h-[50px]" data-group-id="${group.id}">
                    ${tasks.map(t => `
                      <div class="bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm border dark:border-gray-700 hover:shadow-md cursor-move group" data-task-id="${t.id}">
                        <div class="flex justify-between items-start mb-2">
                          <span class="text-xs px-1.5 py-0.5 rounded ${priorityClass(t.priority)}">${t.priority}</span>
                          <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-400"></i>
                        </div>
                        <div class="text-sm font-medium text-gray-800 dark:text-gray-200 mb-2">${t.name}</div>
                        <div class="flex items-center justify-between mt-2">
                          <div class="flex items-center gap-1 text-xs text-gray-500"><i data-lucide="user" class="w-3 h-3"></i> ${t.assignee ? t.assignee.name.substring(0, 6) + "..." : "-"}</div>
                          <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button class="p-1 hover:bg-red-100 rounded text-red-500" onclick="actions.deleteTask('${t.id}')"><i data-lucide="trash" class="w-3 h-3"></i></button></div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                  <div class="p-2"><button onclick="actions.setShowNewTask('${group.id}'); actions.setView('list')" class="w-full py-2 text-sm text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg flex items-center justify-center gap-1"><i data-lucide="plus" class="w-4 h-4"></i> Add Task</button></div>
                </div>
              `;
      }).join('')}
            <button onclick="actions.addGroup()" class="w-80 h-12 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center text-gray-500 hover:border-blue-500 hover:text-blue-500">+ Add Section</button>
          </div>
        </div>
      </div>`;
    }

    function renderLogin() {
      return `<div class="h-screen flex flex-col items-center justify-center bg-gray-100 text-gray-600 font-medium">
            <div class="text-center bg-white p-8 rounded-xl shadow-lg">
                <p class="mb-4 text-xl">ðŸ”’ Access Denied</p>
                <p class="text-sm text-gray-400">You do not have permission to view this board.</p>
                <p class="text-xs text-gray-400 mt-2">Board ID: ${boardid}</p>
                <p class="text-xs text-gray-400">User: ${currentUser ? currentUser.email : "Unknown"}</p>
            </div>
        </div>`;
    }

    function renderAuthWindow() {
      if (!state.currentUser) return "";
      const isTeam = mode === "team";
      const targetName = isTeam ? "Team Board" : "Personal Board";
      return `
      <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all scale-100">
          <div class="bg-blue-600 p-6 text-center">
            <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-md"><i data-lucide="shield-check" class="w-8 h-8 text-white"></i></div>
            <h2 class="text-2xl font-bold text-white">Security Check</h2>
            <p class="text-blue-100 text-sm mt-1">Verifying your identity</p>
          </div>
          <div class="p-8">
            <div class="space-y-4">
              <div class="flex items-center gap-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-100 dark:border-gray-700">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-lg">${state.currentUser.name.charAt(0).toUpperCase()}</div>
                <div class="flex-1 min-w-0"><p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">${state.currentUser.name}</p><p class="text-xs text-gray-500 dark:text-gray-400 truncate">${state.currentUser.email}</p></div>
                <div class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 text-xs rounded-full font-medium">Verified</div>
              </div>
              <div class="text-center py-2"><p class="text-gray-500 dark:text-gray-400 text-sm">You are accessing:</p><p class="text-lg font-semibold text-gray-800 dark:text-white mt-1 flex items-center justify-center gap-2"><i data-lucide="${isTeam ? 'users' : 'user'}" class="w-5 h-5 text-blue-500"></i>${targetName}</p></div>
              <button onclick="confirmAuth()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition-all transform hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2"><span>Continue to Dashboard</span><i data-lucide="arrow-right" class="w-4 h-4"></i></button>
            </div>
          </div>
        </div>
      </div>`;
    }

    function confirmAuth() {
      state.isAuthenticated = true;
      state.showAuthWindow = false;
      renderApp();
      api.load();
    }
    window.confirmAuth = confirmAuth;

    function renderApp() {
      const app = document.getElementById("app");
      if (state.darkMode) document.documentElement.classList.add("dark");
      else document.documentElement.classList.remove("dark");

      if (state.showLogin) {
        app.innerHTML = renderLogin();
        lucide.createIcons();
        return;
      }
      if (state.showAuthWindow) {
        app.innerHTML = renderAuthWindow();
        lucide.createIcons();
        return;
      }
      if (state.isLoading) {
        app.innerHTML = '<div class="h-screen flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>';
        return;
      }

      app.innerHTML = `
        <div class="flex h-screen overflow-hidden">
            ${renderSidebar()}
            <div class="flex-1 overflow-hidden">
            ${state.currentView === "kanban" ? renderKanbanView() : renderListView()}
            </div>
        </div>`;
      renderStatusIndicator();
      lucide.createIcons();
      if (state.currentView === "kanban") initKanbanDragDrop();
    }

    function initKanbanDragDrop() {
      const columns = document.querySelectorAll('.kanban-column');
      columns.forEach(col => {
        new Sortable(col, {
          group: 'shared',
          animation: 150,
          ghostClass: 'bg-blue-100',
          onEnd: function(evt) {
            const itemEl = evt.item;
            const newGroupEl = evt.to;
            const oldGroupEl = evt.from;
            if (evt.newIndex !== evt.oldIndex || newGroupEl !== oldGroupEl) {
              const taskId = itemEl.getAttribute('data-task-id');
              const newGroupId = newGroupEl.getAttribute('data-group-id');
              const task = state.tasks.find(t => t.id === taskId);
              if (task) {
                task.groupId = newGroupId;
                api.triggerSave();
              }
            }
          }
        });
      });
    }

    console.log("ðŸŸ¢ Boot: boardid =", boardid, "currentUser =", currentUser);
    renderApp();
  </script>
</body>

</html>
