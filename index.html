<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WellTask Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { gray: { 750: '#2d3748' } } } }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 transition-colors duration-200">

    <div id="app"></div>

    <script>
        // ========================================================================
        // ⚠️ PASTE YOUR ZOHO WEBHOOK URL HERE ⚠️
        // ========================================================================
        const ZOHO_API_URL = "https://cliq.zoho.com/api/v2/functions/apischema/invoke?zapikey=1001.3d8aae64bab5fe65c5682907e19fcb45.41d161bac1cea527694b74dbdc843360       "; 


        // --- 1. SECURITY & AUTH (Base64 Decoder) ---
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        let currentUser = null;

        if (token) {
            try {
                const decoded = atob(token); 
                const parts = decoded.split("::"); 
                if (parts.length === 2) {
                    currentUser = { 
                        id: parts[1], 
                        name: parts[0].split('@')[0], 
                        email: parts[0], 
                        role: 'owner' 
                    };
                }
            } catch (e) { console.error("Auth Failed", e); }
        }

        // --- 2. APP STATE ---
        const initialState = {
            darkMode: false,
            currentView: 'kanban', // 'kanban' or 'list'
            currentUser: currentUser,
            showLogin: !currentUser,
            
            workspaces: [{ id: 1, name: 'My Workspace', collapsed: false }],
            selectedWorkspace: 1,
            projects: [{ id: 1, name: 'General Tasks', color: 'bg-blue-500', workspaceId: 1, collapsed: false }],
            selectedProject: 1,
            
            groups: [
                { id: 1, name: 'Not Started', projectId: 1, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] },
                { id: 2, name: 'In Progress', projectId: 1, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] },
                { id: 3, name: 'Done', projectId: 1, collapsed: false, columns: ['Task', 'Assignee', 'Priority', 'Status', 'Due Date'] }
            ],
            
            tasks: [], // Loaded from API

            ui: {
                showNewTask: null,
                newTask: { name: '', assignee: null, priority: 'Medium', status: 'Not Started', dueDate: '', customFields: {} }
            }
        };

        let state = { ...initialState };

        // --- 3. API BRIDGE (The Sync Engine) ---
        const api = {
            // READ
            fetchTasks: async () => {
                if (!state.currentUser || ZOHO_API_URL.includes("PASTE_YOUR")) return;
                
                try {
                    const res = await fetch(`${ZOHO_API_URL}&request_method=GET&user_email=${state.currentUser.email}`);
                    const json = await res.json();
                    
                    if(json.status === 'success' && json.data) {
                        state.tasks = json.data.map(t => {
                            // Unpack Large Text
                            let extras = { duedate: "", custom: {} };
                            try {
                                if(t.attributes) extras = JSON.parse(t.attributes);
                            } catch(e) {}

                            return {
                                id: t.id,
                                name: t.taskname,
                                status: t.status,
                                priority: t.priority,
                                assignee: t.assignee === 'Unassigned' ? null : { name: t.assignee },
                                dueDate: extras.duedate || "",
                                customFields: extras.custom || {},
                                projectId: 1,
                                groupId: getGroupId(t.status)
                            };
                        });
                        renderApp();
                    }
                } catch (e) { console.error("Sync Error", e); }
            },

            // CREATE
            createTask: async (groupId) => {
                const taskData = state.ui.newTask;
                if(!taskData.name.trim()) return;

                // Optimistic Update
                const tempId = Date.now();
                state.tasks.push({ id: tempId, groupId, projectId: 1, ...taskData });
                state.ui.showNewTask = null;
                renderApp();

                // Pack Data
                const packed = JSON.stringify({ 
                    duedate: taskData.dueDate, 
                    custom: taskData.customFields 
                });

                try {
                    await fetch(`${ZOHO_API_URL}&request_method=POST&action=create` +
                        `&name=${encodeURIComponent(taskData.name)}` +
                        `&user_email=${state.currentUser.email}` +
                        `&attributes=${encodeURIComponent(packed)}`);
                    api.fetchTasks(); 
                } catch (e) { console.error("Create Error", e); }
            },

            // DELETE
            deleteTask: async (id) => {
                state.tasks = state.tasks.filter(t => t.id !== id);
                renderApp();
                await fetch(`${ZOHO_API_URL}&request_method=POST&action=delete&id=${id}`);
            }
        };

        function getGroupId(status) {
            if(status === 'In Progress') return 2;
            if(status === 'Done') return 3;
            return 1;
        }

        // --- 4. UI ACTIONS ---
        const actions = {
            render: () => renderApp(),
            toggleTheme: () => { state.darkMode = !state.darkMode; renderApp(); },
            setView: (view) => { state.currentView = view; renderApp(); },
            setShowNewTask: (id) => { state.ui.showNewTask = id; state.ui.newTask = { name: '', priority: 'Medium', status: 'Not Started', dueDate: '', customFields: {} }; renderApp(); },
            submitTask: (groupId) => {
                const input = document.getElementById(`new-task-name-${groupId}`);
                if(input) state.ui.newTask.name = input.value;
                api.createTask(groupId);
            },
            deleteTask: (id) => api.deleteTask(id)
        };
        window.actions = actions;


        // --- 5. RENDERERS ---

        function renderSidebar() {
            const { darkMode } = state;
            const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
            const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
            const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';
            const hoverBg = darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100';

            return `
                <div class="w-64 ${cardBg} border-r ${borderColor} flex flex-col h-full">
                    <div class="p-6 border-b ${borderColor}"><h1 class="text-2xl font-bold ${textColor}">WellTask</h1></div>
                    <nav class="flex-1 p-4">
                        <div class="mb-6">
                             <div class="flex items-center justify-between px-3 py-2 rounded-lg bg-blue-600 text-white mb-1">
                                <span class="text-sm">My Workspace</span>
                            </div>
                             <div class="flex items-center justify-between px-3 py-2 rounded-lg ${hoverBg} ${textColor} cursor-pointer">
                                <span class="text-sm font-bold"># General Tasks</span>
                            </div>
                        </div>
                    </nav>
                    <div class="p-4 border-t ${borderColor}">
                        <button onclick="actions.toggleTheme()" class="w-full flex items-center justify-between px-4 py-3 rounded-lg ${hoverBg} ${textColor}">
                            <span>Theme</span>
                            <i data-lucide="${darkMode ? 'sun' : 'moon'}" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderKanbanView() {
            const { tasks, groups, darkMode, ui } = state;
            const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
            const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
            const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';

            const header = `
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-3xl font-bold ${textColor}">Kanban Board</h1>
                    <button onclick="actions.setView('list')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex gap-2"><i data-lucide="layout-list" class="w-5 h-5"></i> List View</button>
                </div>
            `;

            const columns = groups.map(grp => {
                const grpTasks = tasks.filter(t => t.groupId === grp.id);
                return `
                    <div class="${cardBg} border ${borderColor} rounded-lg p-4 flex flex-col h-full max-h-[80vh]">
                        <div class="flex justify-between mb-4 font-bold ${textColor}">
                            ${grp.name}
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">${grpTasks.length}</span>
                        </div>
                        <div class="flex-1 overflow-y-auto space-y-3 pr-2">
                            ${grpTasks.map(t => `
                                <div class="${darkMode ? 'bg-gray-700' : 'bg-white'} p-3 rounded border ${borderColor} shadow-sm hover:shadow-md transition">
                                    <div class="font-medium mb-2 ${textColor}">${t.name}</div>
                                    <div class="flex justify-between items-center text-xs text-gray-500">
                                        <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded">${t.priority}</span>
                                        <button onclick="actions.deleteTask('${t.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-3 pt-3 border-t ${borderColor}">
                            ${ui.showNewTask === grp.id ? `
                                <div class="space-y-2">
                                    <input id="new-task-name-${grp.id}" type="text" placeholder="Task name..." class="w-full p-2 text-sm border rounded dark:bg-gray-600 dark:text-white" autofocus onkeypress="if(event.key==='Enter') actions.submitTask(${grp.id})">
                                    <button onclick="actions.submitTask(${grp.id})" class="w-full bg-green-600 text-white px-3 py-1 rounded text-sm">Add</button>
                                </div>
                            ` : `
                                <button onclick="actions.setShowNewTask(${grp.id})" class="w-full py-2 text-sm text-blue-500 border border-dashed border-blue-300 rounded hover:bg-blue-50 dark:hover:bg-gray-900">+ Add Task</button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="p-6 h-full overflow-auto">${header}<div class="grid grid-cols-3 gap-4 min-w-[800px]">${columns}</div></div>`;
        }

        function renderListView() {
            const { tasks, groups, darkMode } = state;
            const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
            const textColor = darkMode ? 'text-gray-100' : 'text-gray-800';
            const borderColor = darkMode ? 'border-gray-700' : 'border-gray-200';

            const header = `
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-3xl font-bold ${textColor}">List View</h1>
                    <button onclick="actions.setView('kanban')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex gap-2"><i data-lucide="grid-3x3" class="w-5 h-5"></i> Kanban View</button>
                </div>
            `;

            const list = groups.map(grp => {
                const grpTasks = tasks.filter(t => t.groupId === grp.id);
                return `
                    <div class="mb-6">
                        <div class="${cardBg} border ${borderColor} rounded-t-lg p-3 font-bold ${textColor}">${grp.name} (${grpTasks.length})</div>
                        <div class="${cardBg} border-x border-b ${borderColor} rounded-b-lg">
                            ${grpTasks.map(t => `
                                <div class="p-3 border-b ${borderColor} flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <span class="${textColor}">${t.name}</span>
                                    <div class="flex gap-4 items-center">
                                        <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded">${t.priority}</span>
                                        <button onclick="actions.deleteTask('${t.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="p-6 h-full overflow-auto">${header}${list}</div>`;
        }

        function renderLogin() {
             return `<div class="h-screen flex items-center justify-center bg-gray-100 text-xl text-gray-600">Please access this dashboard via the Zoho Cliq Widget.</div>`;
        }

        function renderApp() {
            const app = document.getElementById('app');
            if(state.showLogin) app.innerHTML = renderLogin();
            else {
                const { darkMode } = state;
                const bgColor = darkMode ? 'bg-gray-900' : 'bg-gray-50';
                app.innerHTML = `
                    <div class="flex h-screen ${bgColor}">
                        ${renderSidebar()}
                        <div class="flex-1 overflow-hidden">
                            ${state.currentView === 'kanban' ? renderKanbanView() : renderListView()}
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // AUTO SYNC (Every 3s)
        setInterval(() => { if(state.currentUser) api.fetchTasks(); }, 3000);

        // START
        if(state.currentUser) api.fetchTasks();
        renderApp();

    </script>
</body>
</html>