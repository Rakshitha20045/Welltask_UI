<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WellTask Preview</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCaVEmWvh0_hcxFJQG00QAXNxRsIMpgy94",
      authDomain: "welltask-8bbcf.firebaseapp.com",
      projectId: "welltask-8bbcf",
      storageBucket: "welltask-8bbcf.firebasestorage.app",
      messagingSenderId: "533119656804",
      appId: "1:533119656804:web:ec296e70c7b7e5746c1071"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

</head>
<body class="bg-gray-50 text-gray-800 p-4">

  <div id="main" class="max-w-lg mx-auto bg-white shadow-md rounded-xl p-5 border">
    <h1 class="text-xl font-bold mb-3">ðŸ—‚ WellTask Preview</h1>

    <div id="content" class="text-sm text-gray-700">
      Loading...
    </div>

    <div class="mt-4">
      <button id="openBtn"
              class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-blue-700">
        Open Full Dashboard
      </button>
    </div>
  </div>

  <script>

    async function load() {

      const params = new URLSearchParams(window.location.search);

      const boardid = params.get("boardid");
      const mode = params.get("mode");
      const token = params.get("token");

      const fullDashUrl =
        "https://welltask-ui-88uy.vercel.app/index.html?token=" + token +
        "&mode=" + mode +
        "&boardid=" + boardid +
        "&channelId=" + boardid;

      document.getElementById("openBtn").onclick = () => {
        window.open(fullDashUrl, "_blank");
      };

      let doc = null;

      // 1. Try direct fetch
      let ref = db.collection("boards").doc(boardid);
      let snap = await ref.get();

      if (snap.exists) {
        doc = snap.data();
      }

      // 2. Team mode â†’ query by channel_id
      if (!doc && mode === "team") {
        let q = await db.collection("boards").where("channel_id", "==", boardid).get();
        if (!q.empty) doc = q.docs[0].data();
      }

      const out = document.getElementById("content");

      if (!doc) {
        out.innerHTML =
          `<p class='text-gray-500'>No data found for this board.</p>`;
        return;
      }

      let html = "";

      // --- Workspaces ---
      html += `<h2 class='font-semibold text-lg mt-2 mb-1'>ðŸ“Œ Workspaces</h2>`;
      if (doc.workspaces?.length) {
        doc.workspaces.forEach(w => {
          html += `<div class="ml-2">â€¢ ${w.name}</div>`;
        });
      } else {
        html += `<div class="ml-2 text-gray-500">No workspaces</div>`;
      }

      // --- Projects ---
      html += `<h2 class='font-semibold text-lg mt-3 mb-1'>ðŸ“‚ Projects</h2>`;
      if (doc.projects?.length) {
        doc.projects.forEach(p => {
          html += `<div class="ml-2">â€¢ ${p.name}</div>`;
        });
      } else {
        html += `<div class="ml-2 text-gray-500">No projects</div>`;
      }

      // --- Groups with Tasks ---
      html += `<h2 class='font-semibold text-lg mt-3 mb-1'>ðŸ“‘ Groups & Tasks</h2>`;

      if (doc.groups?.length) {
        doc.groups.forEach(g => {
          html += `<div class="mt-2 font-semibold">â€¢ ${g.name}</div>`;

          let groupTasks = (doc.tasks || []).filter(t => t.groupId === g.id);

          if (groupTasks.length === 0) {
            html += `<div class="ml-4 text-gray-400 text-sm">No tasks</div>`;
          } else {
            groupTasks.forEach(t => {
              html += `<div class="ml-4">- ${t.name}</div>`;
            });
          }
        });
      } else {
        html += `<div class='ml-2 text-gray-400'>No groups</div>`;
      }

      out.innerHTML = html;
    }

    load();

  </script>

</body>
</html>
